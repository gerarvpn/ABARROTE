
#!/bin/bash

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

print_message() {
    echo -e "${BLUE}[GESTIÃ“N DE EMPLEADOS v2.0.0]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[Ã‰XITO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[ADVERTENCIA]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_info() {
    echo -e "${CYAN}[INFO]${NC} $1"
}

# Verificar root
if [ "$EUID" -ne 0 ]; then
    print_error "Ejecute como root: sudo ./instalacion_panel_v2.0.0.sh"
    exit 1
fi

# Detectar OS
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$NAME
else
    print_error "No se pudo detectar el SO"
    exit 1
fi

print_message "Iniciando instalaciÃ³n - Sistema: $OS"

# ConfiguraciÃ³n
read -p "Â¿Configurar dominio? (s/n): " setup_domain
if [[ $setup_domain == "s" || $setup_domain == "S" ]]; then
    read -p "Dominio (ej: midominio.com): " DOMAIN
else
    DOMAIN="localhost"
fi

read -p "Â¿Configurar Telegram ahora? (s/n): " setup_telegram
if [[ $setup_telegram == "s" || $setup_telegram == "S" ]]; then
    read -p "Token del bot de Telegram: " TELEGRAM_TOKEN
    read -p "Chat ID del administrador para notificaciones: " TELEGRAM_CHAT_ID
else
    TELEGRAM_TOKEN=""
    TELEGRAM_CHAT_ID=""
fi

read -p "Usuario administrador pro: " ADMIN_USER
read -s -p "ContraseÃ±a administrador pro: " ADMIN_PASS
echo

# Actualizar sistema
print_message "Actualizando sistema..."
apt update && apt upgrade -y

# Instalar dependencias
print_message "Instalando dependencias..."
apt install -y apache2 php php-mysql php-curl php-gd php-mbstring php-xml php-zip mysql-server curl git unzip

# Instalar ImageMagick para procesamiento de imÃ¡genes mejorado
print_message "Instalando ImageMagick para procesamiento de imÃ¡genes..."
apt install -y imagemagick php-imagick

# Configurar MySQL
print_message "Configurando MySQL..."
mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '';"
mysql -e "FLUSH PRIVILEGES;"

# Crear base de datos
print_message "Creando base de datos..."
mysql -e "CREATE DATABASE IF NOT EXISTS gestion_empleados;"
mysql -e "CREATE USER IF NOT EXISTS 'gestion_user'@'localhost' IDENTIFIED BY 'empleados123';"
mysql -e "GRANT ALL PRIVILEGES ON gestion_empleados.* TO 'gestion_user'@'localhost';"
mysql -e "FLUSH PRIVILEGES;"

# Crear directorio del panel
PANEL_DIR="/var/www/gestion-empleados"
print_message "Creando directorio: $PANEL_DIR"
mkdir -p $PANEL_DIR
cd $PANEL_DIR

# Crear estructura de base de datos mejorada
print_message "Creando estructura de base de datos..."
mysql gestion_empleados << 'EOF'
-- Tabla de usuarios mejorada
CREATE TABLE IF NOT EXISTS usuarios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    nombre VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    telefono VARCHAR(20),
    rol ENUM('admin_pro', 'admin', 'empleado') NOT NULL DEFAULT 'empleado',
    telegram_id VARCHAR(50),
    turno ENUM('AM', 'PM') DEFAULT 'AM',
    pasillo_asignado VARCHAR(50),
    dia_libre VARCHAR(20),
    activo BOOLEAN DEFAULT TRUE,
    creado_por INT,
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (creado_por) REFERENCES usuarios(id)
);

-- Tabla de tareas mejorada - CON PRIVACIDAD ENTRE ADMINISTRADORES
CREATE TABLE IF NOT EXISTS tareas (
    id INT AUTO_INCREMENT PRIMARY KEY,
    titulo VARCHAR(255) NOT NULL,
    descripcion TEXT,
    empleado_id INT NOT NULL,
    administrador_id INT NOT NULL,
    pasillo_area VARCHAR(100),
    tipo_tarea ENUM('pasillo', 'area') DEFAULT 'area',
    requiere_foto BOOLEAN DEFAULT FALSE,
    foto_tarea TEXT,
    fecha_asignacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    fecha_vencimiento DATETIME,
    fecha_completado DATETIME,
    estado ENUM('pendiente', 'completada', 'vencida', 'verificada') DEFAULT 'pendiente',
    calificacion INT,
    comentario_revision TEXT,
    tipo ENUM('manual', 'automatica') DEFAULT 'manual',
    notificar_telegram BOOLEAN DEFAULT TRUE,
    zona_horaria VARCHAR(50) DEFAULT 'America/Santo_Domingo',
    FOREIGN KEY (empleado_id) REFERENCES usuarios(id),
    FOREIGN KEY (administrador_id) REFERENCES usuarios(id),
    INDEX idx_empleado_estado (empleado_id, estado),
    INDEX idx_fecha_vencimiento (fecha_vencimiento),
    INDEX idx_administrador (administrador_id)
);

-- Tabla de configuraciones
CREATE TABLE IF NOT EXISTS configuraciones (
    id INT AUTO_INCREMENT PRIMARY KEY,
    clave VARCHAR(100) UNIQUE NOT NULL,
    valor TEXT,
    descripcion TEXT,
    fecha_actualizacion DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Tabla de backups
CREATE TABLE IF NOT EXISTS backups (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre_archivo VARCHAR(255),
    tamano BIGINT,
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    creado_por INT,
    ubicacion VARCHAR(500),
    FOREIGN KEY (creado_por) REFERENCES usuarios(id)
);

-- Tabla de logs del sistema
CREATE TABLE IF NOT EXISTS logs_sistema (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT,
    accion VARCHAR(255),
    detalles TEXT,
    ip_address VARCHAR(45),
    user_agent TEXT,
    fecha_registro DATETIME DEFAULT CURRENT_TIMESTAMP,
    zona_horaria VARCHAR(50) DEFAULT 'America/Santo_Domingo',
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- Tabla de alertas montacarga
CREATE TABLE IF NOT EXISTS alertas_montacarga (
    id INT AUTO_INCREMENT PRIMARY KEY,
    empleado_id INT NOT NULL,
    posicion ENUM('arriba', 'abajo') NOT NULL,
    turno ENUM('AM', 'PM') NOT NULL,
    fecha_asignacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    hora_tarea TIME NOT NULL,
    activa BOOLEAN DEFAULT TRUE,
    completada BOOLEAN DEFAULT FALSE,
    fecha_completado DATETIME,
    zona_horaria VARCHAR(50) DEFAULT 'America/Santo_Domingo',
    FOREIGN KEY (empleado_id) REFERENCES usuarios(id)
);

-- Tabla para mÃºltiples empleados por tarea
CREATE TABLE IF NOT EXISTS tarea_empleados (
    id INT AUTO_INCREMENT PRIMARY KEY,
    tarea_id INT NOT NULL,
    empleado_id INT NOT NULL,
    fecha_asignacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (tarea_id) REFERENCES tareas(id) ON DELETE CASCADE,
    FOREIGN KEY (empleado_id) REFERENCES usuarios(id),
    UNIQUE KEY unique_tarea_empleado (tarea_id, empleado_id)
);

-- Tabla para mÃºltiples fotos por tarea
CREATE TABLE IF NOT EXISTS tarea_fotos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    tarea_id INT NOT NULL,
    ruta_foto VARCHAR(500) NOT NULL,
    nombre_archivo VARCHAR(255) NOT NULL,
    fecha_subida DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (tarea_id) REFERENCES tareas(id) ON DELETE CASCADE
);

-- Tabla de comandos de Telegram
CREATE TABLE IF NOT EXISTS telegram_comandos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    comando VARCHAR(100) NOT NULL,
    respuesta TEXT NOT NULL,
    activo BOOLEAN DEFAULT TRUE,
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Insertar usuario admin pro por defecto
INSERT IGNORE INTO usuarios (username, password, nombre, rol, activo) 
VALUES ('admin', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Administrador Principal', 'admin_pro', TRUE);

-- Configuraciones por defecto
INSERT IGNORE INTO configuraciones (clave, valor, descripcion) VALUES 
('telegram_token', '', 'Token del bot de Telegram para notificaciones'),
('telegram_chat_id', '', 'Chat ID del administrador para notificaciones'),
('hora_montacarga_am', '08:00', 'Hora para tarea montacarga AM'),
('hora_montacarga_pm', '14:00', 'Hora para tarea montacarga PM'),
('dominio', '', 'Dominio del sistema'),
('version', '2.0.0', 'VersiÃ³n del sistema'),
('backup_automatico', '1', 'Hacer backup automÃ¡tico diario'),
('hora_backup', '02:00', 'Hora para backup automÃ¡tico'),
('tareas_automaticas', '1', 'Activar tareas automÃ¡ticas'),
('nombre_sistema', 'Sistema de GestiÃ³n de Empleados', 'Nombre del sistema'),
('zona_horaria', 'America/Santo_Domingo', 'Zona horaria del sistema'),
('privacidad_tareas', '1', 'Los administradores solo ven sus propias tareas'),
('calidad_fotos', '85', 'Calidad de compresiÃ³n de fotos (1-100)'),
('max_fotos_tarea', '3', 'MÃ¡ximo nÃºmero de fotos por tarea'),
('limpiar_tareas_24h', '1', 'Limpiar tareas antiguas cada 24h'),
('tiempo_reabrir_tarea', '30', 'Minutos para poder reabrir tarea vencida');

-- Insertar comando /start por defecto
INSERT IGNORE INTO telegram_comandos (comando, respuesta, activo) VALUES 
('/start', 'ğŸ‘‹ <b>Â¡Hola {nombre}!</b>\n\nğŸ¤– <b>Bot del Sistema de GestiÃ³n de Empleados</b>\n\nğŸ“‹ <b>Tu ID de Telegram es:</b> <code>{chat_id}</code>\n\nğŸ“ <b>Para recibir notificaciones:</b>\n1. Copia tu ID de arriba\n2. Ve al panel web del sistema\n3. En ''Mi Perfil'', pega tu ID en ''ID de Telegram''\n4. Guarda los cambios\n\nğŸ”” <b>RecibirÃ¡s notificaciones de:</b>\nâ€¢ Nuevas tareas asignadas\nâ€¢ Recordatorios de tareas\nâ€¢ Alertas del sistema\n\nâ“ <b>Â¿Necesitas ayuda?</b> Contacta al administrador del sistema.', TRUE);
EOF

# Crear archivo de configuraciÃ³n mejorado
cat > config.php << 'EOF'
<?php
// ConfiguraciÃ³n de GestiÃ³n de Empleados v2.0.0
// CORRECCIÃ“N DEFINITIVA: ConfiguraciÃ³n de zona horaria y prevenciÃ³n de recargas
date_default_timezone_set('America/Santo_Domingo');

// ConfiguraciÃ³n de la base de datos
define('DB_HOST', 'localhost');
define('DB_NAME', 'gestion_empleados');
define('DB_USER', 'gestion_user');
define('DB_PASS', 'empleados123');

// ConfiguraciÃ³n del sistema
define('SITE_URL', (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? "https" : "http") . "://$_SERVER[HTTP_HOST]");
define('VERSION', '2.0.0');
define('MAX_FILE_SIZE', 10 * 1024 * 1024); // 10MB reducido para optimizar
define('MAX_FOTOS_TAREA', 3); // MÃ¡ximo de fotos por tarea

// Obtener configuraciones de la base de datos
try {
    $pdo = new PDO("mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=utf8mb4", DB_USER, DB_PASS);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    $pdo->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
    
    // Cargar configuraciones
    $stmt = $pdo->query("SELECT clave, valor FROM configuraciones");
    $configs = $stmt->fetchAll(PDO::FETCH_KEY_PAIR);
    
    $telegram_config = [
        'token' => $configs['telegram_token'] ?? '',
        'chat_id' => $configs['telegram_chat_id'] ?? ''
    ];
    
    $horarios_montacarga = [
        'am' => $configs['hora_montacarga_am'] ?? '08:00',
        'pm' => $configs['hora_montacarga_pm'] ?? '14:00'
    ];
    
    $nombre_sistema = $configs['nombre_sistema'] ?? 'Sistema de GestiÃ³n de Empleados';
    $privacidad_tareas = ($configs['privacidad_tareas'] ?? '1') == '1';
    $calidad_fotos = intval($configs['calidad_fotos'] ?? 85);
    $max_fotos_tarea = intval($configs['max_fotos_tarea'] ?? 3);
    $limpiar_tareas_24h = ($configs['limpiar_tareas_24h'] ?? '1') == '1';
    $tiempo_reabrir_tarea = intval($configs['tiempo_reabrir_tarea'] ?? 30);
    
} catch(PDOException $e) {
    die("Error de conexiÃ³n: " . $e->getMessage());
}

// FUNCIÃ“N CORREGIDA: Obtener fecha/hora actual en zona horaria correcta
function obtenerFechaHoraActual() {
    return new DateTime('now', new DateTimeZone('America/Santo_Domingo'));
}

// FUNCIÃ“N CORREGIDA: Convertir fecha a zona horaria correcta
function convertirFechaZonaHoraria($fecha, $formato = 'Y-m-d H:i:s') {
    if (empty($fecha)) return null;
    
    try {
        $date = new DateTime($fecha, new DateTimeZone('UTC'));
        $date->setTimezone(new DateTimeZone('America/Santo_Domingo'));
        return $date->format($formato);
    } catch (Exception $e) {
        error_log("Error convirtiendo fecha: " . $e->getMessage());
        return $fecha;
    }
}

// FUNCIÃ“N CORREGIDA: Para guardar en BD en UTC
function convertirFechaUTC($fecha) {
    if (empty($fecha)) return null;
    
    try {
        $date = new DateTime($fecha, new DateTimeZone('America/Santo_Domingo'));
        $date->setTimezone(new DateTimeZone('UTC'));
        return $date->format('Y-m-d H:i:s');
    } catch (Exception $e) {
        error_log("Error convirtiendo fecha a UTC: " . $e->getMessage());
        return $fecha;
    }
}

// FunciÃ³n para registrar logs MEJORADA
function registrar_log($usuario_id, $accion, $detalles = '') {
    global $pdo;
    
    try {
        $fecha_actual = obtenerFechaHoraActual();
        
        $stmt = $pdo->prepare("INSERT INTO logs_sistema (usuario_id, accion, detalles, ip_address, user_agent, fecha_registro) VALUES (?, ?, ?, ?, ?, ?)");
        $stmt->execute([
            $usuario_id,
            $accion,
            $detalles,
            $_SERVER['REMOTE_ADDR'] ?? '127.0.0.1',
            $_SERVER['HTTP_USER_AGENT'] ?? '',
            $fecha_actual->format('Y-m-d H:i:s')
        ]);
        return true;
    } catch(Exception $e) {
        error_log("Error registrando log: " . $e->getMessage());
        return false;
    }
}

// FUNCIÃ“N COMPLETAMENTE CORREGIDA: Para enviar notificaciones a Telegram
function enviar_telegram($chat_id, $mensaje, $parse_mode = 'HTML') {
    global $telegram_config;
    
    if (empty($telegram_config['token'])) {
        error_log("Token de Telegram no configurado");
        return false;
    }
    
    if (empty($chat_id)) {
        error_log("Chat ID no proporcionado");
        return false;
    }
    
    // CORRECCIÃ“N: Validar formato del chat_id
    if (!is_numeric($chat_id) && !preg_match('/^@/', $chat_id)) {
        error_log("Chat ID con formato invÃ¡lido: " . $chat_id);
        return false;
    }
    
    try {
        $url = "https://api.telegram.org/bot" . $telegram_config['token'] . "/sendMessage";
        $data = [
            'chat_id' => $chat_id,
            'text' => $mensaje,
            'parse_mode' => $parse_mode
        ];
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 10);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, true);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);
        
        $result = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        
        if (curl_error($ch)) {
            error_log("Error cURL Telegram: " . curl_error($ch));
            curl_close($ch);
            return false;
        }
        
        curl_close($ch);
        
        $response = json_decode($result, true);
        
        if ($http_code !== 200 || !$response['ok']) {
            error_log("Error HTTP Telegram: " . $http_code . " - " . $result);
            return false;
        }
        
        return $result;
    } catch(Exception $e) {
        error_log("Error enviando Telegram: " . $e->getMessage());
        return false;
    }
}

// FunciÃ³n para enviar foto por Telegram MEJORADA
function enviar_foto_telegram($chat_id, $foto_path, $mensaje = '') {
    global $telegram_config;
    
    if (empty($telegram_config['token']) || !file_exists($foto_path)) {
        return false;
    }
    
    // CORRECCIÃ“N: Validar formato del chat_id
    if (!is_numeric($chat_id) && !preg_match('/^@/', $chat_id)) {
        error_log("Chat ID con formato invÃ¡lido: " . $chat_id);
        return false;
    }
    
    try {
        $url = "https://api.telegram.org/bot" . $telegram_config['token'] . "/sendPhoto";
        
        $post_data = [
            'chat_id' => $chat_id,
            'caption' => $mensaje,
            'parse_mode' => 'HTML'
        ];
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, true);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);
        
        // Agregar la foto usando CURLFile
        $post_data['photo'] = new CURLFile(realpath($foto_path));
        
        curl_setopt($ch, CURLOPT_POSTFIELDS, $post_data);
        
        $result = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        
        if (curl_error($ch)) {
            error_log("Error cURL enviando foto Telegram: " . curl_error($ch));
            curl_close($ch);
            return false;
        }
        
        curl_close($ch);
        
        $response = json_decode($result, true);
        
        if ($http_code !== 200 || !$response['ok']) {
            error_log("Error HTTP enviando foto Telegram: " . $http_code . " - " . $result);
            return false;
        }
        
        return $result;
    } catch(Exception $e) {
        error_log("Error enviando foto por Telegram: " . $e->getMessage());
        return false;
    }
}

// FunciÃ³n para enviar mÃºltiples fotos por Telegram
function enviar_multiple_fotos_telegram($chat_id, $fotos_paths, $mensaje = '') {
    global $telegram_config;
    
    if (empty($telegram_config['token']) || empty($fotos_paths)) {
        return false;
    }
    
    $resultados = [];
    
    foreach ($fotos_paths as $index => $foto_path) {
        if (file_exists($foto_path)) {
            $mensaje_foto = $mensaje . (count($fotos_paths) > 1 ? " (Foto " . ($index + 1) . "/" . count($fotos_paths) . ")" : "");
            $resultado = enviar_foto_telegram($chat_id, $foto_path, $mensaje_foto);
            $resultados[] = $resultado;
            
            // PequeÃ±a pausa entre envÃ­os para evitar lÃ­mites de Telegram
            if ($index < count($fotos_paths) - 1) {
                sleep(1);
            }
        }
    }
    
    return $resultados;
}

// FunciÃ³n para enviar documento por Telegram (para backups)
function enviar_documento_telegram($chat_id, $documento_path, $mensaje = '') {
    global $telegram_config;
    
    if (empty($telegram_config['token']) || !file_exists($documento_path)) {
        return false;
    }
    
    if (!is_numeric($chat_id) && !preg_match('/^@/', $chat_id)) {
        error_log("Chat ID con formato invÃ¡lido: " . $chat_id);
        return false;
    }
    
    try {
        $url = "https://api.telegram.org/bot" . $telegram_config['token'] . "/sendDocument";
        
        $post_data = [
            'chat_id' => $chat_id,
            'caption' => $mensaje,
            'parse_mode' => 'HTML'
        ];
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 60); // MÃ¡s tiempo para archivos grandes
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, true);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);
        
        // Agregar el documento usando CURLFile
        $post_data['document'] = new CURLFile(realpath($documento_path));
        
        curl_setopt($ch, CURLOPT_POSTFIELDS, $post_data);
        
        $result = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        
        if (curl_error($ch)) {
            error_log("Error cURL enviando documento Telegram: " . curl_error($ch));
            curl_close($ch);
            return false;
        }
        
        curl_close($ch);
        
        $response = json_decode($result, true);
        
        if ($http_code !== 200 || !$response['ok']) {
            error_log("Error HTTP enviando documento Telegram: " . $http_code . " - " . $result);
            return false;
        }
        
        return $result;
    } catch(Exception $e) {
        error_log("Error enviando documento por Telegram: " . $e->getMessage());
        return false;
    }
}

// FunciÃ³n para verificar si un empleado estÃ¡ libre hoy
function empleado_esta_libre_hoy($empleado) {
    $dias_semana = ['Domingo', 'Lunes', 'Martes', 'MiÃ©rcoles', 'Jueves', 'Viernes', 'SÃ¡bado'];
    $fecha_actual = obtenerFechaHoraActual();
    $dia_actual = $dias_semana[$fecha_actual->format('w')];
    
    return $empleado['dia_libre'] === $dia_actual;
}

// FunciÃ³n para obtener recomendaciones de patanas CORREGIDA
function obtener_recomendaciones_patanas() {
    global $pdo;
    
    try {
        // Obtener todos los empleados activos
        $stmt_empleados = $pdo->query("SELECT * FROM usuarios WHERE activo = TRUE AND rol = 'empleado'");
        $todos_empleados = $stmt_empleados->fetchAll();
        
        // Identificar empleados libres hoy
        $empleados_libres = [];
        $empleados_trabajando = [];
        
        foreach ($todos_empleados as $empleado) {
            if (empleado_esta_libre_hoy($empleado)) {
                $empleados_libres[] = $empleado;
            } else {
                $empleados_trabajando[] = $empleado;
            }
        }
        
        // Obtener pasillos de empleados que estÃ¡n trabajando hoy
        $pasillos_ocupados = [];
        foreach ($empleados_trabajando as $emp) {
            if (!empty($emp['pasillo_asignado'])) {
                $pasillos_ocupados[] = $emp['pasillo_asignado'];
            }
        }
        
        // Obtener pasillos de empleados libres (estos son los que necesitan cobertura)
        $pasillos_sin_cobertura = [];
        foreach ($empleados_libres as $emp) {
            if (!empty($emp['pasillo_asignado']) && !in_array($emp['pasillo_asignado'], $pasillos_ocupados)) {
                $pasillos_sin_cobertura[] = $emp['pasillo_asignado'];
            }
        }
        
        // Filtrar empleados trabajando por turno actual
        $fecha_actual = obtenerFechaHoraActual();
        $turno_actual = $fecha_actual->format('H') < 12 ? 'AM' : 'PM';
        $empleados_disponibles = array_filter($empleados_trabajando, function($emp) use ($turno_actual) {
            return $emp['turno'] === $turno_actual;
        });
        
        // Verificar si ya hay tareas asignadas para cubrir estos pasillos hoy
        $fecha_hoy = $fecha_actual->format('Y-m-d');
        $pasillos_ya_cubiertos = [];
        
        if (!empty($pasillos_sin_cobertura)) {
            $placeholders = str_repeat('?,', count($pasillos_sin_cobertura) - 1) . '?';
            $stmt_tareas = $pdo->prepare("
                SELECT DISTINCT pasillo_area 
                FROM tareas 
                WHERE pasillo_area IN ($placeholders) 
                AND DATE(fecha_asignacion) = ? 
                AND estado IN ('pendiente', 'completada')
            ");
            $params = array_merge($pasillos_sin_cobertura, [$fecha_hoy]);
            $stmt_tareas->execute($params);
            $pasillos_ya_cubiertos = $stmt_tareas->fetchAll(PDO::FETCH_COLUMN);
        }
        
        // Filtrar pasillos que realmente necesitan cobertura (no estÃ¡n ya cubiertos)
        $pasillos_necesitan_cobertura = array_diff($pasillos_sin_cobertura, $pasillos_ya_cubiertos);
        
        $recomendaciones = [];
        
        if (count($pasillos_necesitan_cobertura) > 0 && count($empleados_disponibles) > 0) {
            $recomendaciones = [
                'empleados_libres' => $empleados_libres,
                'empleados_disponibles' => array_values($empleados_disponibles),
                'pasillos_sin_cobertura' => array_values($pasillos_necesitan_cobertura),
                'pasillos_ya_cubiertos' => $pasillos_ya_cubiertos,
                'turno_actual' => $turno_actual,
                'mensaje' => 'Se detectaron ' . count($pasillos_necesitan_cobertura) . ' pasillos sin cobertura en turno ' . $turno_actual
            ];
        }
        
        return $recomendaciones;
    } catch(Exception $e) {
        error_log("Error obteniendo recomendaciones: " . $e->getMessage());
        return [];
    }
}

// FunciÃ³n para obtener estadÃ­sticas de empleados por turno
function obtener_estadisticas_turno($turno) {
    global $pdo;
    
    try {
        $dias_semana = ['Domingo', 'Lunes', 'Martes', 'MiÃ©rcoles', 'Jueves', 'Viernes', 'SÃ¡bado'];
        $fecha_actual = obtenerFechaHoraActual();
        $dia_actual = $dias_semana[$fecha_actual->format('w')];
        
        $stmt = $pdo->prepare("
            SELECT COUNT(*) as total 
            FROM usuarios 
            WHERE activo = TRUE 
            AND rol = 'empleado' 
            AND turno = ?
            AND dia_libre != ?
        ");
        $stmt->execute([$turno, $dia_actual]);
        $result = $stmt->fetch();
        
        return $result['total'] ?? 0;
    } catch(Exception $e) {
        error_log("Error obteniendo estadÃ­sticas: " . $e->getMessage());
        return 0;
    }
}

// FunciÃ³n para generar backup mejorada
function generar_backup($usuario_id) {
    global $pdo, $telegram_config;
    
    $fecha_actual = obtenerFechaHoraActual();
    $fecha = $fecha_actual->format('Y-m-d_H-i-s');
    $nombre_archivo = "backup_gestion_$fecha.sql";
    $backup_dir = "/var/www/backups";
    $ruta_backup = "$backup_dir/$nombre_archivo";
    
    // Crear directorio de backups si no existe
    if (!is_dir($backup_dir)) {
        if (!mkdir($backup_dir, 0755, true)) {
            return ['success' => false, 'error' => 'No se pudo crear directorio de backups'];
        }
    }
    
    // Verificar permisos
    if (!is_writable($backup_dir)) {
        return ['success' => false, 'error' => 'Directorio de backups sin permisos de escritura'];
    }
    
    // Generar backup de la base de datos de forma segura
    $command = "mysqldump -h " . DB_HOST . " -u " . DB_USER . " -p'" . DB_PASS . "' " . DB_NAME . " 2>/dev/null";
    $output = [];
    $return_var = 0;
    exec($command, $output, $return_var);
    
    if ($return_var === 0) {
        $backup_content = implode("\n", $output);
        
        if (file_put_contents($ruta_backup, $backup_content) !== false) {
            $tamano = filesize($ruta_backup);
            
            // Registrar en la base de datos
            $stmt = $pdo->prepare("INSERT INTO backups (nombre_archivo, tamano, creado_por, ubicacion) VALUES (?, ?, ?, ?)");
            $stmt->execute([$nombre_archivo, $tamano, $usuario_id, $ruta_backup]);
            
            registrar_log($usuario_id, 'BACKUP_GENERADO', "Backup: $nombre_archivo, TamaÃ±o: " . round($tamano/1024/1024, 2) . "MB");
            
            return [
                'success' => true, 
                'archivo' => $ruta_backup, 
                'nombre' => $nombre_archivo, 
                'tamano' => $tamano,
                'download_url' => "descargar_backup.php?file=" . urlencode($nombre_archivo)
            ];
        } else {
            return ['success' => false, 'error' => 'Error al escribir archivo de backup'];
        }
    } else {
        return ['success' => false, 'error' => 'Error en mysqldump: CÃ³digo ' . $return_var];
    }
}

// FUNCIÃ“N MEJORADA: Para procesar foto subida desde cÃ¡mara
function procesar_foto_subida($archivo_temporal, $tarea_id, $usuario_id) {
    global $calidad_fotos;
    
    $upload_dir = '/var/www/uploads/tareas/';
    
    // Crear directorio si no existe
    if (!is_dir($upload_dir)) {
        mkdir($upload_dir, 0755, true);
    }
    
    // Validar tipo de archivo
    $tipo_permitido = ['image/jpeg', 'image/jpg', 'image/png'];
    $tipo_archivo = mime_content_type($archivo_temporal);
    
    if (!in_array($tipo_archivo, $tipo_permitido)) {
        return ['success' => false, 'error' => 'Tipo de archivo no permitido. Solo se permiten imÃ¡genes JPEG y PNG.'];
    }
    
    // Validar tamaÃ±o (mÃ¡ximo 10MB)
    if (filesize($archivo_temporal) > MAX_FILE_SIZE) {
        return ['success' => false, 'error' => 'El archivo es demasiado grande. TamaÃ±o mÃ¡ximo: 10MB.'];
    }
    
    // Generar nombre Ãºnico
    $fecha_actual = obtenerFechaHoraActual();
    $timestamp = $fecha_actual->format('Ymd_His');
    $extension = pathinfo($archivo_temporal, PATHINFO_EXTENSION) ?: 'jpg';
    $nombre_archivo = "tarea_{$tarea_id}_{$timestamp}.{$extension}";
    $ruta_completa = $upload_dir . $nombre_archivo;
    
    // Procesar la imagen con GD
    try {
        $tipo = mime_content_type($archivo_temporal);
        
        switch($tipo) {
            case 'image/jpeg':
            case 'image/jpg':
                $image = imagecreatefromjpeg($archivo_temporal);
                break;
            case 'image/png':
                $image = imagecreatefrompng($archivo_temporal);
                break;
            default:
                return ['success' => false, 'error' => 'Formato de imagen no soportado'];
        }
        
        if ($image !== false) {
            // Redimensionar si es muy grande (mÃ¡ximo 1200px de ancho)
            $ancho_original = imagesx($image);
            $alto_original = imagesy($image);
            
            if ($ancho_original > 1200) {
                $nuevo_ancho = 1200;
                $nuevo_alto = intval($alto_original * ($nuevo_ancho / $ancho_original));
                
                $image_optimizada = imagecreatetruecolor($nuevo_ancho, $nuevo_alto);
                imagecopyresampled($image_optimizada, $image, 0, 0, 0, 0, $nuevo_ancho, $nuevo_alto, $ancho_original, $alto_original);
                
                // Guardar con compresiÃ³n
                imagejpeg($image_optimizada, $ruta_completa, $calidad_fotos);
                imagedestroy($image_optimizada);
            } else {
                // Guardar con compresiÃ³n
                imagejpeg($image, $ruta_completa, $calidad_fotos);
            }
            
            imagedestroy($image);
            
            return ['success' => true, 'ruta' => $ruta_completa, 'nombre' => $nombre_archivo];
        } else {
            return ['success' => false, 'error' => 'Error al crear imagen desde archivo'];
        }
    } catch (Exception $e) {
        error_log("Error procesando imagen: " . $e->getMessage());
        // Ãšltimo recurso: simplemente mover el archivo
        if (move_uploaded_file($archivo_temporal, $ruta_completa)) {
            return ['success' => true, 'ruta' => $ruta_completa, 'nombre' => $nombre_archivo];
        } else {
            return ['success' => false, 'error' => 'Error en procesamiento de imagen: ' . $e->getMessage()];
        }
    }
}

// NUEVA FUNCIÃ“N: Guardar mÃºltiples fotos para una tarea
function guardar_fotos_tarea($tarea_id, $fotos_data) {
    global $pdo, $max_fotos_tarea;
    
    try {
        // Limitar el nÃºmero mÃ¡ximo de fotos
        $fotos_a_guardar = array_slice($fotos_data, 0, $max_fotos_tarea);
        
        $fotos_guardadas = [];
        
        foreach ($fotos_a_guardar as $foto_data) {
            $stmt = $pdo->prepare("INSERT INTO tarea_fotos (tarea_id, ruta_foto, nombre_archivo) VALUES (?, ?, ?)");
            $stmt->execute([$tarea_id, $foto_data['ruta'], $foto_data['nombre']]);
            $fotos_guardadas[] = $pdo->lastInsertId();
        }
        
        return ['success' => true, 'fotos_guardadas' => $fotos_guardadas, 'total' => count($fotos_guardadas)];
    } catch(Exception $e) {
        error_log("Error guardando fotos de tarea: " . $e->getMessage());
        return ['success' => false, 'error' => $e->getMessage()];
    }
}

// NUEVA FUNCIÃ“N: Obtener fotos de una tarea
function obtener_fotos_tarea($tarea_id) {
    global $pdo;
    
    try {
        $stmt = $pdo->prepare("SELECT * FROM tarea_fotos WHERE tarea_id = ? ORDER BY fecha_subida ASC");
        $stmt->execute([$tarea_id]);
        return $stmt->fetchAll();
    } catch(Exception $e) {
        error_log("Error obteniendo fotos de tarea: " . $e->getMessage());
        return [];
    }
}

// NUEVA FUNCIÃ“N: Asignar alertas de montacarga MEJORADA
function asignar_alertas_montacarga($turno, $hora_tarea) {
    global $pdo, $telegram_config;
    
    try {
        // Obtener empleados del turno especificado que no estÃ©n libres hoy
        $dias_semana = ['Domingo', 'Lunes', 'Martes', 'MiÃ©rcoles', 'Jueves', 'Viernes', 'SÃ¡bado'];
        $fecha_actual = obtenerFechaHoraActual();
        $dia_actual = $dias_semana[$fecha_actual->format('w')];
        
        $stmt = $pdo->prepare("
            SELECT * FROM usuarios 
            WHERE turno = ? AND activo = TRUE AND rol = 'empleado' 
            AND dia_libre != ? 
            ORDER BY RAND() LIMIT 2
        ");
        
        $stmt->execute([$turno, $dia_actual]);
        $empleados_montacarga = $stmt->fetchAll();
        
        if (count($empleados_montacarga) == 2) {
            // Limpiar alertas anteriores del mismo turno
            $stmt_clean = $pdo->prepare("UPDATE alertas_montacarga SET activa = FALSE WHERE turno = ?");
            $stmt_clean->execute([$turno]);
            
            // AMBOS EMPLEADOS EN POSICIÃ“N ARRIBA
            foreach ($empleados_montacarga as $empleado) {
                $fecha_asignacion = $fecha_actual->format('Y-m-d H:i:s');
                $stmt_alerta = $pdo->prepare("INSERT INTO alertas_montacarga (empleado_id, posicion, turno, hora_tarea, fecha_asignacion) VALUES (?, 'arriba', ?, ?, ?)");
                $stmt_alerta->execute([$empleado['id'], $turno, $hora_tarea, $fecha_asignacion]);
                
                // Notificar al empleado
                if (!empty($empleado['telegram_id'])) {
                    $mensaje = "ğŸšœ <b>ALERTA DE MONTACARGA ASIGNADA</b>\n\n";
                    $mensaje .= "ğŸ‘¤ <b>Empleado:</b> " . $empleado['nombre'] . "\n";
                    $mensaje .= "ğŸ”„ <b>Turno:</b> " . $turno . "\n";
                    $mensaje .= "â° <b>Hora:</b> " . $hora_tarea . "\n";
                    $mensaje .= "ğŸ“ <b>PosiciÃ³n:</b> SUPERIOR (ARRIBA)\n\n";
                    $mensaje .= "ğŸ“‹ <b>Tarea:</b> QUEDARSE EN LA POSICIÃ“N SUPERIOR DEL MONTACARGA PARA ENVIAR PATANAS\n\n";
                    $mensaje .= "âœ… <b>Instrucciones:</b>\n";
                    $mensaje .= "â€¢ Quedarse en la posiciÃ³n superior\n";
                    $mensaje .= "â€¢ Enviar patanas a los compaÃ±eros del almacÃ©n\n";
                    $mensaje .= "â€¢ Coordinar el movimiento del montacarga\n\n";
                    $mensaje .= "âš ï¸ <b>Recuerda marcar como completada cuando termines</b>";
                    
                    enviar_telegram($empleado['telegram_id'], $mensaje);
                }
            }
            
            return [
                'success' => true, 
                'empleados_montacarga' => $empleados_montacarga,
                'total_empleados' => count($empleados_montacarga)
            ];
        }
        
        return ['success' => false, 'error' => 'No hay suficientes empleados para asignar alertas de montacarga'];
    } catch(Exception $e) {
        error_log("Error asignando alertas montacarga: " . $e->getMessage());
        return ['success' => false, 'error' => $e->getMessage()];
    }
}

// FUNCIÃ“N COMPLETAMENTE CORREGIDA: Verificar y actualizar estado de tareas vencidas
function actualizar_tareas_vencidas() {
    global $pdo;
    
    try {
        $fecha_actual = obtenerFechaHoraActual();
        $fecha_actual_sql = $fecha_actual->format('Y-m-d H:i:s');
        
        // ACTUALIZAR TAREAS VENCIDAS - CORRECCIÃ“N DEFINITIVA
        $stmt = $pdo->prepare("
            UPDATE tareas 
            SET estado = 'vencida' 
            WHERE estado = 'pendiente' 
            AND fecha_vencimiento IS NOT NULL 
            AND fecha_vencimiento < ?
        ");
        $stmt->execute([$fecha_actual_sql]);
        
        $tareas_vencidas = $stmt->rowCount();
        
        if ($tareas_vencidas > 0) {
            error_log("Tareas vencidas actualizadas: " . $tareas_vencidas);
        }
        
        return $tareas_vencidas;
    } catch(Exception $e) {
        error_log("Error actualizando tareas vencidas: " . $e->getMessage());
        return 0;
    }
}

// NUEVA FUNCIÃ“N: Limpiar tareas antiguas (24 horas)
function limpiar_tareas_antiguas() {
    global $pdo, $limpiar_tareas_24h;
    
    if (!$limpiar_tareas_24h) {
        return 0;
    }
    
    try {
        $fecha_limite = obtenerFechaHoraActual();
        $fecha_limite->modify('-24 hours');
        $fecha_limite_sql = $fecha_limite->format('Y-m-d H:i:s');
        
        // Eliminar tareas completadas/verificadas con mÃ¡s de 24 horas
        $stmt = $pdo->prepare("
            DELETE FROM tareas 
            WHERE estado IN ('completada', 'verificada') 
            AND fecha_completado < ?
        ");
        $stmt->execute([$fecha_limite_sql]);
        
        $tareas_eliminadas = $stmt->rowCount();
        
        if ($tareas_eliminadas > 0) {
            error_log("Tareas antiguas eliminadas: " . $tareas_eliminadas);
        }
        
        return $tareas_eliminadas;
    } catch(Exception $e) {
        error_log("Error limpiando tareas antiguas: " . $e->getMessage());
        return 0;
    }
}

// FUNCIÃ“N NUEVA: Probar conexiÃ³n con Telegram
function probar_telegram_bot($token, $chat_id) {
    if (empty($token) || empty($chat_id)) {
        return ['success' => false, 'error' => 'Token o Chat ID vacÃ­o'];
    }
    
    try {
        $url = "https://api.telegram.org/bot" . $token . "/getMe";
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 10);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, true);
        
        $result = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        
        if (curl_error($ch)) {
            curl_close($ch);
            return ['success' => false, 'error' => 'Error de conexiÃ³n: ' . curl_error($ch)];
        }
        
        curl_close($ch);
        
        $response = json_decode($result, true);
        
        if ($http_code !== 200 || !$response['ok']) {
            return ['success' => false, 'error' => 'Token invÃ¡lido o bot no encontrado'];
        }
        
        // Probar envÃ­o de mensaje
        $mensaje_prueba = "ğŸ¤– <b>PRUEBA DE CONEXIÃ“N EXITOSA</b>\n\n";
        $mensaje_prueba .= "âœ… <b>Bot:</b> " . $response['result']['first_name'] . "\n";
        $mensaje_prueba .= "ğŸ“ <b>Usuario:</b> @" . ($response['result']['username'] ?? 'N/A') . "\n";
        $mensaje_prueba .= "â° <b>Hora:</b> " . date('d/m/Y H:i:s') . "\n\n";
        $mensaje_prueba .= "ğŸ”” <b>Sistema de GestiÃ³n de Empleados v2.0.0</b>\n";
        $mensaje_prueba .= "ğŸš€ <b>ConfiguraciÃ³n completada correctamente</b>";
        
        $resultado_envio = enviar_telegram($chat_id, $mensaje_prueba);
        
        if ($resultado_envio) {
            return [
                'success' => true, 
                'bot_info' => $response['result'],
                'message' => 'ConexiÃ³n exitosa y mensaje de prueba enviado'
            ];
        } else {
            return ['success' => false, 'error' => 'Token vÃ¡lido pero no se pudo enviar mensaje al Chat ID'];
        }
        
    } catch(Exception $e) {
        return ['success' => false, 'error' => 'ExcepciÃ³n: ' . $e->getMessage()];
    }
}

// FUNCIÃ“N NUEVA: Obtener tareas con privacidad entre administradores - CORREGIDA
function obtener_tareas_por_administrador($administrador_id, $rol) {
    global $pdo, $privacidad_tareas;
    
    try {
        if ($rol === 'admin_pro') {
            // Admin pro ve todas las tareas
            $stmt = $pdo->prepare("
                SELECT t.*, u.nombre as empleado_nombre, u2.nombre as admin_nombre 
                FROM tareas t 
                LEFT JOIN usuarios u ON t.empleado_id = u.id 
                LEFT JOIN usuarios u2 ON t.administrador_id = u2.id 
                ORDER BY t.fecha_asignacion DESC 
                LIMIT 100
            ");
            $stmt->execute();
        } else {
            // Admin normal solo ve sus propias tareas si la privacidad estÃ¡ activada
            if ($privacidad_tareas) {
                $stmt = $pdo->prepare("
                    SELECT t.*, u.nombre as empleado_nombre, u2.nombre as admin_nombre 
                    FROM tareas t 
                    LEFT JOIN usuarios u ON t.empleado_id = u.id 
                    LEFT JOIN usuarios u2 ON t.administrador_id = u2.id 
                    WHERE t.administrador_id = ?
                    ORDER BY t.fecha_asignacion DESC 
                    LIMIT 100
                ");
                $stmt->execute([$administrador_id]);
            } else {
                // Si la privacidad estÃ¡ desactivada, ve todas las tareas
                $stmt = $pdo->prepare("
                    SELECT t.*, u.nombre as empleado_nombre, u2.nombre as admin_nombre 
                    FROM tareas t 
                    LEFT JOIN usuarios u ON t.empleado_id = u.id 
                    LEFT JOIN usuarios u2 ON t.administrador_id = u2.id 
                    ORDER BY t.fecha_asignacion DESC 
                    LIMIT 100
                ");
                $stmt->execute();
            }
        }
        
        return $stmt->fetchAll();
    } catch(Exception $e) {
        error_log("Error obteniendo tareas por administrador: " . $e->getMessage());
        return [];
    }
}

// FUNCIÃ“N NUEVA: Asignar tarea a mÃºltiples empleados - CORREGIDA
function asignar_tarea_multiple($empleados_ids, $titulo, $descripcion, $administrador_id, $fecha_vencimiento = null, $requiere_foto = false, $notificar_telegram = true) {
    global $pdo, $telegram_config;
    
    try {
        $fecha_asignacion = obtenerFechaHoraActual()->format('Y-m-d H:i:s');
        $fecha_vencimiento_sql = $fecha_vencimiento ? convertirFechaUTC($fecha_vencimiento) : null;
        
        $tareas_creadas = [];
        
        foreach ($empleados_ids as $empleado_id) {
            // Crear tarea principal
            $stmt = $pdo->prepare("INSERT INTO tareas (titulo, descripcion, empleado_id, administrador_id, requiere_foto, fecha_vencimiento, notificar_telegram, fecha_asignacion) VALUES (?, ?, ?, ?, ?, ?, ?, ?)");
            $stmt->execute([$titulo, $descripcion, $empleado_id, $administrador_id, $requiere_foto, $fecha_vencimiento_sql, $notificar_telegram, $fecha_asignacion]);
            $tarea_id = $pdo->lastInsertId();
            
            $tareas_creadas[] = $tarea_id;
            
            // Notificar al empleado si tiene Telegram configurado
            if ($notificar_telegram) {
                $stmt_empleado = $pdo->prepare("SELECT nombre, telegram_id FROM usuarios WHERE id = ?");
                $stmt_empleado->execute([$empleado_id]);
                $empleado = $stmt_empleado->fetch();
                
                if ($empleado && !empty($empleado['telegram_id'])) {
                    $mensaje = "ğŸ“‹ <b>NUEVA TAREA ASIGNADA</b>\n\n";
                    $mensaje .= "ğŸ‘¤ <b>Empleado:</b> " . $empleado['nombre'] . "\n";
                    $mensaje .= "ğŸ“ <b>Tarea:</b> " . $titulo . "\n";
                    $mensaje .= "ğŸ“„ <b>DescripciÃ³n:</b> " . $descripcion . "\n";
                    
                    if ($fecha_vencimiento) {
                        $mensaje .= "â° <b>Vence:</b> " . convertirFechaZonaHoraria($fecha_vencimiento, 'd/m/Y H:i') . "\n";
                    }
                    
                    if ($requiere_foto) {
                        $mensaje .= "ğŸ“¸ <b>Requiere foto de evidencia</b>\n";
                    }
                    
                    $mensaje .= "\nğŸ’¡ <b>Accede al panel para completar la tarea</b>";
                    
                    enviar_telegram($empleado['telegram_id'], $mensaje);
                }
            }
        }
        
        return [
            'success' => true, 
            'tareas_creadas' => $tareas_creadas,
            'total_empleados' => count($empleados_ids)
        ];
        
    } catch(Exception $e) {
        error_log("Error asignando tarea mÃºltiple: " . $e->getMessage());
        return ['success' => false, 'error' => $e->getMessage()];
    }
}

// FUNCIÃ“N NUEVA: Obtener estadÃ­sticas de tareas por administrador - CORREGIDA
function obtener_estadisticas_tareas_por_administrador($administrador_id, $rol) {
    global $pdo, $privacidad_tareas;
    
    try {
        if ($rol === 'admin_pro') {
            // Admin pro ve todas las estadÃ­sticas
            $tareas_pendientes = $pdo->query("SELECT COUNT(*) FROM tareas WHERE estado = 'pendiente'")->fetchColumn();
            $tareas_completadas = $pdo->query("SELECT COUNT(*) FROM tareas WHERE estado = 'completada'")->fetchColumn();
            $tareas_vencidas = $pdo->query("SELECT COUNT(*) FROM tareas WHERE estado = 'vencida'")->fetchColumn();
        } else {
            // Admin normal solo ve sus propias estadÃ­sticas si la privacidad estÃ¡ activada
            if ($privacidad_tareas) {
                $stmt_pendientes = $pdo->prepare("SELECT COUNT(*) FROM tareas WHERE estado = 'pendiente' AND administrador_id = ?");
                $stmt_pendientes->execute([$administrador_id]);
                $tareas_pendientes = $stmt_pendientes->fetchColumn();
                
                $stmt_completadas = $pdo->prepare("SELECT COUNT(*) FROM tareas WHERE estado = 'completada' AND administrador_id = ?");
                $stmt_completadas->execute([$administrador_id]);
                $tareas_completadas = $stmt_completadas->fetchColumn();
                
                $stmt_vencidas = $pdo->prepare("SELECT COUNT(*) FROM tareas WHERE estado = 'vencida' AND administrador_id = ?");
                $stmt_vencidas->execute([$administrador_id]);
                $tareas_vencidas = $stmt_vencidas->fetchColumn();
            } else {
                // Si la privacidad estÃ¡ desactivada, ve todas las estadÃ­sticas
                $tareas_pendientes = $pdo->query("SELECT COUNT(*) FROM tareas WHERE estado = 'pendiente'")->fetchColumn();
                $tareas_completadas = $pdo->query("SELECT COUNT(*) FROM tareas WHERE estado = 'completada'")->fetchColumn();
                $tareas_vencidas = $pdo->query("SELECT COUNT(*) FROM tareas WHERE estado = 'vencida'")->fetchColumn();
            }
        }
        
        return [
            'pendientes' => $tareas_pendientes,
            'completadas' => $tareas_completadas,
            'vencidas' => $tareas_vencidas
        ];
    } catch(Exception $e) {
        error_log("Error obteniendo estadÃ­sticas por administrador: " . $e->getMessage());
        return ['pendientes' => 0, 'completadas' => 0, 'vencidas' => 0];
    }
}

// NUEVA FUNCIÃ“N: Verificar si una tarea estÃ¡ vencida
function tarea_esta_vencida($tarea) {
    if ($tarea['estado'] !== 'pendiente') {
        return false;
    }
    
    if (empty($tarea['fecha_vencimiento'])) {
        return false;
    }
    
    $fecha_actual = obtenerFechaHoraActual();
    $fecha_vencimiento = new DateTime($tarea['fecha_vencimiento'], new DateTimeZone('UTC'));
    $fecha_vencimiento->setTimezone(new DateTimeZone('America/Santo_Domingo'));
    
    return $fecha_vencimiento < $fecha_actual;
}

// NUEVA FUNCIÃ“N: Obtener tareas vencidas de un empleado
function obtener_tareas_vencidas_empleado($empleado_id) {
    global $pdo;
    
    try {
        $fecha_actual = obtenerFechaHoraActual();
        $fecha_actual_sql = $fecha_actual->format('Y-m-d H:i:s');
        
        $stmt = $pdo->prepare("
            SELECT COUNT(*) as count 
            FROM tareas 
            WHERE empleado_id = ? 
            AND estado = 'vencida'
            AND fecha_vencimiento IS NOT NULL 
            AND fecha_vencimiento < ?
        ");
        $stmt->execute([$empleado_id, $fecha_actual_sql]);
        $result = $stmt->fetch();
        
        return $result['count'] ?? 0;
    } catch(Exception $e) {
        error_log("Error obteniendo tareas vencidas: " . $e->getMessage());
        return 0;
    }
}

// NUEVA FUNCIÃ“N: Procesar comando /start de Telegram
function procesar_comando_start($chat_id, $nombre_usuario = '') {
    global $telegram_config;
    
    $mensaje = "ğŸ‘‹ <b>Â¡Hola " . ($nombre_usuario ?: 'Usuario') . "!</b>\n\n";
    $mensaje .= "ğŸ¤– <b>Bot del Sistema de GestiÃ³n de Empleados</b>\n\n";
    $mensaje .= "ğŸ“‹ <b>Tu ID de Telegram es:</b> <code>" . $chat_id . "</code>\n\n";
    $mensaje .= "ğŸ“ <b>Para recibir notificaciones:</b>\n";
    $mensaje .= "1. Copia tu ID de arriba\n";
    $mensaje .= "2. Ve al panel web del sistema\n";
    $mensaje .= "3. En 'Mi Perfil', pega tu ID en 'ID de Telegram'\n";
    $mensaje .= "4. Guarda los cambios\n\n";
    $mensaje .= "ğŸ”” <b>RecibirÃ¡s notificaciones de:</b>\n";
    $mensaje .= "â€¢ Nuevas tareas asignadas\n";
    $mensaje .= "â€¢ Recordatorios de tareas\n";
    $mensaje .= "â€¢ Alertas del sistema\n\n";
    $mensaje .= "â“ <b>Â¿Necesitas ayuda?</b> Contacta al administrador del sistema.";
    
    return enviar_telegram($chat_id, $mensaje);
}

// NUEVA FUNCIÃ“N: Verificar si se puede reabrir una tarea vencida
function tarea_puede_reabrirse($tarea_id) {
    global $pdo, $tiempo_reabrir_tarea;
    
    try {
        $stmt = $pdo->prepare("SELECT fecha_completado, estado FROM tareas WHERE id = ?");
        $stmt->execute([$tarea_id]);
        $tarea = $stmt->fetch();
        
        if (!$tarea || $tarea['estado'] !== 'vencida') {
            return false;
        }
        
        // Verificar si ha pasado el tiempo mÃ­nimo para reabrir
        $fecha_actual = obtenerFechaHoraActual();
        $fecha_vencimiento = new DateTime($tarea['fecha_completado'] ?? 'now', new DateTimeZone('UTC'));
        $fecha_vencimiento->setTimezone(new DateTimeZone('America/Santo_Domingo'));
        
        $diferencia = $fecha_actual->getTimestamp() - $fecha_vencimiento->getTimestamp();
        $minutos_transcurridos = $diferencia / 60;
        
        return $minutos_transcurridos >= $tiempo_reabrir_tarea;
    } catch(Exception $e) {
        error_log("Error verificando reapertura de tarea: " . $e->getMessage());
        return false;
    }
}

// NUEVA FUNCIÃ“N: Obtener comandos de Telegram
function obtener_comandos_telegram() {
    global $pdo;
    
    try {
        $stmt = $pdo->query("SELECT * FROM telegram_comandos WHERE activo = TRUE ORDER BY comando");
        return $stmt->fetchAll();
    } catch(Exception $e) {
        error_log("Error obteniendo comandos de Telegram: " . $e->getMessage());
        return [];
    }
}

// NUEVA FUNCIÃ“N: Procesar comandos personalizados de Telegram
function procesar_comando_personalizado($comando, $chat_id, $nombre_usuario = '') {
    global $pdo;
    
    try {
        $stmt = $pdo->prepare("SELECT respuesta FROM telegram_comandos WHERE comando = ? AND activo = TRUE");
        $stmt->execute([$comando]);
        $comando_data = $stmt->fetch();
        
        if ($comando_data) {
            $respuesta = $comando_data['respuesta'];
            // Reemplazar variables en la respuesta
            $respuesta = str_replace('{nombre}', $nombre_usuario ?: 'Usuario', $respuesta);
            $respuesta = str_replace('{chat_id}', $chat_id, $respuesta);
            $respuesta = str_replace('{fecha}', date('d/m/Y'), $respuesta);
            $respuesta = str_replace('{hora}', date('H:i:s'), $respuesta);
            
            return enviar_telegram($chat_id, $respuesta);
        }
        
        return false;
    } catch(Exception $e) {
        error_log("Error procesando comando personalizado: " . $e->getMessage());
        return false;
    }
}
?>
EOF

# Crear pÃ¡gina de login mejorada
cat > index.php << 'EOF'
<?php
require_once 'config.php';
session_start();

// Prevenir repeticiÃ³n de acciones - CORREGIDO DEFINITIVAMENTE
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_SESSION['last_post_time']) && (time() - $_SESSION['last_post_time']) < 2) {
        // Redirigir sin procesar el formulario nuevamente
        header('Location: ' . $_SERVER['REQUEST_URI']);
        exit;
    }
    $_SESSION['last_post_time'] = time();
}

if (isset($_SESSION['usuario_id'])) {
    header('Location: panel.php');
    exit;
}

$error = '';
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = $_POST['username'] ?? '';
    $password = $_POST['password'] ?? '';
    
    try {
        $stmt = $pdo->prepare("SELECT * FROM usuarios WHERE username = ? AND activo = TRUE");
        $stmt->execute([$username]);
        $usuario = $stmt->fetch();
        
        if ($usuario && password_verify($password, $usuario['password'])) {
            $_SESSION['usuario_id'] = $usuario['id'];
            $_SESSION['username'] = $usuario['username'];
            $_SESSION['rol'] = $usuario['rol'];
            $_SESSION['nombre'] = $usuario['nombre'];
            
            registrar_log($usuario['id'], 'LOGIN_EXITOSO');
            
            header('Location: panel.php');
            exit;
        } else {
            $error = 'Usuario o contraseÃ±a incorrectos';
            registrar_log(null, 'LOGIN_FALLIDO', "Usuario: $username");
        }
    } catch(Exception $e) {
        $error = 'Error al iniciar sesiÃ³n';
    }
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo htmlspecialchars($nombre_sistema); ?> - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #007AFF;
            --color-primary-dark: #0056CC;
            --color-bg-dark: #000000;
            --color-card-bg: rgba(17, 24, 39, 0.8);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1e3a8a 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .liquid-glass {
            backdrop-filter: blur(40px) saturate(200%);
            -webkit-backdrop-filter: blur(40px) saturate(200%);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .liquid-card {
            background: linear-gradient(135deg, rgba(17, 24, 39, 0.9) 0%, rgba(30, 41, 59, 0.7) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.05);
        }
        
        .floating-element {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        .glow-effect {
            box-shadow: 0 0 20px rgba(0, 122, 255, 0.3);
        }
        
        .input-glass {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .input-glass:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(0, 122, 255, 0.5);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .btn-liquid {
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
            border: none;
            box-shadow: 
                0 4px 15px rgba(0, 122, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .btn-liquid:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(0, 122, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .btn-liquid:active {
            transform: translateY(0);
        }
        
        /* Animaciones mejoradas */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in-up {
            animation: fadeInUp 0.8s ease-out;
        }
        
        .animate-delay-1 {
            animation-delay: 0.2s;
        }
        
        .animate-delay-2 {
            animation-delay: 0.4s;
        }
        
        /* Efectos de partÃ­culas animadas */
        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float-particle 15s infinite linear;
        }
        
        @keyframes float-particle {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
    <!-- Elementos flotantes de fondo animados -->
    <div class="absolute inset-0 overflow-hidden">
        <?php for($i = 0; $i < 15; $i++): ?>
            <div class="particle" style="
                width: <?php echo rand(2, 6); ?>px;
                height: <?php echo rand(2, 6); ?>px;
                left: <?php echo rand(0, 100); ?>%;
                animation-delay: <?php echo rand(0, 15); ?>s;
                animation-duration: <?php echo rand(15, 30); ?>s;
            "></div>
        <?php endfor; ?>
        
        <div class="floating-element absolute top-1/4 left-1/4 w-20 h-20 bg-blue-500/10 rounded-full blur-xl"></div>
        <div class="floating-element absolute top-1/3 right-1/4 w-16 h-16 bg-purple-500/10 rounded-full blur-xl" style="animation-delay: -2s;"></div>
        <div class="floating-element absolute bottom-1/4 left-1/3 w-24 h-24 bg-cyan-500/10 rounded-full blur-xl" style="animation-delay: -4s;"></div>
        <div class="absolute bottom-1/3 right-1/3 w-12 h-12 bg-white/5 rounded-full blur-lg"></div>
    </div>
    
    <div class="liquid-card rounded-3xl p-8 w-full max-w-md relative z-10 animate-fade-in-up">
        <!-- Logo y TÃ­tulo -->
        <div class="text-center mb-8">
            <div class="w-24 h-24 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6 liquid-glass glow-effect animate-fade-in-up animate-delay-1">
                <i class="fas fa-users-cog text-white text-3xl"></i>
            </div>
            <h1 class="text-4xl font-bold text-white mb-3 bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent animate-fade-in-up animate-delay-1"><?php echo htmlspecialchars($nombre_sistema); ?></h1>
            <p class="text-gray-400 text-sm animate-fade-in-up animate-delay-2">v<?php echo VERSION; ?></p>
        </div>
        
        <?php if ($error): ?>
            <div class="liquid-glass border border-red-500/30 text-red-200 px-4 py-3 rounded-xl mb-6 flex items-center backdrop-blur-lg animate-fade-in-up">
                <i class="fas fa-exclamation-circle mr-3 text-red-400"></i>
                <?php echo htmlspecialchars($error); ?>
            </div>
        <?php endif; ?>
        
        <form method="POST" action="" class="space-y-6">
            <div class="animate-fade-in-up animate-delay-1">
                <label class="block text-gray-300 text-sm font-medium mb-3" for="username">
                    <i class="fas fa-user mr-2"></i>Usuario
                </label>
                <input type="text" id="username" name="username" required 
                       class="w-full px-4 py-4 input-glass rounded-2xl text-white placeholder-gray-400 focus:outline-none focus:ring-0 transition-all duration-300"
                       placeholder="Ingrese su usuario">
            </div>
            
            <div class="animate-fade-in-up animate-delay-2">
                <label class="block text-gray-300 text-sm font-medium mb-3" for="password">
                    <i class="fas fa-lock mr-2"></i>ContraseÃ±a
                </label>
                <input type="password" id="password" name="password" required 
                       class="w-full px-4 py-4 input-glass rounded-2xl text-white placeholder-gray-400 focus:outline-none focus:ring-0 transition-all duration-300"
                       placeholder="Ingrese su contraseÃ±a">
            </div>
            
            <button type="submit" 
                    class="w-full btn-liquid text-white font-semibold py-4 px-4 rounded-2xl transition-all duration-300 flex items-center justify-center text-lg animate-fade-in-up animate-delay-2">
                <i class="fas fa-sign-in-alt mr-3"></i> Iniciar SesiÃ³n
            </button>
        </form>
    </div>
    
    <!-- Efectos de partÃ­culas adicionales -->
    <div class="absolute inset-0 pointer-events-none">
        <div class="absolute top-0 left-0 w-2 h-2 bg-white/10 rounded-full animate-pulse" style="animation-delay: 0s;"></div>
        <div class="absolute top-10 right-10 w-1 h-1 bg-white/10 rounded-full animate-pulse" style="animation-delay: 1s;"></div>
        <div class="absolute bottom-20 left-20 w-1 h-1 bg-white/10 rounded-full animate-pulse" style="animation-delay: 2s;"></div>
    </div>
</body>
</html>
EOF

# Crear archivo de logout
cat > logout.php << 'EOF'
<?php
require_once 'config.php';
session_start();

if (isset($_SESSION['usuario_id'])) {
    registrar_log($_SESSION['usuario_id'], 'LOGOUT');
}

session_destroy();
session_unset();

header('Location: index.php');
exit;
?>
EOF

# Crear script para completar tarea con mÃºltiples fotos desde cÃ¡mara - COMPLETAMENTE CORREGIDO
cat > completar_tarea_foto.php << 'EOF'
<?php
require_once 'config.php';
session_start();

// CORRECCIÃ“N: Configurar headers para JSON
header('Content-Type: application/json');

if (!isset($_SESSION['usuario_id'])) {
    http_response_code(401);
    echo json_encode(['success' => false, 'error' => 'No autenticado']);
    exit;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $tarea_id = $_POST['tarea_id'] ?? '';
    $fotos_base64 = $_POST['fotos'] ?? [];
    
    try {
        // Verificar que la tarea pertenece al empleado
        $stmt = $pdo->prepare("SELECT * FROM tareas WHERE id = ? AND empleado_id = ?");
        $stmt->execute([$tarea_id, $_SESSION['usuario_id']]);
        $tarea = $stmt->fetch();
        
        if (!$tarea) {
            http_response_code(403);
            echo json_encode(['success' => false, 'error' => 'Tarea no encontrada o no autorizada']);
            exit;
        }
        
        $fotos_procesadas = [];
        $fotos_guardadas = [];
        
        // CORRECCIÃ“N: Procesar mÃºltiples fotos desde base64
        if (!empty($fotos_base64) && is_array($fotos_base64)) {
            foreach ($fotos_base64 as $index => $foto_base64) {
                if (!empty($foto_base64)) {
                    // Convertir base64 a archivo temporal
                    $foto_data = base64_decode(preg_replace('#^data:image/\w+;base64,#i', '', $foto_base64));
                    $archivo_temporal = tempnam(sys_get_temp_dir(), 'foto_tarea');
                    file_put_contents($archivo_temporal, $foto_data);
                    
                    $resultado_foto = procesar_foto_subida($archivo_temporal, $tarea_id, $_SESSION['usuario_id']);
                    if ($resultado_foto['success']) {
                        $fotos_procesadas[] = $resultado_foto;
                    } else {
                        error_log("Error procesando foto $index: " . $resultado_foto['error']);
                    }
                    
                    // Limpiar archivo temporal
                    unlink($archivo_temporal);
                }
            }
        }
        
        // Guardar las fotos en la base de datos
        if (!empty($fotos_procesadas)) {
            $resultado_guardar_fotos = guardar_fotos_tarea($tarea_id, $fotos_procesadas);
            if ($resultado_guardar_fotos['success']) {
                $fotos_guardadas = $resultado_guardar_fotos['fotos_guardadas'];
            }
        }
        
        // Notificar al administrador que asignÃ³ la tarea CON LAS FOTOS
        $stmt_admin = $pdo->prepare("SELECT nombre, telegram_id FROM usuarios WHERE id = ?");
        $stmt_admin->execute([$tarea['administrador_id']]);
        $admin = $stmt_admin->fetch();
        
        $fecha_completado = obtenerFechaHoraActual()->format('d/m/Y H:i:s');
        $mensaje_telegram = "ğŸ“¸ <b>TAREA COMPLETADA CON " . count($fotos_procesadas) . " FOTO(S)</b>\n\n";
        $mensaje_telegram .= "ğŸ‘¤ <b>Empleado:</b> " . $_SESSION['nombre'] . "\n";
        $mensaje_telegram .= "ğŸ“ <b>Tarea:</b> " . $tarea['titulo'] . "\n";
        $mensaje_telegram .= "âœ… <b>Estado:</b> Completada\n";
        $mensaje_telegram .= "â° <b>Completada:</b> " . $fecha_completado . "\n\n";
        $mensaje_telegram .= "ğŸ“ <b>Se adjuntaron " . count($fotos_procesadas) . " foto(s) de evidencia</b>";
        
        // Enviar notificaciÃ³n al administrador
        if ($admin && !empty($admin['telegram_id'])) {
            enviar_telegram($admin['telegram_id'], $mensaje_telegram);
            
            // Enviar las fotos tambiÃ©n
            $rutas_fotos = array_column($fotos_procesadas, 'ruta');
            enviar_multiple_fotos_telegram($admin['telegram_id'], $rutas_fotos, "Fotos de evidencia - " . $tarea['titulo']);
        }
        
        // Notificar al chat general del admin
        global $telegram_config;
        if (!empty($telegram_config['chat_id'])) {
            enviar_telegram($telegram_config['chat_id'], $mensaje_telegram);
            $rutas_fotos = array_column($fotos_procesadas, 'ruta');
            enviar_multiple_fotos_telegram($telegram_config['chat_id'], $rutas_fotos, "Fotos de evidencia - " . $tarea['titulo']);
        }
        
        // Actualizar estado de la tarea
        $fecha_completado_sql = obtenerFechaHoraActual()->format('Y-m-d H:i:s');
        $stmt = $pdo->prepare("UPDATE tareas SET estado = 'completada', fecha_completado = ? WHERE id = ?");
        $stmt->execute([$fecha_completado_sql, $tarea_id]);
        
        registrar_log($_SESSION['usuario_id'], 'TAREA_COMPLETADA', "Tarea ID: $tarea_id con " . count($fotos_procesadas) . " fotos");
        
        // CORRECCIÃ“N: Enviar respuesta JSON correcta
        http_response_code(200);
        echo json_encode([
            'success' => true, 
            'message' => 'Tarea completada exitosamente con ' . count($fotos_procesadas) . ' foto(s)',
            'fotos_procesadas' => count($fotos_procesadas)
        ]);
        
    } catch(Exception $e) {
        http_response_code(500);
        error_log("Error al completar tarea: " . $e->getMessage());
        echo json_encode(['success' => false, 'error' => 'Error al completar tarea: ' . $e->getMessage()]);
    }
} else {
    http_response_code(405);
    echo json_encode(['success' => false, 'error' => 'MÃ©todo no permitido']);
}
?>
EOF

# Crear script para obtener fotos de tarea
cat > obtener_fotos_tarea.php << 'EOF'
<?php
require_once 'config.php';
session_start();

if (!isset($_SESSION['usuario_id'])) {
    header('Content-Type: application/json');
    echo json_encode(['error' => 'No autenticado']);
    exit;
}

$tarea_id = $_GET['tarea_id'] ?? 0;

try {
    // Verificar permisos para ver las fotos
    if ($_SESSION['rol'] === 'empleado') {
        $stmt = $pdo->prepare("SELECT id FROM tareas WHERE id = ? AND empleado_id = ?");
        $stmt->execute([$tarea_id, $_SESSION['usuario_id']]);
    } else {
        // Administradores pueden ver todas las tareas
        $stmt = $pdo->prepare("SELECT id FROM tareas WHERE id = ?");
        $stmt->execute([$tarea_id]);
    }
    
    $tarea = $stmt->fetch();
    
    if (!$tarea) {
        header('Content-Type: application/json');
        echo json_encode(['error' => 'Tarea no encontrada o no autorizada']);
        exit;
    }
    
    $fotos = obtener_fotos_tarea($tarea_id);
    
    header('Content-Type: application/json');
    echo json_encode(['success' => true, 'fotos' => $fotos]);
    
} catch(Exception $e) {
    header('Content-Type: application/json');
    echo json_encode(['error' => $e->getMessage()]);
}
?>
EOF

# Crear script para tareas automÃ¡ticas
cat > tareas_automaticas.php << 'EOF'
<?php
require_once 'config.php';

// Ejecutar solo desde lÃ­nea de comandos
if (php_sapi_name() !== 'cli') {
    die('Acceso denegado');
}

try {
    // Actualizar tareas vencidas
    $tareas_vencidas = actualizar_tareas_vencidas();
    
    // Limpiar tareas antiguas (24 horas)
    $tareas_limpiadas = limpiar_tareas_antiguas();
    
    // Registrar en log
    if ($tareas_vencidas > 0 || $tareas_limpiadas > 0) {
        error_log("Tareas automÃ¡ticas ejecutadas: $tareas_vencidas tareas vencidas, $tareas_limpiadas tareas limpiadas");
    }
    
    echo "Tareas automÃ¡ticas completadas: $tareas_vencidas vencidas, $tareas_limpiadas limpiadas\n";
} catch(Exception $e) {
    error_log("Error en tareas automÃ¡ticas: " . $e->getMessage());
    echo "Error: " . $e->getMessage() . "\n";
}
?>
EOF

# Crear script para backup automÃ¡tico
cat > backup_automatico.php << 'EOF'
<?php
require_once 'config.php';

// Ejecutar solo desde lÃ­nea de comandos
if (php_sapi_name() !== 'cli') {
    die('Acceso denegado');
}

try {
    // Obtener configuraciÃ³n de backup automÃ¡tico
    $stmt = $pdo->query("SELECT valor FROM configuraciones WHERE clave = 'backup_automatico'");
    $backup_automatico = $stmt->fetchColumn();
    
    if ($backup_automatico == '1') {
        // Generar backup
        $resultado = generar_backup(1); // Usuario sistema
        
        if ($resultado['success']) {
            echo "Backup automÃ¡tico generado: " . $resultado['nombre'] . "\n";
        } else {
            echo "Error en backup automÃ¡tico: " . $resultado['error'] . "\n";
        }
    } else {
        echo "Backup automÃ¡tico desactivado en configuraciÃ³n\n";
    }
} catch(Exception $e) {
    error_log("Error en backup automÃ¡tico: " . $e->getMessage());
    echo "Error: " . $e->getMessage() . "\n";
}
?>
EOF

# Crear script para webhook de Telegram MEJORADO
cat > telegram_webhook.php << 'EOF'
<?php
require_once 'config.php';

// Obtener el input de Telegram
$input = file_get_contents('php://input');
$update = json_decode($input, true);

if (!$update) {
    exit;
}

// Procesar el mensaje
if (isset($update['message'])) {
    $message = $update['message'];
    $chat_id = $message['chat']['id'];
    $text = $message['text'] ?? '';
    $first_name = $message['from']['first_name'] ?? '';
    $username = $message['from']['username'] ?? '';
    
    // Procesar comando /start
    if (strpos($text, '/start') === 0) {
        procesar_comando_start($chat_id, $first_name ?: $username);
    } else {
        // Procesar comandos personalizados
        $comandos = obtener_comandos_telegram();
        foreach ($comandos as $comando) {
            if (strpos($text, $comando['comando']) === 0) {
                procesar_comando_personalizado($comando['comando'], $chat_id, $first_name ?: $username);
                break;
            }
        }
    }
}
?>
EOF

# Crear script para obtener datos de usuario
cat > obtener_datos_usuario.php << 'EOF'
<?php
require_once 'config.php';
session_start();

if (!isset($_SESSION['usuario_id']) || !in_array($_SESSION['rol'], ['admin_pro', 'admin'])) {
    header('Content-Type: application/json');
    echo json_encode(['error' => 'No autorizado']);
    exit;
}

$user_id = $_GET['id'] ?? 0;

try {
    $stmt = $pdo->prepare("SELECT * FROM usuarios WHERE id = ?");
    $stmt->execute([$user_id]);
    $usuario = $stmt->fetch();
    
    if ($usuario) {
        header('Content-Type: application/json');
        echo json_encode($usuario);
    } else {
        header('Content-Type: application/json');
        echo json_encode(['error' => 'Usuario no encontrado']);
    }
} catch(Exception $e) {
    header('Content-Type: application/json');
    echo json_encode(['error' => $e->getMessage()]);
}
?>
EOF

# Crear script para obtener detalles de tarea
cat > obtener_detalles_tarea.php << 'EOF'
<?php
require_once 'config.php';
session_start();

if (!isset($_SESSION['usuario_id'])) {
    echo '<div class="text-red-400">No autenticado</div>';
    exit;
}

$tarea_id = $_GET['id'] ?? 0;

try {
    if ($_SESSION['rol'] === 'empleado') {
        $stmt = $pdo->prepare("
            SELECT t.*, u.nombre as admin_nombre 
            FROM tareas t 
            LEFT JOIN usuarios u ON t.administrador_id = u.id 
            WHERE t.id = ? AND t.empleado_id = ?
        ");
        $stmt->execute([$tarea_id, $_SESSION['usuario_id']]);
    } else {
        $stmt = $pdo->prepare("
            SELECT t.*, u.nombre as empleado_nombre, u2.nombre as admin_nombre 
            FROM tareas t 
            LEFT JOIN usuarios u ON t.empleado_id = u.id 
            LEFT JOIN usuarios u2 ON t.administrador_id = u2.id 
            WHERE t.id = ?
        ");
        $stmt->execute([$tarea_id]);
    }
    
    $tarea = $stmt->fetch();
    
    if ($tarea) {
        echo '<div class="space-y-4">';
        echo '<div><strong>TÃ­tulo:</strong> ' . htmlspecialchars($tarea['titulo']) . '</div>';
        echo '<div><strong>DescripciÃ³n:</strong> ' . nl2br(htmlspecialchars($tarea['descripcion'])) . '</div>';
        
        if ($_SESSION['rol'] !== 'empleado') {
            echo '<div><strong>Empleado:</strong> ' . htmlspecialchars($tarea['empleado_nombre']) . '</div>';
        }
        
        echo '<div><strong>Administrador:</strong> ' . htmlspecialchars($tarea['admin_nombre']) . '</div>';
        echo '<div><strong>Fecha asignaciÃ³n:</strong> ' . convertirFechaZonaHoraria($tarea['fecha_asignacion'], 'd/m/Y H:i:s') . '</div>';
        
        if ($tarea['fecha_vencimiento']) {
            echo '<div><strong>Fecha vencimiento:</strong> ' . convertirFechaZonaHoraria($tarea['fecha_vencimiento'], 'd/m/Y H:i:s') . '</div>';
        }
        
        if ($tarea['fecha_completado']) {
            echo '<div><strong>Fecha completado:</strong> ' . convertirFechaZonaHoraria($tarea['fecha_completado'], 'd/m/Y H:i:s') . '</div>';
        }
        
        echo '<div><strong>Estado:</strong> ' . ucfirst($tarea['estado']) . '</div>';
        
        if ($tarea['calificacion']) {
            echo '<div><strong>CalificaciÃ³n:</strong> ' . str_repeat('â˜…', $tarea['calificacion']) . '</div>';
        }
        
        if ($tarea['comentario_revision']) {
            echo '<div><strong>Comentario:</strong> ' . nl2br(htmlspecialchars($tarea['comentario_revision'])) . '</div>';
        }
        
        echo '</div>';
    } else {
        echo '<div class="text-red-400">Tarea no encontrada</div>';
    }
} catch(Exception $e) {
    echo '<div class="text-red-400">Error: ' . $e->getMessage() . '</div>';
}
?>
EOF

# Crear script para descargar backup
cat > descargar_backup.php << 'EOF'
<?php
require_once 'config.php';
session_start();

if (!isset($_SESSION['usuario_id']) || !in_array($_SESSION['rol'], ['admin_pro', 'admin'])) {
    header('Content-Type: application/json');
    echo json_encode(['success' => false, 'error' => 'No autorizado']);
    exit;
}

$nombre_archivo = $_GET['file'] ?? '';

if (empty($nombre_archivo)) {
    header('Content-Type: application/json');
    echo json_encode(['success' => false, 'error' => 'Archivo no especificado']);
    exit;
}

$ruta_backup = "/var/www/backups/" . $nombre_archivo;

if (!file_exists($ruta_backup)) {
    header('Content-Type: application/json');
    echo json_encode(['success' => false, 'error' => 'Archivo no encontrado']);
    exit;
}

// Enviar archivo para descarga
header('Content-Type: application/octet-stream');
header('Content-Disposition: attachment; filename="' . $nombre_archivo . '"');
header('Content-Length: ' . filesize($ruta_backup));
readfile($ruta_backup);
exit;
?>
EOF

# Crear script para subir backup
cat > subir_backup.php << 'EOF'
<?php
require_once 'config.php';
session_start();

if (!isset($_SESSION['usuario_id']) || !in_array($_SESSION['rol'], ['admin_pro', 'admin'])) {
    header('Content-Type: application/json');
    echo json_encode(['success' => false, 'error' => 'No autorizado']);
    exit;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_FILES['backup_file']) && $_FILES['backup_file']['error'] === UPLOAD_ERR_OK) {
        $archivo_temporal = $_FILES['backup_file']['tmp_name'];
        $nombre_archivo = $_FILES['backup_file']['name'];
        $tipo_archivo = $_FILES['backup_file']['type'];
        
        // Validar que sea un archivo SQL
        if (pathinfo($nombre_archivo, PATHINFO_EXTENSION) !== 'sql') {
            echo json_encode(['success' => false, 'error' => 'Solo se permiten archivos SQL']);
            exit;
        }
        
        // Validar tamaÃ±o (mÃ¡ximo 100MB)
        if ($_FILES['backup_file']['size'] > 100 * 1024 * 1024) {
            echo json_encode(['success' => false, 'error' => 'El archivo es demasiado grande. TamaÃ±o mÃ¡ximo: 100MB.']);
            exit;
        }
        
        $backup_dir = "/var/www/backups";
        $ruta_destino = $backup_dir . '/' . $nombre_archivo;
        
        // Mover el archivo subido
        if (move_uploaded_file($archivo_temporal, $ruta_destino)) {
            // Intentar restaurar el backup
            $command = "mysql -h " . DB_HOST . " -u " . DB_USER . " -p'" . DB_PASS . "' " . DB_NAME . " < " . $ruta_destino . " 2>&1";
            $output = [];
            $return_var = 0;
            exec($command, $output, $return_var);
            
            if ($return_var === 0) {
                registrar_log($_SESSION['usuario_id'], 'BACKUP_RESTAURADO', "Archivo: $nombre_archivo");
                echo json_encode(['success' => true, 'message' => 'Backup restaurado exitosamente']);
            } else {
                // Eliminar el archivo si la restauraciÃ³n falla
                unlink($ruta_destino);
                echo json_encode(['success' => false, 'error' => 'Error al restaurar backup: ' . implode("\n", $output)]);
            }
        } else {
            echo json_encode(['success' => false, 'error' => 'Error al subir el archivo']);
        }
    } else {
        echo json_encode(['success' => false, 'error' => 'No se pudo subir el archivo']);
    }
} else {
    echo json_encode(['success' => false, 'error' => 'MÃ©todo no permitido']);
}
?>
EOF

# Crear script para editar tareas
cat > editar_tarea.php << 'EOF'
<?php
require_once 'config.php';
session_start();

if (!isset($_SESSION['usuario_id']) || !in_array($_SESSION['rol'], ['admin_pro', 'admin'])) {
    header('Content-Type: application/json');
    echo json_encode(['success' => false, 'error' => 'No autorizado']);
    exit;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $tarea_id = $_POST['tarea_id'] ?? '';
    $titulo = $_POST['titulo'] ?? '';
    $descripcion = $_POST['descripcion'] ?? '';
    $empleado_id = $_POST['empleado_id'] ?? '';
    $fecha_vencimiento = $_POST['fecha_vencimiento'] ?? '';
    $requiere_foto = isset($_POST['requiere_foto']) ? 1 : 0;
    
    try {
        // Verificar que la tarea existe y pertenece al administrador
        $stmt = $pdo->prepare("SELECT * FROM tareas WHERE id = ?");
        $stmt->execute([$tarea_id]);
        $tarea = $stmt->fetch();
        
        if (!$tarea) {
            echo json_encode(['success' => false, 'error' => 'Tarea no encontrada']);
            exit;
        }
        
        // Solo admin_pro puede editar tareas de otros administradores
        if ($_SESSION['rol'] !== 'admin_pro' && $tarea['administrador_id'] != $_SESSION['usuario_id']) {
            echo json_encode(['success' => false, 'error' => 'No tienes permisos para editar esta tarea']);
            exit;
        }
        
        // Actualizar la tarea
        $fecha_vencimiento_sql = $fecha_vencimiento ? convertirFechaUTC($fecha_vencimiento) : null;
        
        $stmt = $pdo->prepare("UPDATE tareas SET titulo = ?, descripcion = ?, empleado_id = ?, fecha_vencimiento = ?, requiere_foto = ? WHERE id = ?");
        $stmt->execute([$titulo, $descripcion, $empleado_id, $fecha_vencimiento_sql, $requiere_foto, $tarea_id]);
        
        registrar_log($_SESSION['usuario_id'], 'TAREA_EDITADA', "Tarea ID: $tarea_id");
        
        echo json_encode(['success' => true, 'message' => 'Tarea actualizada exitosamente']);
        
    } catch(Exception $e) {
        error_log("Error editando tarea: " . $e->getMessage());
        echo json_encode(['success' => false, 'error' => 'Error al editar tarea: ' . $e->getMessage()]);
    }
} else {
    echo json_encode(['success' => false, 'error' => 'MÃ©todo no permitido']);
}
?>
EOF

# Crear script para obtener datos de tarea
cat > obtener_datos_tarea.php << 'EOF'
<?php
require_once 'config.php';
session_start();

if (!isset($_SESSION['usuario_id']) || !in_array($_SESSION['rol'], ['admin_pro', 'admin'])) {
    header('Content-Type: application/json');
    echo json_encode(['error' => 'No autorizado']);
    exit;
}

$tarea_id = $_GET['id'] ?? 0;

try {
    $stmt = $pdo->prepare("
        SELECT t.*, u.nombre as empleado_nombre 
        FROM tareas t 
        LEFT JOIN usuarios u ON t.empleado_id = u.id 
        WHERE t.id = ?
    ");
    $stmt->execute([$tarea_id]);
    $tarea = $stmt->fetch();
    
    if ($tarea) {
        // Convertir fecha de vencimiento a formato local para el formulario
        if ($tarea['fecha_vencimiento']) {
            $tarea['fecha_vencimiento_form'] = convertirFechaZonaHoraria($tarea['fecha_vencimiento'], 'Y-m-d\TH:i');
        } else {
            $tarea['fecha_vencimiento_form'] = '';
        }
        
        header('Content-Type: application/json');
        echo json_encode($tarea);
    } else {
        header('Content-Type: application/json');
        echo json_encode(['error' => 'Tarea no encontrada']);
    }
} catch(Exception $e) {
    header('Content-Type: application/json');
    echo json_encode(['error' => $e->getMessage()]);
}
?>
EOF

# Crear script para gestionar comandos de Telegram
cat > gestionar_comandos_telegram.php << 'EOF'
<?php
require_once 'config.php';
session_start();

if (!isset($_SESSION['usuario_id']) || $_SESSION['rol'] !== 'admin_pro') {
    header('Content-Type: application/json');
    echo json_encode(['success' => false, 'error' => 'No autorizado']);
    exit;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $accion = $_POST['accion'] ?? '';
    
    try {
        switch ($accion) {
            case 'crear_comando':
                $comando = $_POST['comando'] ?? '';
                $respuesta = $_POST['respuesta'] ?? '';
                
                if (empty($comando) || empty($respuesta)) {
                    echo json_encode(['success' => false, 'error' => 'Comando y respuesta son obligatorios']);
                    exit;
                }
                
                // Verificar que el comando no exista
                $stmt = $pdo->prepare("SELECT id FROM telegram_comandos WHERE comando = ?");
                $stmt->execute([$comando]);
                if ($stmt->fetch()) {
                    echo json_encode(['success' => false, 'error' => 'El comando ya existe']);
                    exit;
                }
                
                $stmt = $pdo->prepare("INSERT INTO telegram_comandos (comando, respuesta) VALUES (?, ?)");
                $stmt->execute([$comando, $respuesta]);
                
                registrar_log($_SESSION['usuario_id'], 'COMANDO_TELEGRAM_CREADO', "Comando: $comando");
                echo json_encode(['success' => true, 'message' => 'Comando creado exitosamente']);
                break;
                
            case 'editar_comando':
                $comando_id = $_POST['comando_id'] ?? '';
                $comando = $_POST['comando'] ?? '';
                $respuesta = $_POST['respuesta'] ?? '';
                $activo = isset($_POST['activo']) ? 1 : 0;
                
                $stmt = $pdo->prepare("UPDATE telegram_comandos SET comando = ?, respuesta = ?, activo = ? WHERE id = ?");
                $stmt->execute([$comando, $respuesta, $activo, $comando_id]);
                
                registrar_log($_SESSION['usuario_id'], 'COMANDO_TELEGRAM_EDITADO', "Comando ID: $comando_id");
                echo json_encode(['success' => true, 'message' => 'Comando actualizado exitosamente']);
                break;
                
            case 'eliminar_comando':
                $comando_id = $_POST['comando_id'] ?? '';
                
                $stmt = $pdo->prepare("DELETE FROM telegram_comandos WHERE id = ?");
                $stmt->execute([$comando_id]);
                
                registrar_log($_SESSION['usuario_id'], 'COMANDO_TELEGRAM_ELIMINADO', "Comando ID: $comando_id");
                echo json_encode(['success' => true, 'message' => 'Comando eliminado exitosamente']);
                break;
                
            default:
                echo json_encode(['success' => false, 'error' => 'AcciÃ³n no vÃ¡lida']);
        }
    } catch(Exception $e) {
        error_log("Error gestionando comandos: " . $e->getMessage());
        echo json_encode(['success' => false, 'error' => 'Error: ' . $e->getMessage()]);
    }
} else {
    echo json_encode(['success' => false, 'error' => 'MÃ©todo no permitido']);
}
?>
EOF

# Crear script para obtener comandos de Telegram
cat > obtener_comandos_telegram.php << 'EOF'
<?php
require_once 'config.php';
session_start();

if (!isset($_SESSION['usuario_id']) || $_SESSION['rol'] !== 'admin_pro') {
    header('Content-Type: application/json');
    echo json_encode(['error' => 'No autorizado']);
    exit;
}

try {
    $comandos = obtener_comandos_telegram();
    header('Content-Type: application/json');
    echo json_encode(['success' => true, 'comandos' => $comandos]);
} catch(Exception $e) {
    header('Content-Type: application/json');
    echo json_encode(['error' => $e->getMessage()]);
}
?>
EOF

# Crear panel principal COMPLETO con todas las correcciones v2.0.0
cat > panel.php << 'EOF'
<?php
require_once 'config.php';
session_start();

// CORRECCIÃ“N DEFINITIVA: Prevenir que se repitan acciones al recargar
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Verificar token anti-repeticiÃ³n
    if (isset($_SESSION['form_token'])) {
        if (isset($_POST['form_token']) && $_POST['form_token'] === $_SESSION['form_token']) {
            // Token vÃ¡lido, procesar formulario
            unset($_SESSION['form_token']); // Invalidar token usado
        } else {
            // Token invÃ¡lido o ausente, redirigir sin procesar
            $tab_actual = $_POST['tab_actual'] ?? 'dashboard';
            header("Location: panel.php?tab=$tab_actual");
            exit;
        }
    } else {
        // No hay token en sesiÃ³n, posible recarga, redirigir
        $tab_actual = $_POST['tab_actual'] ?? 'dashboard';
        header("Location: panel.php?tab=$tab_actual");
        exit;
    }
}

// Generar nuevo token para el prÃ³ximo formulario
$_SESSION['form_token'] = bin2hex(random_bytes(32));

if (!isset($_SESSION['usuario_id'])) {
    header('Location: index.php');
    exit;
}

$usuario_id = $_SESSION['usuario_id'];
$stmt = $pdo->prepare("SELECT * FROM usuarios WHERE id = ?");
$stmt->execute([$usuario_id]);
$usuario_actual = $stmt->fetch();

// Actualizar tareas vencidas automÃ¡ticamente
actualizar_tareas_vencidas();

// Limpiar tareas antiguas
limpiar_tareas_antiguas();

// Obtener alerta activa de montacarga si existe
$alerta_montacarga = null;
if ($usuario_actual['rol'] === 'empleado') {
    $stmt_alerta = $pdo->prepare("SELECT * FROM alertas_montacarga WHERE empleado_id = ? AND activa = TRUE AND completada = FALSE LIMIT 1");
    $stmt_alerta->execute([$usuario_id]);
    $alerta_montacarga = $stmt_alerta->fetch();
}

// Determinar pestaÃ±a actual
$tab_actual = $_GET['tab'] ?? 'dashboard';

// Procesar acciones
$mensaje = '';
$tipo_mensaje = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $accion = $_POST['accion'] ?? '';
    $tab_actual = $_POST['tab_actual'] ?? $tab_actual;
    
    switch ($accion) {
        case 'crear_usuario':
            if (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])) {
                $username = $_POST['username'] ?? '';
                $password = $_POST['password'] ?? '';
                $nombre = $_POST['nombre'] ?? '';
                $rol = $_POST['rol'] ?? 'empleado';
                $telegram_id = $_POST['telegram_id'] ?? '';
                
                // Validar que el usuario no exista
                $stmt_check = $pdo->prepare("SELECT id FROM usuarios WHERE username = ?");
                $stmt_check->execute([$username]);
                if ($stmt_check->fetch()) {
                    $mensaje = 'El nombre de usuario ya existe';
                    $tipo_mensaje = 'error';
                    break;
                }
                
                // Validar contraseÃ±a
                if (strlen($password) < 6) {
                    $mensaje = 'La contraseÃ±a debe tener al menos 6 caracteres';
                    $tipo_mensaje = 'error';
                    break;
                }
                
                $password_hash = password_hash($password, PASSWORD_DEFAULT);
                
                // Solo empleados tienen turno y pasillo
                $turno = $rol === 'empleado' ? ($_POST['turno'] ?? 'AM') : NULL;
                $pasillo = $rol === 'empleado' ? ($_POST['pasillo'] ?? '') : NULL;
                $dia_libre = $rol === 'empleado' ? ($_POST['dia_libre'] ?? '') : NULL;
                
                try {
                    $stmt = $pdo->prepare("INSERT INTO usuarios (username, password, nombre, rol, telegram_id, turno, pasillo_asignado, dia_libre, creado_por) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)");
                    $stmt->execute([$username, $password_hash, $nombre, $rol, $telegram_id, $turno, $pasillo, $dia_libre, $usuario_id]);
                    
                    $mensaje = 'Usuario creado exitosamente';
                    $tipo_mensaje = 'success';
                    registrar_log($usuario_id, 'USUARIO_CREADO', "Usuario: $username, Rol: $rol");
                } catch(Exception $e) {
                    $mensaje = 'Error al crear usuario: ' . $e->getMessage();
                    $tipo_mensaje = 'error';
                }
            }
            break;
            
        case 'editar_usuario':
            $user_id = $_POST['user_id'] ?? '';
            $nombre = $_POST['nombre'] ?? '';
            $telegram_id = $_POST['telegram_id'] ?? '';
            
            try {
                // Si es admin puede editar cualquier usuario, si es empleado solo puede editar su propio perfil
                if ($usuario_actual['rol'] === 'empleado' && $user_id != $usuario_id) {
                    $mensaje = 'No tienes permisos para editar este usuario';
                    $tipo_mensaje = 'error';
                } else {
                    if (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])) {
                        $rol = $_POST['rol'] ?? '';
                        $turno = $rol === 'empleado' ? ($_POST['turno'] ?? '') : NULL;
                        $pasillo = $rol === 'empleado' ? ($_POST['pasillo'] ?? '') : NULL;
                        $dia_libre = $rol === 'empleado' ? ($_POST['dia_libre'] ?? '') : NULL;
                        
                        $stmt = $pdo->prepare("UPDATE usuarios SET nombre = ?, rol = ?, telegram_id = ?, turno = ?, pasillo_asignado = ?, dia_libre = ? WHERE id = ?");
                        $stmt->execute([$nombre, $rol, $telegram_id, $turno, $pasillo, $dia_libre, $user_id]);
                    } else {
                        // Empleados solo pueden cambiar telegram_id
                        $stmt = $pdo->prepare("UPDATE usuarios SET telegram_id = ? WHERE id = ?");
                        $stmt->execute([$telegram_id, $user_id]);
                    }
                    
                    $mensaje = 'Usuario actualizado exitosamente';
                    $tipo_mensaje = 'success';
                    registrar_log($usuario_id, 'USUARIO_EDITADO', "Usuario ID: $user_id");
                }
            } catch(Exception $e) {
                $mensaje = 'Error al editar usuario: ' . $e->getMessage();
                $tipo_mensaje = 'error';
            }
            break;
            
        case 'eliminar_usuario':
            if (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])) {
                $user_id = $_POST['user_id'] ?? '';
                
                try {
                    // No permitir eliminar al propio usuario o admin_pro
                    if ($user_id == $usuario_id) {
                        $mensaje = 'No puedes eliminar tu propio usuario';
                        $tipo_mensaje = 'error';
                    } else {
                        $stmt = $pdo->prepare("SELECT rol FROM usuarios WHERE id = ?");
                        $stmt->execute([$user_id]);
                        $user = $stmt->fetch();
                        
                        if ($user && $user['rol'] === 'admin_pro' && $usuario_actual['rol'] !== 'admin_pro') {
                            $mensaje = 'No tienes permisos para eliminar un administrador pro';
                            $tipo_mensaje = 'error';
                        } else {
                            $stmt = $pdo->prepare("UPDATE usuarios SET activo = FALSE WHERE id = ?");
                            $stmt->execute([$user_id]);
                            
                            $mensaje = 'Usuario eliminado exitosamente';
                            $tipo_mensaje = 'success';
                            registrar_log($usuario_id, 'USUARIO_ELIMINADO', "Usuario ID: $user_id");
                        }
                    }
                } catch(Exception $e) {
                    $mensaje = 'Error al eliminar usuario: ' . $e->getMessage();
                    $tipo_mensaje = 'error';
                }
            }
            break;
            
        case 'cambiar_password':
            $user_id = $_POST['user_id'] ?? '';
            $nueva_password = $_POST['nueva_password'] ?? '';
            
            try {
                // Si es admin puede cambiar cualquier password, si es empleado solo puede cambiar la suya
                if ($usuario_actual['rol'] === 'empleado' && $user_id != $usuario_id) {
                    $mensaje = 'No tienes permisos para cambiar esta contraseÃ±a';
                    $tipo_mensaje = 'error';
                } else {
                    if (strlen($nueva_password) < 6) {
                        $mensaje = 'La contraseÃ±a debe tener al menos 6 caracteres';
                        $tipo_mensaje = 'error';
                        break;
                    }
                    
                    $password_hash = password_hash($nueva_password, PASSWORD_DEFAULT);
                    $stmt = $pdo->prepare("UPDATE usuarios SET password = ? WHERE id = ?");
                    $stmt->execute([$password_hash, $user_id]);
                    
                    $mensaje = 'ContraseÃ±a actualizada exitosamente';
                    $tipo_mensaje = 'success';
                    registrar_log($usuario_id, 'PASSWORD_CAMBIADA', "Usuario ID: $user_id");
                }
            } catch(Exception $e) {
                $mensaje = 'Error al cambiar contraseÃ±a: ' . $e->getMessage();
                $tipo_mensaje = 'error';
            }
            break;
            
        case 'asignar_tarea':
            if (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])) {
                $empleados_ids = $_POST['empleados_ids'] ?? [];
                $titulo = $_POST['titulo'] ?? '';
                $descripcion = $_POST['descripcion'] ?? '';
                $fecha_vencimiento = $_POST['fecha_vencimiento'] ?? '';
                $requiere_foto = isset($_POST['requiere_foto']) ? 1 : 0;
                $notificar_telegram = isset($_POST['notificar_telegram']) ? 1 : 0;
                
                // CORRECCIÃ“N: Validar que se hayan seleccionado empleados
                if (empty($empleados_ids)) {
                    $mensaje = 'Debe seleccionar al menos un empleado';
                    $tipo_mensaje = 'error';
                    break;
                }
                
                // Validar campos requeridos
                if (empty($titulo) || empty($descripcion)) {
                    $mensaje = 'El tÃ­tulo y descripciÃ³n son obligatorios';
                    $tipo_mensaje = 'error';
                    break;
                }
                
                try {
                    // CORRECCIÃ“N: Usar funciÃ³n de asignaciÃ³n mÃºltiple
                    $resultado = asignar_tarea_multiple($empleados_ids, $titulo, $descripcion, $usuario_id, $fecha_vencimiento, $requiere_foto, $notificar_telegram);
                    
                    if ($resultado['success']) {
                        $mensaje = 'Tarea asignada a ' . $resultado['total_empleados'] . ' empleados exitosamente';
                        $tipo_mensaje = 'success';
                        registrar_log($usuario_id, 'TAREA_ASIGNADA_MULTIPLE', "Tarea: $titulo, Empleados: " . count($empleados_ids));
                    } else {
                        $mensaje = 'Error al asignar tarea: ' . $resultado['error'];
                        $tipo_mensaje = 'error';
                    }
                } catch(Exception $e) {
                    $mensaje = 'Error al asignar tarea: ' . $e->getMessage();
                    $tipo_mensaje = 'error';
                }
            }
            break;
            
        case 'completar_tarea_sin_foto':
            $tarea_id = $_POST['tarea_id'] ?? '';
            
            try {
                // Verificar que la tarea pertenece al empleado
                $stmt = $pdo->prepare("SELECT * FROM tareas WHERE id = ? AND empleado_id = ?");
                $stmt->execute([$tarea_id, $usuario_id]);
                $tarea = $stmt->fetch();
                
                if ($tarea) {
                    // Notificar al administrador
                    $stmt_admin = $pdo->prepare("SELECT nombre, telegram_id FROM usuarios WHERE id = ?");
                    $stmt_admin->execute([$tarea['administrador_id']]);
                    $admin = $stmt_admin->fetch();
                    
                    $fecha_completado = obtenerFechaHoraActual()->format('d/m/Y H:i:s');
                    $mensaje_telegram = "âœ… <b>TAREA COMPLETADA</b>\n\n";
                    $mensaje_telegram .= "ğŸ‘¤ <b>Empleado:</b> " . $usuario_actual['nombre'] . "\n";
                    $mensaje_telegram .= "ğŸ“ <b>Tarea:</b> " . $tarea['titulo'] . "\n";
                    $mensaje_telegram .= "â° <b>Completada:</b> " . $fecha_completado;
                    
                    if ($admin && !empty($admin['telegram_id'])) {
                        enviar_telegram($admin['telegram_id'], $mensaje_telegram);
                    }
                    
                    if (!empty($telegram_config['chat_id'])) {
                        enviar_telegram($telegram_config['chat_id'], $mensaje_telegram);
                    }
                    
                    $fecha_completado_sql = obtenerFechaHoraActual()->format('Y-m-d H:i:s');
                    $stmt = $pdo->prepare("UPDATE tareas SET estado = 'completada', fecha_completado = ? WHERE id = ?");
                    $stmt->execute([$fecha_completado_sql, $tarea_id]);
                    
                    $mensaje = 'Tarea completada exitosamente';
                    $tipo_mensaje = 'success';
                    registrar_log($usuario_id, 'TAREA_COMPLETADA', "Tarea ID: $tarea_id");
                } else {
                    $mensaje = 'Tarea no encontrada';
                    $tipo_mensaje = 'error';
                }
            } catch(Exception $e) {
                $mensaje = 'Error al completar tarea: ' . $e->getMessage();
                $tipo_mensaje = 'error';
            }
            break;
            
        case 'verificar_tarea':
            if (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])) {
                $tarea_id = $_POST['tarea_id'] ?? '';
                $calificacion = $_POST['calificacion'] ?? '';
                $comentario = $_POST['comentario'] ?? '';
                
                try {
                    // Obtener informaciÃ³n de la tarea antes de actualizar
                    $stmt_tarea = $pdo->prepare("SELECT t.*, u.nombre as empleado_nombre, u.telegram_id as empleado_telegram FROM tareas t JOIN usuarios u ON t.empleado_id = u.id WHERE t.id = ?");
                    $stmt_tarea->execute([$tarea_id]);
                    $tarea = $stmt_tarea->fetch();
                    
                    if ($tarea) {
                        $stmt = $pdo->prepare("UPDATE tareas SET estado = 'verificada', calificacion = ?, comentario_revision = ? WHERE id = ?");
                        $stmt->execute([$calificacion, $comentario, $tarea_id]);
                        
                        // Notificar al empleado sobre la verificaciÃ³n
                        if (!empty($tarea['empleado_telegram'])) {
                            $mensaje_telegram = "â­ <b>TAREA VERIFICADA</b>\n\n";
                            $mensaje_telegram .= "ğŸ‘¤ <b>Empleado:</b> " . $tarea['empleado_nombre'] . "\n";
                            $mensaje_telegram .= "ğŸ“ <b>Tarea:</b> " . $tarea['titulo'] . "\n";
                            $mensaje_telegram .= "â­ <b>CalificaciÃ³n:</b> " . str_repeat('â˜…', $calificacion) . "\n";
                            
                            if (!empty($comentario)) {
                                $mensaje_telegram .= "ğŸ’¬ <b>Comentario:</b> " . $comentario . "\n";
                            }
                            
                            $mensaje_telegram .= "âœ… <b>Estado:</b> Verificada y finalizada";
                            
                            enviar_telegram($tarea['empleado_telegram'], $mensaje_telegram);
                        }
                        
                        $mensaje = 'Tarea verificada exitosamente';
                        $tipo_mensaje = 'success';
                        registrar_log($usuario_id, 'TAREA_VERIFICADA', "Tarea ID: $tarea_id, CalificaciÃ³n: $calificacion");
                    }
                } catch(Exception $e) {
                    $mensaje = 'Error al verificar tarea: ' . $e->getMessage();
                    $tipo_mensaje = 'error';
                }
            }
            break;
            
        case 'reabrir_tarea':
            if (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])) {
                $tarea_id = $_POST['tarea_id'] ?? '';
                
                try {
                    // Verificar si la tarea puede reabrirse
                    if (!tarea_puede_reabrirse($tarea_id)) {
                        $mensaje = 'La tarea no puede reabrirse aÃºn. Debe esperar al menos ' . $tiempo_reabrir_tarea . ' minutos despuÃ©s de vencer.';
                        $tipo_mensaje = 'error';
                        break;
                    }
                    
                    $fecha_vencimiento_nueva = obtenerFechaHoraActual();
                    $fecha_vencimiento_nueva->modify('+1 day');
                    
                    $stmt = $pdo->prepare("UPDATE tareas SET estado = 'pendiente', fecha_vencimiento = ? WHERE id = ?");
                    $stmt->execute([$fecha_vencimiento_nueva->format('Y-m-d H:i:s'), $tarea_id]);
                    
                    if ($stmt->rowCount() > 0) {
                        registrar_log($usuario_id, 'TAREA_REABIERTA', "Tarea ID: $tarea_id");
                        $mensaje = 'Tarea reabierta exitosamente';
                        $tipo_mensaje = 'success';
                    } else {
                        $mensaje = 'Error al reabrir tarea';
                        $tipo_mensaje = 'error';
                    }
                } catch(Exception $e) {
                    $mensaje = 'Error al reabrir tarea: ' . $e->getMessage();
                    $tipo_mensaje = 'error';
                }
            }
            break;
            
        case 'configurar_sistema':
            if (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])) {
                $telegram_token = $_POST['telegram_token'] ?? '';
                $telegram_chat_id = $_POST['telegram_chat_id'] ?? '';
                $hora_montacarga_am = $_POST['hora_montacarga_am'] ?? '';
                $hora_montacarga_pm = $_POST['hora_montacarga_pm'] ?? '';
                $hora_backup = $_POST['hora_backup'] ?? '';
                $nombre_sistema = $_POST['nombre_sistema'] ?? '';
                $backup_automatico = isset($_POST['backup_automatico']) ? 1 : 0;
                $tareas_automaticas = isset($_POST['tareas_automaticas']) ? 1 : 0;
                $privacidad_tareas = isset($_POST['privacidad_tareas']) ? 1 : 0;
                $calidad_fotos = $_POST['calidad_fotos'] ?? '85';
                $max_fotos_tarea = $_POST['max_fotos_tarea'] ?? '3';
                $limpiar_tareas_24h = isset($_POST['limpiar_tareas_24h']) ? 1 : 0;
                $tiempo_reabrir_tarea = $_POST['tiempo_reabrir_tarea'] ?? '30';
                
                try {
                    // Actualizar configuraciones
                    $configs = [
                        'telegram_token' => $telegram_token,
                        'telegram_chat_id' => $telegram_chat_id,
                        'hora_montacarga_am' => $hora_montacarga_am,
                        'hora_montacarga_pm' => $hora_montacarga_pm,
                        'hora_backup' => $hora_backup,
                        'nombre_sistema' => $nombre_sistema,
                        'backup_automatico' => $backup_automatico,
                        'tareas_automaticas' => $tareas_automaticas,
                        'privacidad_tareas' => $privacidad_tareas,
                        'calidad_fotos' => $calidad_fotos,
                        'max_fotos_tarea' => $max_fotos_tarea,
                        'limpiar_tareas_24h' => $limpiar_tareas_24h,
                        'tiempo_reabrir_tarea' => $tiempo_reabrir_tarea
                    ];
                    
                    foreach ($configs as $clave => $valor) {
                        $stmt = $pdo->prepare("INSERT INTO configuraciones (clave, valor) VALUES (?, ?) ON DUPLICATE KEY UPDATE valor = ?");
                        $stmt->execute([$clave, $valor, $valor]);
                    }
                    
                    $mensaje = 'ConfiguraciÃ³n actualizada exitosamente';
                    $tipo_mensaje = 'success';
                    registrar_log($usuario_id, 'CONFIGURACION_ACTUALIZADA', "Configuraciones del sistema");
                } catch(Exception $e) {
                    $mensaje = 'Error al actualizar configuraciÃ³n: ' . $e->getMessage();
                    $tipo_mensaje = 'error';
                }
            }
            break;
            
        case 'generar_backup':
            if (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])) {
                $resultado = generar_backup($usuario_id);
                
                if ($resultado['success']) {
                    $mensaje = 'Backup generado exitosamente';
                    $tipo_mensaje = 'success';
                    
                    // Guardar informaciÃ³n del backup para mostrar modal de descarga
                    $_SESSION['backup_generado'] = $resultado;
                } else {
                    $mensaje = 'Error al generar backup: ' . $resultado['error'];
                    $tipo_mensaje = 'error';
                }
            }
            break;
            
        case 'asignar_patana':
            if (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])) {
                $empleado_id = $_POST['empleado_patana'] ?? '';
                $pasillo = $_POST['pasillo_patana'] ?? '';
                
                try {
                    $titulo = "Cubrir Patana - Pasillo " . $pasillo;
                    $descripcion = "Cubrir la patana del pasillo " . $pasillo . " por empleado ausente";
                    $fecha_asignacion = obtenerFechaHoraActual()->format('Y-m-d H:i:s');
                    
                    $stmt = $pdo->prepare("INSERT INTO tareas (titulo, descripcion, empleado_id, administrador_id, pasillo_area, tipo_tarea, notificar_telegram, fecha_asignacion) VALUES (?, ?, ?, ?, ?, 'pasillo', TRUE, ?)");
                    $stmt->execute([$titulo, $descripcion, $empleado_id, $usuario_id, $pasillo, $fecha_asignacion]);
                    
                    $mensaje = 'Patana asignada exitosamente al empleado';
                    $tipo_mensaje = 'success';
                    registrar_log($usuario_id, 'PATANA_ASIGNADA', "Empleado ID: $empleado_id, Pasillo: $pasillo");
                } catch(Exception $e) {
                    $mensaje = 'Error al asignar patana: ' . $e->getMessage();
                    $tipo_mensaje = 'error';
                }
            }
            break;
            
        case 'asignar_montacarga':
            if (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])) {
                $turno = $_POST['turno_montacarga'] ?? '';
                $hora_tarea = $_POST['hora_montacarga'] ?? '';
                
                $resultado = asignar_alertas_montacarga($turno, $hora_tarea);
                
                if ($resultado['success']) {
                    $mensaje = 'Alertas de montacarga asignadas exitosamente para el turno ' . $turno;
                    $tipo_mensaje = 'success';
                } else {
                    $mensaje = 'Error al asignar alertas de montacarga: ' . $resultado['error'];
                    $tipo_mensaje = 'error';
                }
            }
            break;
            
        case 'completar_alerta_montacarga':
            $alerta_id = $_POST['alerta_id'] ?? '';
            
            try {
                $fecha_completado = obtenerFechaHoraActual()->format('Y-m-d H:i:s');
                $stmt = $pdo->prepare("UPDATE alertas_montacarga SET activa = FALSE, completada = TRUE, fecha_completado = ? WHERE id = ? AND empleado_id = ?");
                $stmt->execute([$fecha_completado, $alerta_id, $usuario_id]);
                
                if ($stmt->rowCount() > 0) {
                    $mensaje = 'Alerta de montacarga marcada como completada';
                    $tipo_mensaje = 'success';
                    registrar_log($usuario_id, 'ALERTA_MONTACARGA_COMPLETADA', "Alerta ID: $alerta_id");
                } else {
                    $mensaje = 'Error al completar la alerta';
                    $tipo_mensaje = 'error';
                }
            } catch(Exception $e) {
                $mensaje = 'Error al completar alerta: ' . $e->getMessage();
                $tipo_mensaje = 'error';
            }
            break;
    }
}

// Obtener estadÃ­sticas CORREGIDAS - USANDO FUNCIÃ“N NUEVA
if ($usuario_actual['rol'] === 'empleado') {
    $tareas_pendientes = $pdo->query("SELECT COUNT(*) FROM tareas WHERE empleado_id = $usuario_id AND estado = 'pendiente'")->fetchColumn();
    $tareas_completadas = $pdo->query("SELECT COUNT(*) FROM tareas WHERE empleado_id = $usuario_id AND estado = 'completada'")->fetchColumn();
    $tareas_vencidas = obtener_tareas_vencidas_empleado($usuario_id);
    
    // Obtener estadÃ­sticas del empleado actual
    $empleados_turno_actual = obtener_estadisticas_turno($usuario_actual['turno']);
} else {
    // USAR FUNCIÃ“N CORREGIDA PARA ESTADÃSTICAS CON PRIVACIDAD
    $estadisticas_tareas = obtener_estadisticas_tareas_por_administrador($usuario_id, $usuario_actual['rol']);
    $tareas_pendientes = $estadisticas_tareas['pendientes'];
    $tareas_completadas = $estadisticas_tareas['completadas'];
    $tareas_vencidas = $estadisticas_tareas['vencidas'];
    
    // Obtener estadÃ­sticas por turno
    $empleados_am = obtener_estadisticas_turno('AM');
    $empleados_pm = obtener_estadisticas_turno('PM');
    $total_empleados = $empleados_am + $empleados_pm;
    
    // Obtener empleados libres hoy
    $empleados_libres_count = 0;
    $empleados_trabajando = $pdo->query("SELECT * FROM usuarios WHERE activo = TRUE AND rol = 'empleado'")->fetchAll();
    foreach ($empleados_trabajando as $emp) {
        if (empleado_esta_libre_hoy($emp)) {
            $empleados_libres_count++;
        }
    }
}

// Obtener empleados (para administradores)
$empleados = [];
if (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])) {
    $empleados = $pdo->query("SELECT * FROM usuarios WHERE activo = TRUE ORDER BY nombre")->fetchAll();
}

// Obtener tareas del usuario
if ($usuario_actual['rol'] === 'empleado') {
    $tareas = $pdo->prepare("SELECT t.*, u.nombre as admin_nombre FROM tareas t LEFT JOIN usuarios u ON t.administrador_id = u.id WHERE t.empleado_id = ? ORDER BY t.fecha_asignacion DESC");
    $tareas->execute([$usuario_id]);
    $tareas = $tareas->fetchAll();
}

// Obtener todas las tareas para administradores (segÃºn su rol)
$todas_tareas = [];
if (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])) {
    $todas_tareas = obtener_tareas_por_administrador($usuario_id, $usuario_actual['rol']);
}

// Obtener configuraciones actuales
$stmt_config = $pdo->query("SELECT clave, valor FROM configuraciones");
$configuraciones = $stmt_config->fetchAll(PDO::FETCH_KEY_PAIR);

// Obtener recomendaciones de patanas COMPLETAMENTE CORREGIDAS
$recomendaciones_patanas = [];
if (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])) {
    $recomendaciones_patanas = obtener_recomendaciones_patanas();
}

// Obtener comandos de Telegram
$comandos_telegram = [];
if ($usuario_actual['rol'] === 'admin_pro') {
    $comandos_telegram = obtener_comandos_telegram();
}

// Determinar turno actual para mostrar
$fecha_actual = obtenerFechaHoraActual();
$turno_actual = $fecha_actual->format('H') < 12 ? 'AM' : 'PM';
$dias_semana = ['Domingo', 'Lunes', 'Martes', 'MiÃ©rcoles', 'Jueves', 'Viernes', 'SÃ¡bado'];
$dia_actual = $dias_semana[$fecha_actual->format('w')];
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel - <?php echo htmlspecialchars($nombre_sistema); ?></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #007AFF;
            --color-primary-dark: #0056CC;
            --color-bg-dark: #000000;
            --color-card-bg: rgba(17, 24, 39, 0.8);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1e3a8a 100%);
            color: #e5e7eb;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .liquid-glass {
            backdrop-filter: blur(40px) saturate(200%);
            -webkit-backdrop-filter: blur(40px) saturate(200%);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .liquid-card {
            background: linear-gradient(135deg, rgba(17, 24, 39, 0.9) 0%, rgba(30, 41, 59, 0.7) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.05);
        }
        
        .progress-bar-fill {
            transition: width 1s ease-in-out;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 50;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        
        .rating-star {
            font-size: 24px;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .rating-star.active {
            color: #f59e0b;
        }
        
        .rating-star:hover {
            color: #f59e0b;
        }

        /* Estilos responsivos mejorados */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .table-responsive table {
            min-width: 600px;
        }
        
        @media (max-width: 768px) {
            .table-responsive table {
                min-width: 100%;
                font-size: 0.875rem;
            }
            
            .table-responsive th,
            .table-responsive td {
                padding: 0.5rem;
            }
        }

        /* Estilo iOS 26 Liquid Glass mejorado */
        .ios-nav-item {
            transition: all 0.3s ease;
            border-radius: 12px;
            margin: 2px 0;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .ios-nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        
        .ios-nav-item:hover::before {
            left: 100%;
        }
        
        .ios-nav-item.active {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.3) 0%, rgba(0, 86, 204, 0.2) 100%);
            border-left: 3px solid #007AFF;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .ios-nav-item:hover:not(.active) {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }
        
        .btn-liquid {
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
            border: none;
            box-shadow: 
                0 4px 15px rgba(0, 122, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .btn-liquid:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(0, 122, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .btn-liquid:active {
            transform: translateY(0);
        }
        
        .input-glass {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .input-glass:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(0, 122, 255, 0.5);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        /* Efectos de partÃ­culas */
        .floating-element {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        /* Colores mejorados para el menÃº */
        .nav-dashboard { color: #3B82F6; }
        .nav-users { color: #10B981; }
        .nav-tasks { color: #F59E0B; }
        .nav-view-tasks { color: #8B5CF6; }
        .nav-montacarga { color: #EF4444; }
        .nav-profile { color: #06B6D4; }
        .nav-config { color: #F97316; }
        .nav-telegram { color: #0088cc; }

        /* Estilos para cÃ¡mara mejorada */
        .camera-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .camera-preview {
            width: 100%;
            height: 300px;
            background: #1f2937;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .captured-photos {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .captured-photo {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #3B82F6;
        }
        
        .photo-counter {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #3B82F6;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* CategorÃ­as de tareas */
        .categoria-tareas {
            margin-bottom: 2rem;
        }
        
        .categoria-header {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(147, 51, 234, 0.2) 100%);
            border-left: 4px solid #3B82F6;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .tarea-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .tarea-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }
        
        .tarea-pendiente { border-left-color: #F59E0B; }
        .tarea-completada { border-left-color: #10B981; }
        .tarea-vencida { border-left-color: #EF4444; }
        .tarea-verificada { border-left-color: #8B5CF6; }
    </style>
</head>
<body class="min-h-screen antialiased flex overflow-x-hidden">

    <!-- Sidebar (MenÃº Lateral) -->
    <nav id="sidebar" class="fixed z-40 inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out w-64 p-4 lg:p-6 liquid-glass flex flex-col justify-between">
        <!-- Logo y TÃ­tulo -->
        <div>
            <div class="text-2xl font-bold text-white mb-8 flex items-center">
                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3 liquid-glass">
                    <i class="fas fa-users-cog text-white text-sm"></i>
                </div>
                <span class="tracking-wider bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent"><?php echo htmlspecialchars($nombre_sistema); ?></span>
            </div>

            <!-- Enlaces de NavegaciÃ³n - REORGANIZADO Y MEJORADO -->
            <ul class="space-y-1">
                <li>
                    <a href="#" class="ios-nav-item flex items-center p-3 text-white font-medium <?php echo $tab_actual === 'dashboard' ? 'active' : ''; ?>" onclick="mostrarTab('dashboard')">
                        <i class="fas fa-chart-line w-5 h-5 mr-3 nav-dashboard"></i>
                        Dashboard
                    </a>
                </li>
                <?php if (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])): ?>
                    <li>
                        <a href="#" class="ios-nav-item flex items-center p-3 text-gray-300 font-medium <?php echo $tab_actual === 'gestion-usuarios' ? 'active' : ''; ?>" onclick="mostrarTab('gestion-usuarios')">
                            <i class="fas fa-users w-5 h-5 mr-3 nav-users"></i>
                            GestiÃ³n de Usuarios
                        </a>
                    </li>
                    <li>
                        <a href="#" class="ios-nav-item flex items-center p-3 text-gray-300 font-medium <?php echo $tab_actual === 'asignar-tareas' ? 'active' : ''; ?>" onclick="mostrarTab('asignar-tareas')">
                            <i class="fas fa-tasks w-5 h-5 mr-3 nav-tasks"></i>
                            Asignar Tareas
                        </a>
                    </li>
                    <li>
                        <a href="#" class="ios-nav-item flex items-center p-3 text-gray-300 font-medium <?php echo $tab_actual === 'ver-tareas' ? 'active' : ''; ?>" onclick="mostrarTab('ver-tareas')">
                            <i class="fas fa-list-check w-5 h-5 mr-3 nav-view-tasks"></i>
                            Todas las Tareas
                        </a>
                    </li>
                    <li>
                        <a href="#" class="ios-nav-item flex items-center p-3 text-gray-300 font-medium <?php echo $tab_actual === 'montacarga' ? 'active' : ''; ?>" onclick="mostrarTab('montacarga')">
                            <i class="fas fa-truck-loading w-5 h-5 mr-3 nav-montacarga"></i>
                            Montacarga
                        </a>
                    </li>
                <?php endif; ?>
                <?php if ($usuario_actual['rol'] === 'empleado'): ?>
                    <li>
                        <a href="#" class="ios-nav-item flex items-center p-3 text-gray-300 font-medium <?php echo $tab_actual === 'mis-tareas' ? 'active' : ''; ?>" onclick="mostrarTab('mis-tareas')">
                            <i class="fas fa-list-check w-5 h-5 mr-3 nav-view-tasks"></i>
                            Mis Tareas
                        </a>
                    </li>
                <?php endif; ?>
                <li>
                    <a href="#" class="ios-nav-item flex items-center p-3 text-gray-300 font-medium <?php echo $tab_actual === 'mi-perfil' ? 'active' : ''; ?>" onclick="mostrarTab('mi-perfil')">
                        <i class="fas fa-user-edit w-5 h-5 mr-3 nav-profile"></i>
                        Mi Perfil
                    </a>
                </li>
                <?php if ($usuario_actual['rol'] === 'admin_pro'): ?>
                    <li>
                        <a href="#" class="ios-nav-item flex items-center p-3 text-gray-300 font-medium <?php echo $tab_actual === 'configuracion' ? 'active' : ''; ?>" onclick="mostrarTab('configuracion')">
                            <i class="fas fa-cog w-5 h-5 mr-3 nav-config"></i>
                            ConfiguraciÃ³n
                        </a>
                    </li>
                    <li>
                        <a href="#" class="ios-nav-item flex items-center p-3 text-gray-300 font-medium <?php echo $tab_actual === 'comandos-telegram' ? 'active' : ''; ?>" onclick="mostrarTab('comandos-telegram')">
                            <i class="fab fa-telegram w-5 h-5 mr-3 nav-telegram"></i>
                            Comandos Telegram
                        </a>
                    </li>
                <?php endif; ?>
            </ul>
        </div>

        <!-- SecciÃ³n Inferior (Perfil/Salir) -->
        <div class="pt-4 border-t border-gray-700/30">
            <div class="flex items-center p-3 text-gray-300 liquid-glass rounded-xl mb-3">
                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center mr-3 liquid-glass">
                    <i class="fas fa-user text-white text-sm"></i>
                </div>
                <div>
                    <div class="text-sm font-medium"><?php echo htmlspecialchars($usuario_actual['nombre']); ?></div>
                    <div class="text-xs text-gray-400"><?php echo htmlspecialchars(ucfirst($usuario_actual['rol'])); ?></div>
                </div>
            </div>
            <a href="logout.php" class="ios-nav-item flex items-center p-3 text-red-400 font-medium hover:bg-red-900/30 rounded-xl">
                <i class="fas fa-sign-out-alt mr-3"></i>
                Cerrar SesiÃ³n
            </a>
        </div>
    </nav>

    <!-- Overlay para el menÃº lateral en mÃ³vil -->
    <div id="sidebar-overlay" class="fixed inset-0 z-30 bg-black opacity-0 transition-opacity duration-300 lg:hidden pointer-events-none" onclick="toggleSidebar()"></div>

    <!-- Contenido Principal -->
    <main class="flex-1 lg:ml-64 p-4 sm:p-6 md:p-8">
        <!-- Barra Superior -->
        <header class="flex justify-between items-center mb-6 lg:mb-8">
            <h1 class="text-2xl font-bold text-white tracking-tight" id="page-title">
                <?php 
                $titulos = [
                    'dashboard' => 'Dashboard Principal',
                    'gestion-usuarios' => 'GestiÃ³n de Usuarios',
                    'asignar-tareas' => 'Asignar Tareas',
                    'ver-tareas' => 'Todas las Tareas',
                    'montacarga' => 'Montacarga',
                    'mis-tareas' => 'Mis Tareas',
                    'mi-perfil' => 'Mi Perfil',
                    'configuracion' => 'ConfiguraciÃ³n',
                    'comandos-telegram' => 'Comandos Telegram'
                ];
                echo $titulos[$tab_actual] ?? 'Dashboard Principal';
                ?>
            </h1>
            <!-- BotÃ³n de MenÃº para mÃ³vil -->
            <button id="menu-button" class="lg:hidden text-white p-2 rounded-xl liquid-glass transition duration-200 hover:bg-gray-700 focus:outline-none" onclick="toggleSidebar()">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </header>

        <!-- Mensajes del sistema -->
        <?php if ($mensaje): ?>
            <div class="liquid-card rounded-2xl p-4 mb-6 <?php echo $tipo_mensaje === 'success' ? 'bg-green-900/30 border-green-700 text-green-200' : ($tipo_mensaje === 'warning' ? 'bg-yellow-900/30 border-yellow-700 text-yellow-200' : 'bg-red-900/30 border-red-700 text-red-200'); ?> border">
                <div class="flex items-center">
                    <i class="fas <?php echo $tipo_mensaje === 'success' ? 'fa-check-circle' : ($tipo_mensaje === 'warning' ? 'fa-exclamation-triangle' : 'fa-exclamation-circle'); ?> mr-3"></i>
                    <div><?php echo $mensaje; ?></div>
                </div>
            </div>
        <?php endif; ?>

        <!-- Modal de descarga de backup -->
        <?php if (isset($_SESSION['backup_generado']) && $_SESSION['backup_generado']['success']): ?>
            <div id="modalBackup" class="modal" style="display: flex;">
                <div class="liquid-card rounded-2xl p-6 m-4 max-w-md w-full">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-white">Backup Generado</h3>
                        <button class="text-gray-400 hover:text-white text-2xl" onclick="cerrarModal('modalBackup')">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center text-green-400">
                            <i class="fas fa-check-circle text-2xl mr-3"></i>
                            <span class="text-lg">Backup generado exitosamente</span>
                        </div>
                        <div class="space-y-2 text-gray-300">
                            <p><strong>Archivo:</strong> <?php echo $_SESSION['backup_generado']['nombre']; ?></p>
                            <p><strong>TamaÃ±o:</strong> <?php echo round($_SESSION['backup_generado']['tamano']/1024/1024, 2); ?> MB</p>
                            <p><strong>Fecha:</strong> <?php echo date('d/m/Y H:i:s'); ?></p>
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button onclick="descargarBackup('<?php echo $_SESSION['backup_generado']['nombre']; ?>')" class="flex-1 btn-liquid text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center">
                                <i class="fas fa-download mr-2"></i> Descargar
                            </button>
                            <button onclick="cerrarModal('modalBackup')" class="flex-1 bg-gray-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-gray-500/30 hover:bg-gray-700 active:scale-[0.98] transition duration-300 flex items-center justify-center">
                                <i class="fas fa-times mr-2"></i> Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <?php unset($_SESSION['backup_generado']); ?>
        <?php endif; ?>

        <!-- Alerta de Montacarga -->
        <?php if ($alerta_montacarga): ?>
            <div class="liquid-card rounded-2xl p-6 mb-6 bg-gradient-to-r from-amber-900/30 to-orange-900/30 border border-amber-700/50">
                <div class="flex items-center mb-4">
                    <i class="fas fa-truck-loading text-2xl text-amber-400 mr-3"></i>
                    <h3 class="text-xl font-bold text-white">ğŸšœ ALERTA DE MONTACARGA ACTIVA</h3>
                </div>
                <div class="space-y-2 text-gray-200">
                    <p><strong>PosiciÃ³n asignada:</strong> SUPERIOR (ARRIBA)</p>
                    <p><strong>Turno:</strong> <?php echo $alerta_montacarga['turno']; ?></p>
                    <p><strong>Hora de la tarea:</strong> <?php echo $alerta_montacarga['hora_tarea']; ?></p>
                    <p><strong>Tarea:</b> QUEDARSE EN LA POSICIÃ“N SUPERIOR DEL MONTACARGA PARA ENVIAR PATANAS</p>
                </div>
                <div class="mt-4 flex gap-3">
                    <form method="POST">
                        <input type="hidden" name="accion" value="completar_alerta_montacarga">
                        <input type="hidden" name="alerta_id" value="<?php echo $alerta_montacarga['id']; ?>">
                        <input type="hidden" name="tab_actual" value="<?php echo $tab_actual; ?>">
                        <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                        <button type="submit" class="bg-green-600 text-white font-medium py-2 px-4 rounded-xl shadow-lg shadow-green-500/30 hover:bg-green-700 active:scale-[0.98] transition duration-300 flex items-center">
                            <i class="fas fa-check-circle mr-2"></i> Marcar como Completada
                        </button>
                    </form>
                    <button type="button" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-xl shadow-lg shadow-blue-500/30 hover:bg-blue-700 active:scale-[0.98] transition duration-300 flex items-center" onclick="mostrarInstruccionesMontacarga()">
                        <i class="fas fa-info-circle mr-2"></i> Ver Instrucciones
                    </button>
                </div>
            </div>
        <?php endif; ?>

        <!-- Alertas de tareas para empleados -->
        <?php if ($usuario_actual['rol'] === 'empleado' && $tareas_pendientes > 0): ?>
            <div class="liquid-card rounded-2xl p-6 mb-6 bg-gradient-to-r <?php echo $tareas_vencidas > 0 ? 'from-red-900/30 to-pink-900/30 border-red-700/50' : 'from-amber-900/30 to-yellow-900/30 border-amber-700/50'; ?> border">
                <div class="flex items-center mb-4">
                    <i class="fas <?php echo $tareas_vencidas > 0 ? 'fa-exclamation-triangle text-red-400' : 'fa-bell text-amber-400'; ?> text-2xl mr-3"></i>
                    <h3 class="text-xl font-bold text-white"><?php echo $tareas_vencidas > 0 ? 'Â¡TAREAS VENCIDAS!' : 'TAREAS PENDIENTES'; ?></h3>
                </div>
                <div class="text-gray-200">
                    <p>Tienes <strong><?php echo $tareas_pendientes; ?></strong> tareas pendientes<?php echo $tareas_vencidas > 0 ? ', incluyendo ' . $tareas_vencidas . ' vencidas' : ''; ?>.</p>
                    <p>Revisa la secciÃ³n "Mis Tareas" para completarlas.</p>
                </div>
            </div>
        <?php endif; ?>

        <!-- Contenido de las pestaÃ±as -->
        <div class="space-y-6">
            
            <!-- Dashboard -->
            <div id="dashboard" class="tab-content <?php echo $tab_actual === 'dashboard' ? 'active' : ''; ?>">
                <!-- Recomendaciones de patanas -->
                <?php if (in_array($usuario_actual['rol'], ['admin_pro', 'admin']) && !empty($recomendaciones_patanas)): ?>
                    <div class="liquid-card rounded-2xl p-6 mb-6 bg-gradient-to-r from-amber-900/30 to-orange-900/30 border border-amber-700/50">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-lightbulb text-2xl text-amber-400 mr-3"></i>
                            <h3 class="text-xl font-bold text-white">RECOMENDACIÃ“N DEL SISTEMA - COBERTURA DE PATANAS</h3>
                        </div>
                        <p class="text-gray-200 mb-4"><?php echo $recomendaciones_patanas['mensaje']; ?></p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <h4 class="text-white font-semibold mb-2">Pasillos que necesitan cobertura:</h4>
                                <div class="flex flex-wrap gap-2">
                                    <?php foreach ($recomendaciones_patanas['pasillos_sin_cobertura'] as $pasillo): ?>
                                        <span class="bg-amber-900/50 text-amber-200 px-3 py-1 text-sm rounded-full border border-amber-700/50">Pasillo <?php echo $pasillo; ?></span>
                                    <?php endforeach; ?>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-white font-semibold mb-2">Empleados disponibles (Turno <?php echo $recomendaciones_patanas['turno_actual']; ?>):</h4>
                                <ul class="text-gray-200 space-y-1">
                                    <?php foreach ($recomendaciones_patanas['empleados_disponibles'] as $emp): ?>
                                        <li class="flex items-center">
                                            <i class="fas fa-user text-blue-400 mr-2"></i>
                                            <?php echo $emp['nombre']; ?> (<?php echo $emp['turno']; ?>)
                                            <?php if ($emp['pasillo_asignado']): ?>
                                                <span class="ml-2 text-xs bg-gray-700 px-2 py-1 rounded">Pasillo: <?php echo $emp['pasillo_asignado']; ?></span>
                                            <?php endif; ?>
                                        </li>
                                    <?php endforeach; ?>
                                </ul>
                            </div>
                        </div>
                        
                        <form method="POST" class="space-y-4">
                            <input type="hidden" name="accion" value="asignar_patana">
                            <input type="hidden" name="tab_actual" value="dashboard">
                            <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Empleado para cubrir</label>
                                    <select name="empleado_patana" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" required>
                                        <option value="">Seleccionar empleado</option>
                                        <?php foreach ($recomendaciones_patanas['empleados_disponibles'] as $emp): ?>
                                            <option value="<?php echo $emp['id']; ?>"><?php echo $emp['nombre']; ?> (<?php echo $emp['turno']; ?>)</option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Pasillo a cubrir</label>
                                    <select name="pasillo_patana" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" required>
                                        <option value="">Seleccionar pasillo</option>
                                        <?php foreach ($recomendaciones_patanas['pasillos_sin_cobertura'] as $pasillo): ?>
                                            <option value="<?php echo $pasillo; ?>">Pasillo <?php echo $pasillo; ?></option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                            </div>
                            
                            <button type="submit" class="bg-amber-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-amber-500/30 hover:bg-amber-700 active:scale-[0.98] transition duration-300 flex items-center">
                                <i class="fas fa-user-check mr-2"></i> Asignar Patana
                            </button>
                        </form>
                    </div>
                <?php elseif (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])): ?>
                    <div class="liquid-card rounded-2xl p-6 mb-6 bg-gradient-to-r from-green-900/30 to-emerald-900/30 border border-green-700/50">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-2xl text-green-400 mr-3"></i>
                            <div>
                                <h3 class="text-lg font-bold text-white">Estado del Sistema</h3>
                                <p class="text-gray-200">Todos los pasillos estÃ¡n cubiertos correctamente. No se necesitan asignaciones de patanas.</p>
                            </div>
                        </div>
                    </div>
                <?php endif; ?>
                
                <!-- EstadÃ­sticas -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                    <?php if ($usuario_actual['rol'] === 'empleado'): ?>
                        <div class="liquid-card p-6 rounded-2xl cursor-pointer" onclick="mostrarTab('mis-tareas')">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-gray-400 text-sm font-medium uppercase">Mis Tareas Pendientes</h3>
                                <i class="fas fa-tasks text-2xl text-blue-500"></i>
                            </div>
                            <p class="text-4xl font-extrabold text-white mb-2" id="stat-1"><?php echo $tareas_pendientes; ?></p>
                            <p class="text-sm text-blue-400 flex items-center">
                                <i class="fas fa-clock mr-1"></i> Por completar
                            </p>
                        </div>
                        
                        <div class="liquid-card p-6 rounded-2xl cursor-pointer" onclick="mostrarTab('mis-tareas')">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-gray-400 text-sm font-medium uppercase">Mis Tareas Completadas</h3>
                                <i class="fas fa-check-circle text-2xl text-green-500"></i>
                            </div>
                            <p class="text-4xl font-extrabold text-white mb-2" id="stat-2"><?php echo $tareas_completadas; ?></p>
                            <p class="text-sm text-green-400 flex items-center">
                                <i class="fas fa-check mr-1"></i> Finalizadas
                            </p>
                        </div>
                        
                        <div class="liquid-card p-6 rounded-2xl cursor-pointer" onclick="mostrarTab('mis-tareas')">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-gray-400 text-sm font-medium uppercase">Mis Tareas Vencidas</h3>
                                <i class="fas fa-exclamation-triangle text-2xl text-red-500"></i>
                            </div>
                            <p class="text-4xl font-extrabold text-white mb-2" id="stat-3"><?php echo $tareas_vencidas; ?></p>
                            <p class="text-sm text-red-400 flex items-center">
                                <i class="fas fa-exclamation-circle mr-1"></i> Requieren atenciÃ³n
                            </p>
                        </div>
                        
                        <div class="liquid-card p-6 rounded-2xl">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-gray-400 text-sm font-medium uppercase">Empleados en mi Turno</h3>
                                <i class="fas fa-users text-2xl text-purple-500"></i>
                            </div>
                            <p class="text-4xl font-extrabold text-white mb-2" id="stat-4"><?php echo $empleados_turno_actual; ?></p>
                            <p class="text-sm text-purple-400 flex items-center">
                                <i class="fas fa-user-clock mr-1"></i> Trabajando hoy
                            </p>
                        </div>
                        
                        <?php if ($usuario_actual['pasillo_asignado']): ?>
                            <div class="liquid-card p-6 rounded-2xl md:col-span-2 xl:col-span-1">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-gray-400 text-sm font-medium uppercase">Mi Pasillo</h3>
                                    <i class="fas fa-location-dot text-2xl text-amber-500"></i>
                                </div>
                                <p class="text-4xl font-extrabold text-white mb-2"><?php echo htmlspecialchars($usuario_actual['pasillo_asignado']); ?></p>
                                <p class="text-sm text-amber-400 flex items-center">
                                    <i class="fas fa-map-marker-alt mr-1"></i> Ãrea designada
                                </p>
                            </div>
                        <?php endif; ?>
                        
                    <?php else: ?>
                        <div class="liquid-card p-6 rounded-2xl cursor-pointer" onclick="mostrarTab('ver-tareas')">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-gray-400 text-sm font-medium uppercase">Tareas Pendientes</h3>
                                <i class="fas fa-tasks text-2xl text-blue-500"></i>
                            </div>
                            <p class="text-4xl font-extrabold text-white mb-2" id="stat-1"><?php echo $tareas_pendientes; ?></p>
                            <p class="text-sm text-blue-400 flex items-center">
                                <i class="fas fa-clock mr-1"></i> Por completar
                            </p>
                        </div>
                        
                        <div class="liquid-card p-6 rounded-2xl cursor-pointer" onclick="mostrarTab('ver-tareas')">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-gray-400 text-sm font-medium uppercase">Tareas Completadas</h3>
                                <i class="fas fa-check-circle text-2xl text-green-500"></i>
                            </div>
                            <p class="text-4xl font-extrabold text-white mb-2" id="stat-2"><?php echo $tareas_completadas; ?></p>
                            <p class="text-sm text-green-400 flex items-center">
                                <i class="fas fa-check mr-1"></i> Finalizadas
                            </p>
                        </div>
                        
                        <div class="liquid-card p-6 rounded-2xl cursor-pointer" onclick="mostrarTab('ver-tareas')">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-gray-400 text-sm font-medium uppercase">Tareas Vencidas</h3>
                                <i class="fas fa-exclamation-triangle text-2xl text-red-500"></i>
                            </div>
                            <p class="text-4xl font-extrabold text-white mb-2" id="stat-3"><?php echo $tareas_vencidas; ?></p>
                            <p class="text-sm text-red-400 flex items-center">
                                <i class="fas fa-exclamation-circle mr-1"></i> Requieren atenciÃ³n
                            </p>
                        </div>
                        
                        <div class="liquid-card p-6 rounded-2xl">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-gray-400 text-sm font-medium uppercase">Empleados Turno AM</h3>
                                <i class="fas fa-sun text-2xl text-amber-500"></i>
                            </div>
                            <p class="text-4xl font-extrabold text-white mb-2" id="stat-4"><?php echo $empleados_am; ?></p>
                            <p class="text-sm text-amber-400 flex items-center">
                                <i class="fas fa-user-clock mr-1"></i> Trabajando hoy
                            </p>
                        </div>
                        
                        <div class="liquid-card p-6 rounded-2xl">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-gray-400 text-sm font-medium uppercase">Empleados Turno PM</h3>
                                <i class="fas fa-moon text-2xl text-blue-500"></i>
                            </div>
                            <p class="text-4xl font-extrabold text-white mb-2" id="stat-5"><?php echo $empleados_pm; ?></p>
                            <p class="text-sm text-blue-400 flex items-center">
                                <i class="fas fa-user-clock mr-1"></i> Trabajando hoy
                            </p>
                        </div>
                        
                        <div class="liquid-card p-6 rounded-2xl">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-gray-400 text-sm font-medium uppercase">Total Empleados</h3>
                                <i class="fas fa-users text-2xl text-purple-500"></i>
                            </div>
                            <p class="text-4xl font-extrabold text-white mb-2" id="stat-6"><?php echo $total_empleados; ?></p>
                            <p class="text-sm text-purple-400 flex items-center">
                                <i class="fas fa-user-check mr-1"></i> Activos hoy
                            </p>
                        </div>
                        
                        <div class="liquid-card p-6 rounded-2xl">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-gray-400 text-sm font-medium uppercase">Empleados Libres</h3>
                                <i class="fas fa-umbrella-beach text-2xl text-cyan-500"></i>
                            </div>
                            <p class="text-4xl font-extrabold text-white mb-2" id="stat-7"><?php echo $empleados_libres_count; ?></p>
                            <p class="text-sm text-cyan-400 flex items-center">
                                <i class="fas fa-calendar-day mr-1"></i> Descansando hoy
                            </p>
                        </div>
                    <?php endif; ?>
                </div>
                
                <!-- InformaciÃ³n adicional para dashboard -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <?php if ($usuario_actual['rol'] === 'empleado'): ?>
                        <!-- PrÃ³ximas tareas para empleados -->
                        <div class="liquid-card p-6 rounded-2xl">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-list-ol mr-3 text-blue-400"></i>
                                Mis PrÃ³ximas Tareas
                            </h3>
                            <?php if (!empty($tareas)): ?>
                                <div class="space-y-3">
                                    <?php 
                                    $tareas_proximas = array_slice($tareas, 0, 3);
                                    foreach ($tareas_proximas as $tarea): 
                                        if ($tarea['estado'] === 'pendiente'):
                                    ?>
                                        <div class="p-3 input-glass rounded-xl">
                                            <div class="flex justify-between items-start mb-2">
                                                <h4 class="font-semibold text-white"><?php echo htmlspecialchars($tarea['titulo']); ?></h4>
                                                <span class="text-xs px-2 py-1 bg-amber-900/50 text-amber-200 rounded-full">Pendiente</span>
                                            </div>
                                            <p class="text-sm text-gray-300 mb-2"><?php echo htmlspecialchars(substr($tarea['descripcion'], 0, 100)); ?>...</p>
                                            <?php if ($tarea['fecha_vencimiento']): ?>
                                                <p class="text-xs text-gray-400">
                                                    <i class="fas fa-clock mr-1"></i>
                                                    Vence: <?php echo convertirFechaZonaHoraria($tarea['fecha_vencimiento'], 'd/m/Y H:i'); ?>
                                                </p>
                                            <?php endif; ?>
                                        </div>
                                    <?php 
                                        endif;
                                    endforeach; 
                                    ?>
                                </div>
                            <?php else: ?>
                                <p class="text-gray-400 text-center py-4">No tienes tareas asignadas.</p>
                            <?php endif; ?>
                        </div>
                        
                        <!-- InformaciÃ³n del turno -->
                        <div class="liquid-card p-6 rounded-2xl">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-info-circle mr-3 text-blue-400"></i>
                                InformaciÃ³n de Mi Turno
                            </h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-3 input-glass rounded-xl">
                                    <span class="text-gray-300">Turno Actual</span>
                                    <span class="font-semibold text-white"><?php echo $usuario_actual['turno']; ?></span>
                                </div>
                                <div class="flex items-center justify-between p-3 input-glass rounded-xl">
                                    <span class="text-gray-300">DÃ­a Libre</span>
                                    <span class="font-semibold text-white"><?php echo $usuario_actual['dia_libre'] ?: 'No asignado'; ?></span>
                                </div>
                                <div class="flex items-center justify-between p-3 input-glass rounded-xl">
                                    <span class="text-gray-300">Estado Hoy</span>
                                    <span class="font-semibold <?php echo empleado_esta_libre_hoy($usuario_actual) ? 'text-amber-400' : 'text-green-400'; ?>">
                                        <?php echo empleado_esta_libre_hoy($usuario_actual) ? 'Libre' : 'Trabajando'; ?>
                                    </span>
                                </div>
                            </div>
                        </div>
                    <?php else: ?>
                        <!-- Resumen rÃ¡pido para administradores -->
                        <div class="liquid-card p-6 rounded-2xl">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-chart-pie mr-3 text-blue-400"></i>
                                Resumen RÃ¡pido
                            </h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-3 input-glass rounded-xl">
                                    <span class="text-gray-300">Total Usuarios</span>
                                    <span class="font-semibold text-white"><?php echo count($empleados); ?></span>
                                </div>
                                <div class="flex items-center justify-between p-3 input-glass rounded-xl">
                                    <span class="text-gray-300">Tareas Activas</span>
                                    <span class="font-semibold text-white"><?php echo $tareas_pendientes + $tareas_completadas; ?></span>
                                </div>
                                <div class="flex items-center justify-between p-3 input-glass rounded-xl">
                                    <span class="text-gray-300">Eficiencia General</span>
                                    <span class="font-semibold text-green-400">
                                        <?php 
                                        $total_tareas = $tareas_pendientes + $tareas_completadas + $tareas_vencidas;
                                        $eficiencia = $total_tareas > 0 ? round(($tareas_completadas / $total_tareas) * 100) : 0;
                                        echo $eficiencia . '%';
                                        ?>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Acciones rÃ¡pidas para administradores -->
                        <div class="liquid-card p-6 rounded-2xl">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-bolt mr-3 text-amber-400"></i>
                                Acciones RÃ¡pidas
                            </h3>
                            <div class="grid grid-cols-1 gap-3">
                                <button onclick="mostrarTab('asignar-tareas')" class="w-full text-left p-3 btn-liquid text-white rounded-xl transition duration-200 flex items-center">
                                    <i class="fas fa-plus-circle mr-3"></i>
                                    <span>Asignar Nueva Tarea</span>
                                </button>
                                <button onclick="mostrarTab('gestion-usuarios')" class="w-full text-left p-3 bg-green-600 text-white rounded-xl hover:bg-green-700 transition duration-200 flex items-center">
                                    <i class="fas fa-user-plus mr-3"></i>
                                    <span>Crear Nuevo Usuario</span>
                                </button>
                                <button onclick="mostrarTab('montacarga')" class="w-full text-left p-3 bg-amber-600 text-white rounded-xl hover:bg-amber-700 transition duration-200 flex items-center">
                                    <i class="fas fa-truck-loading mr-3"></i>
                                    <span>Gestionar Montacarga</span>
                                </button>
                            </div>
                        </div>
                    <?php endif; ?>
                </div>
            </div>

            <!-- GestiÃ³n de Usuarios (Solo administradores) - MEJORADA Y CORREGIDA -->
            <?php if (in_array($usuario_actual['rol'], ['admin_pro', 'admin'])): ?>
                <div id="gestion-usuarios" class="tab-content <?php echo $tab_actual === 'gestion-usuarios' ? 'active' : ''; ?>">
                    <div class="liquid-card rounded-2xl p-6 mb-6">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-user-plus mr-3 text-blue-400"></i>
                            Crear Nuevo Usuario
                        </h2>
                        <form method="POST" class="space-y-6" id="formCrearUsuario">
                            <input type="hidden" name="accion" value="crear_usuario">
                            <input type="hidden" name="tab_actual" value="gestion-usuarios">
                            <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Usuario</label>
                                    <input type="text" name="username" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" required>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">ContraseÃ±a</label>
                                    <input type="password" name="password" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" required minlength="6">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Nombre Completo</label>
                                    <input type="text" name="nombre" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" required>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Rol</label>
                                    <select name="rol" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" onchange="toggleCamposEmpleado()">
                                        <option value="empleado">Empleado</option>
                                        <?php if ($usuario_actual['rol'] === 'admin_pro'): ?>
                                            <option value="admin">Administrador</option>
                                            <option value="admin_pro">Administrador Pro</option>
                                        <?php endif; ?>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">ID de Telegram</label>
                                    <input type="text" name="telegram_id" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" placeholder="@username o nÃºmero ID">
                                </div>
                                
                                <div class="campos-empleado">
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Turno</label>
                                    <select name="turno" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200">
                                        <option value="AM">AM</option>
                                        <option value="PM">PM</option>
                                    </select>
                                </div>
                                
                                <div class="campos-empleado">
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Pasillo Asignado</label>
                                    <input type="text" name="pasillo" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200">
                                </div>
                                
                                <div class="campos-empleado">
                                    <label class="block text-gray-300 text-sm font-medium mb-2">DÃ­a Libre</label>
                                    <select name="dia_libre" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200">
                                        <option value="">Seleccionar</option>
                                        <option value="Lunes">Lunes</option>
                                        <option value="Martes">Martes</option>
                                        <option value="MiÃ©rcoles">MiÃ©rcoles</option>
                                        <option value="Jueves">Jueves</option>
                                        <option value="Viernes">Viernes</option>
                                        <option value="SÃ¡bado">SÃ¡bado</option>
                                        <option value="Domingo">Domingo</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn-liquid text-white font-bold py-3 px-6 rounded-xl flex items-center">
                                <i class="fas fa-save mr-2"></i> Crear Usuario
                            </button>
                        </form>
                    </div>
                    
                    <div class="liquid-card rounded-2xl p-6">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-users mr-3 text-blue-400"></i>
                            Lista de Usuarios
                        </h2>
                        <div class="table-responsive">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b border-gray-700">
                                        <th class="py-3 px-4 text-gray-400 font-semibold">Usuario</th>
                                        <th class="py-3 px-4 text-gray-400 font-semibold">Nombre</th>
                                        <th class="py-3 px-4 text-gray-400 font-semibold">Rol</th>
                                        <th class="py-3 px-4 text-gray-400 font-semibold">Turno</th>
                                        <th class="py-3 px-4 text-gray-400 font-semibold">Pasillo</th>
                                        <th class="py-3 px-4 text-gray-400 font-semibold">DÃ­a Libre</th>
                                        <th class="py-3 px-4 text-gray-400 font-semibold">Estado</th>
                                        <th class="py-3 px-4 text-gray-400 font-semibold">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach ($empleados as $empleado): ?>
                                        <tr class="border-b border-gray-800 hover:bg-gray-800/50 transition duration-150">
                                            <td class="py-3 px-4 text-white"><?php echo htmlspecialchars($empleado['username']); ?></td>
                                            <td class="py-3 px-4 text-white"><?php echo htmlspecialchars($empleado['nombre']); ?></td>
                                            <td class="py-3 px-4">
                                                <span class="px-2 py-1 rounded-full text-xs <?php 
                                                    echo $empleado['rol'] === 'admin_pro' ? 'bg-purple-500 text-white' : 
                                                           ($empleado['rol'] === 'admin' ? 'bg-blue-500 text-white' : 'bg-green-500 text-white');
                                                ?>">
                                                    <?php echo htmlspecialchars(ucfirst($empleado['rol'])); ?>
                                                </span>
                                            </td>
                                            <td class="py-3 px-4 text-white"><?php echo $empleado['rol'] === 'empleado' ? htmlspecialchars($empleado['turno']) : '-'; ?></td>
                                            <td class="py-3 px-4 text-white"><?php echo $empleado['rol'] === 'empleado' ? htmlspecialchars($empleado['pasillo_asignado']) : '-'; ?></td>
                                            <td class="py-3 px-4 text-white"><?php echo $empleado['rol'] === 'empleado' ? htmlspecialchars($empleado['dia_libre']) : '-'; ?></td>
                                            <td class="py-3 px-4">
                                                <?php if ($empleado['rol'] === 'empleado'): ?>
                                                    <span class="px-2 py-1 rounded-full text-xs <?php echo empleado_esta_libre_hoy($empleado) ? 'bg-yellow-500 text-white' : 'bg-green-500 text-white'; ?>">
                                                        <?php echo empleado_esta_libre_hoy($empleado) ? 'Libre Hoy' : 'Trabajando'; ?>
                                                    </span>
                                                <?php else: ?>
                                                    <span class="px-2 py-1 rounded-full text-xs bg-blue-500 text-white">Activo</span>
                                                <?php endif; ?>
                                            </td>
                                            <td class="py-3 px-4">
                                                <div class="flex gap-2">
                                                    <button onclick="editarUsuario(<?php echo $empleado['id']; ?>)" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-700 transition duration-200 flex items-center">
                                                        <i class="fas fa-edit mr-1"></i> Editar
                                                    </button>
                                                    <?php if ($usuario_actual['rol'] === 'admin_pro' || $empleado['rol'] !== 'admin_pro'): ?>
                                                        <button onclick="eliminarUsuario(<?php echo $empleado['id']; ?>)" class="bg-red-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-700 transition duration-200 flex items-center">
                                                            <i class="fas fa-trash mr-1"></i> Eliminar
                                                        </button>
                                                    <?php endif; ?>
                                                </div>
                                            </td>
                                        </tr>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Asignar Tareas - MEJORADO CON SELECCIÃ“N MÃšLTIPLE -->
                <div id="asignar-tareas" class="tab-content <?php echo $tab_actual === 'asignar-tareas' ? 'active' : ''; ?>">
                    <div class="liquid-card rounded-2xl p-6">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-tasks mr-3 text-blue-400"></i>
                            Asignar Nueva Tarea
                        </h2>
                        <form method="POST" class="space-y-6">
                            <input type="hidden" name="accion" value="asignar_tarea">
                            <input type="hidden" name="tab_actual" value="asignar-tareas">
                            <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                            
                            <div>
                                <label class="block text-gray-300 text-sm font-medium mb-2">Empleados</label>
                                <select name="empleados_ids[]" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" multiple required size="5">
                                    <?php 
                                    $empleados_activos = $pdo->query("SELECT * FROM usuarios WHERE activo = TRUE AND rol = 'empleado' ORDER BY nombre")->fetchAll();
                                    foreach ($empleados_activos as $emp): 
                                    ?>
                                        <option value="<?php echo $emp['id']; ?>"><?php echo htmlspecialchars($emp['nombre']); ?> - <?php echo $emp['turno']; ?></option>
                                    <?php endforeach; ?>
                                </select>
                                <p class="text-gray-500 text-xs mt-1">MantÃ©n presionada la tecla Ctrl (Cmd en Mac) para seleccionar mÃºltiples empleados</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-300 text-sm font-medium mb-2">TÃ­tulo de la Tarea</label>
                                <input type="text" name="titulo" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" required placeholder="Ingrese el tÃ­tulo de la tarea">
                            </div>
                            
                            <div>
                                <label class="block text-gray-300 text-sm font-medium mb-2">DescripciÃ³n</label>
                                <textarea name="descripcion" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" rows="4" required placeholder="Describa la tarea a realizar"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Fecha de Vencimiento</label>
                                    <input type="datetime-local" name="fecha_vencimiento" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200">
                                    <p class="text-gray-500 text-xs mt-1">Hora local: America/Santo_Domingo</p>
                                </div>
                            </div>
                            
                            <div class="flex gap-6 flex-wrap">
                                <label class="flex items-center">
                                    <input type="checkbox" name="requiere_foto" class="mr-2 w-4 h-4 text-blue-600 bg-gray-800 border-gray-700 rounded focus:ring-blue-500 focus:ring-2">
                                    <span class="text-gray-300">Requerir foto de evidencia</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="notificar_telegram" checked class="mr-2 w-4 h-4 text-blue-600 bg-gray-800 border-gray-700 rounded focus:ring-blue-500 focus:ring-2">
                                    <span class="text-gray-300">Notificar por Telegram</span>
                                </label>
                            </div>
                            
                            <button type="submit" class="btn-liquid text-white font-bold py-3 px-6 rounded-xl flex items-center">
                                <i class="fas fa-paper-plane mr-2"></i> Asignar Tarea
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Ver Todas las Tareas - MEJORADO Y REORGANIZADO CON CATEGORÃAS -->
                <div id="ver-tareas" class="tab-content <?php echo $tab_actual === 'ver-tareas' ? 'active' : ''; ?>">
                    <div class="liquid-card rounded-2xl p-6">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-list-check mr-3 text-blue-400"></i>
                            Todas las Tareas
                        </h2>
                        
                        <!-- Filtros mejorados -->
                        <div class="flex flex-wrap gap-2 mb-6">
                            <button onclick="filtrarTareas('todas')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center">
                                <i class="fas fa-list mr-2"></i> Todas
                            </button>
                            <button onclick="filtrarTareas('pendiente')" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition duration-200 flex items-center">
                                <i class="fas fa-clock mr-2"></i> Pendientes
                            </button>
                            <button onclick="filtrarTareas('completada')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center">
                                <i class="fas fa-check mr-2"></i> Completadas
                            </button>
                            <button onclick="filtrarTareas('vencida')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200 flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2"></i> Vencidas
                            </button>
                            <button onclick="filtrarTareas('verificada')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-200 flex items-center">
                                <i class="fas fa-check-double mr-2"></i> Verificadas
                            </button>
                        </div>
                        
                        <!-- EstadÃ­sticas rÃ¡pidas -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="liquid-glass p-4 rounded-xl text-center">
                                <div class="text-2xl font-bold text-blue-400"><?php echo $tareas_pendientes; ?></div>
                                <div class="text-sm text-gray-300">Pendientes</div>
                            </div>
                            <div class="liquid-glass p-4 rounded-xl text-center">
                                <div class="text-2xl font-bold text-green-400"><?php echo $tareas_completadas; ?></div>
                                <div class="text-sm text-gray-300">Completadas</div>
                            </div>
                            <div class="liquid-glass p-4 rounded-xl text-center">
                                <div class="text-2xl font-bold text-red-400"><?php echo $tareas_vencidas; ?></div>
                                <div class="text-sm text-gray-300">Vencidas</div>
                            </div>
                            <div class="liquid-glass p-4 rounded-xl text-center">
                                <div class="text-2xl font-bold text-purple-400"><?php echo count($todas_tareas) - $tareas_pendientes - $tareas_completadas - $tareas_vencidas; ?></div>
                                <div class="text-sm text-gray-300">Verificadas</div>
                            </div>
                        </div>
                        
                        <!-- Tareas organizadas por categorÃ­as -->
                        <div class="categorias-tareas">
                            <!-- Tareas Pendientes -->
                            <div class="categoria-tareas">
                                <div class="categoria-header">
                                    <h3 class="text-xl font-bold text-white flex items-center">
                                        <i class="fas fa-clock text-yellow-400 mr-2"></i>
                                        Tareas Pendientes (<?php echo $tareas_pendientes; ?>)
                                    </h3>
                                </div>
                                <?php 
                                $tareas_pendientes_cat = array_filter($todas_tareas, function($t) { 
                                    return $t['estado'] === 'pendiente'; 
                                });
                                ?>
                                <?php if (!empty($tareas_pendientes_cat)): ?>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <?php foreach ($tareas_pendientes_cat as $tarea): ?>
                                            <div class="tarea-item tarea-pendiente">
                                                <div class="flex justify-between items-start mb-2">
                                                    <h4 class="font-semibold text-white text-sm"><?php echo htmlspecialchars($tarea['titulo']); ?></h4>
                                                    <span class="text-xs px-2 py-1 bg-yellow-500 text-white rounded-full">Pendiente</span>
                                                </div>
                                                <p class="text-xs text-gray-300 mb-2"><?php echo htmlspecialchars(substr($tarea['descripcion'], 0, 80)); ?>...</p>
                                                <div class="text-xs text-gray-400 space-y-1">
                                                    <div><i class="fas fa-user mr-1"></i> <?php echo htmlspecialchars($tarea['empleado_nombre']); ?></div>
                                                    <?php if ($tarea['fecha_vencimiento']): ?>
                                                        <div><i class="fas fa-clock mr-1"></i> Vence: <?php echo convertirFechaZonaHoraria($tarea['fecha_vencimiento'], 'd/m/Y H:i'); ?></div>
                                                    <?php endif; ?>
                                                </div>
                                                <div class="flex gap-2 mt-3">
                                                    <button onclick="editarTarea(<?php echo $tarea['id']; ?>)" class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700 transition duration-200 flex items-center">
                                                        <i class="fas fa-edit mr-1"></i> Editar
                                                    </button>
                                                    <button onclick="verDetallesTarea(<?php echo $tarea['id']; ?>)" class="bg-gray-600 text-white px-2 py-1 rounded text-xs hover:bg-gray-700 transition duration-200 flex items-center">
                                                        <i class="fas fa-eye mr-1"></i> Ver
                                                    </button>
                                                </div>
                                            </div>
                                        <?php endforeach; ?>
                                    </div>
                                <?php else: ?>
                                    <p class="text-gray-400 text-center py-4">No hay tareas pendientes.</p>
                                <?php endif; ?>
                            </div>
                            
                            <!-- Tareas Vencidas -->
                            <div class="categoria-tareas">
                                <div class="categoria-header">
                                    <h3 class="text-xl font-bold text-white flex items-center">
                                        <i class="fas fa-exclamation-triangle text-red-400 mr-2"></i>
                                        Tareas Vencidas (<?php echo $tareas_vencidas; ?>)
                                    </h3>
                                </div>
                                <?php 
                                $tareas_vencidas_cat = array_filter($todas_tareas, function($t) { 
                                    return $t['estado'] === 'vencida'; 
                                });
                                ?>
                                <?php if (!empty($tareas_vencidas_cat)): ?>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <?php foreach ($tareas_vencidas_cat as $tarea): ?>
                                            <div class="tarea-item tarea-vencida">
                                                <div class="flex justify-between items-start mb-2">
                                                    <h4 class="font-semibold text-white text-sm"><?php echo htmlspecialchars($tarea['titulo']); ?></h4>
                                                    <span class="text-xs px-2 py-1 bg-red-500 text-white rounded-full">Vencida</span>
                                                </div>
                                                <p class="text-xs text-gray-300 mb-2"><?php echo htmlspecialchars(substr($tarea['descripcion'], 0, 80)); ?>...</p>
                                                <div class="text-xs text-gray-400 space-y-1">
                                                    <div><i class="fas fa-user mr-1"></i> <?php echo htmlspecialchars($tarea['empleado_nombre']); ?></div>
                                                    <?php if ($tarea['fecha_vencimiento']): ?>
                                                        <div><i class="fas fa-clock mr-1"></i> VenciÃ³: <?php echo convertirFechaZonaHoraria($tarea['fecha_vencimiento'], 'd/m/Y H:i'); ?></div>
                                                    <?php endif; ?>
                                                </div>
                                                <div class="flex gap-2 mt-3">
                                                    <?php if (tarea_puede_reabrirse($tarea['id'])): ?>
                                                        <form method="POST" class="inline">
                                                            <input type="hidden" name="accion" value="reabrir_tarea">
                                                            <input type="hidden" name="tarea_id" value="<?php echo $tarea['id']; ?>">
                                                            <input type="hidden" name="tab_actual" value="ver-tareas">
                                                            <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                                                            <button type="submit" class="bg-yellow-600 text-white px-2 py-1 rounded text-xs hover:bg-yellow-700 transition duration-200 flex items-center">
                                                                <i class="fas fa-redo mr-1"></i> Reabrir
                                                            </button>
                                                        </form>
                                                    <?php else: ?>
                                                        <span class="text-xs text-gray-400">Espere <?php echo $tiempo_reabrir_tarea; ?> min</span>
                                                    <?php endif; ?>
                                                    <button onclick="editarTarea(<?php echo $tarea['id']; ?>)" class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700 transition duration-200 flex items-center">
                                                        <i class="fas fa-edit mr-1"></i> Editar
                                                    </button>
                                                </div>
                                            </div>
                                        <?php endforeach; ?>
                                    </div>
                                <?php else: ?>
                                    <p class="text-gray-400 text-center py-4">No hay tareas vencidas.</p>
                                <?php endif; ?>
                            </div>
                            
                            <!-- Tareas Completadas -->
                            <div class="categoria-tareas">
                                <div class="categoria-header">
                                    <h3 class="text-xl font-bold text-white flex items-center">
                                        <i class="fas fa-check text-green-400 mr-2"></i>
                                        Tareas Completadas (<?php echo $tareas_completadas; ?>)
                                    </h3>
                                </div>
                                <?php 
                                $tareas_completadas_cat = array_filter($todas_tareas, function($t) { 
                                    return $t['estado'] === 'completada'; 
                                });
                                ?>
                                <?php if (!empty($tareas_completadas_cat)): ?>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <?php foreach ($tareas_completadas_cat as $tarea): ?>
                                            <div class="tarea-item tarea-completada">
                                                <div class="flex justify-between items-start mb-2">
                                                    <h4 class="font-semibold text-white text-sm"><?php echo htmlspecialchars($tarea['titulo']); ?></h4>
                                                    <span class="text-xs px-2 py-1 bg-green-500 text-white rounded-full">Completada</span>
                                                </div>
                                                <p class="text-xs text-gray-300 mb-2"><?php echo htmlspecialchars(substr($tarea['descripcion'], 0, 80)); ?>...</p>
                                                <div class="text-xs text-gray-400 space-y-1">
                                                    <div><i class="fas fa-user mr-1"></i> <?php echo htmlspecialchars($tarea['empleado_nombre']); ?></div>
                                                    <?php if ($tarea['fecha_completado']): ?>
                                                        <div><i class="fas fa-check-circle mr-1"></i> Completada: <?php echo convertirFechaZonaHoraria($tarea['fecha_completado'], 'd/m/Y H:i'); ?></div>
                                                    <?php endif; ?>
                                                </div>
                                                <div class="flex gap-2 mt-3">
                                                    <button onclick="verificarTarea(<?php echo $tarea['id']; ?>)" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700 transition duration-200 flex items-center">
                                                        <i class="fas fa-check-double mr-1"></i> Verificar
                                                    </button>
                                                    <?php 
                                                    $fotos_tarea = obtener_fotos_tarea($tarea['id']);
                                                    if (!empty($fotos_tarea)): ?>
                                                        <button onclick="verFotosTarea(<?php echo $tarea['id']; ?>)" class="bg-amber-600 text-white px-2 py-1 rounded text-xs hover:bg-amber-700 transition duration-200 flex items-center">
                                                            <i class="fas fa-images mr-1"></i> Fotos (<?php echo count($fotos_tarea); ?>)
                                                        </button>
                                                    <?php endif; ?>
                                                </div>
                                            </div>
                                        <?php endforeach; ?>
                                    </div>
                                <?php else: ?>
                                    <p class="text-gray-400 text-center py-4">No hay tareas completadas.</p>
                                <?php endif; ?>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Montacarga -->
                <div id="montacarga" class="tab-content <?php echo $tab_actual === 'montacarga' ? 'active' : ''; ?>">
                    <div class="liquid-card rounded-2xl p-6">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-truck-loading mr-3 text-blue-400"></i>
                            Configurar Montacarga
                        </h2>
                        <form method="POST" class="space-y-6">
                            <input type="hidden" name="accion" value="configurar_sistema">
                            <input type="hidden" name="tab_actual" value="montacarga">
                            <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Hora Montacarga AM</label>
                                    <input type="time" name="hora_montacarga_am" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" value="<?php echo htmlspecialchars($configuraciones['hora_montacarga_am'] ?? '08:00'); ?>">
                                </div>
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Hora Montacarga PM</label>
                                    <input type="time" name="hora_montacarga_pm" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" value="<?php echo htmlspecialchars($configuraciones['hora_montacarga_pm'] ?? '14:00'); ?>">
                                </div>
                            </div>
                            
                            <button type="submit" class="btn-liquid text-white font-bold py-3 px-6 rounded-xl flex items-center">
                                <i class="fas fa-save mr-2"></i> Guardar Horarios
                            </button>
                        </form>
                        
                        <div class="mt-8 pt-6 border-t border-gray-700">
                            <h3 class="text-xl font-bold text-white mb-4">Asignar Montacarga Manualmente</h3>
                            <form method="POST" class="space-y-6">
                                <input type="hidden" name="accion" value="asignar_montacarga">
                                <input type="hidden" name="tab_actual" value="montacarga">
                                <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-gray-300 text-sm font-medium mb-2">Turno</label>
                                        <select name="turno_montacarga" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" required>
                                            <option value="AM">AM</option>
                                            <option value="PM">PM</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-300 text-sm font-medium mb-2">Hora de la Tarea</label>
                                        <input type="time" name="hora_montacarga" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" required value="<?php echo $configuraciones['hora_montacarga_am'] ?? '08:00'; ?>">
                                    </div>
                                </div>
                                
                                <div class="bg-blue-900/30 border border-blue-700 rounded-xl p-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-blue-400 mr-3"></i>
                                        <div>
                                            <h4 class="text-white font-semibold">InformaciÃ³n</h4>
                                            <p class="text-blue-200 text-sm mt-1">
                                                El sistema seleccionarÃ¡ automÃ¡ticamente 2 empleados del turno especificado. 
                                                <strong>AMBOS estarÃ¡n en la posiciÃ³n SUPERIOR (ARRIBA)</strong> del montacarga.
                                                El resto de empleados del turno trabajarÃ¡n en el almacÃ©n (abajo) para recibir patanas.
                                                Se enviarÃ¡n notificaciones por Telegram a todos los empleados del turno.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="bg-amber-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-amber-500/30 hover:bg-amber-700 active:scale-[0.98] transition duration-300 flex items-center">
                                    <i class="fas fa-truck-loading mr-2"></i> Asignar Alertas de Montacarga
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            <?php endif; ?>
            
            <!-- Mis Tareas (Solo empleados) - MEJORADO CON CÃMARA -->
            <?php if ($usuario_actual['rol'] === 'empleado'): ?>
                <div id="mis-tareas" class="tab-content <?php echo $tab_actual === 'mis-tareas' ? 'active' : ''; ?>">
                    <div class="liquid-card rounded-2xl p-6">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-list-check mr-3 text-blue-400"></i>
                            Mis Tareas
                        </h2>
                        
                        <!-- Filtros -->
                        <div class="flex flex-wrap gap-2 mb-6">
                            <button onclick="filtrarMisTareas('todas')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center">
                                <i class="fas fa-list mr-2"></i> Todas
                            </button>
                            <button onclick="filtrarMisTareas('pendiente')" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition duration-200 flex items-center">
                                <i class="fas fa-clock mr-2"></i> Pendientes
                            </button>
                            <button onclick="filtrarMisTareas('completada')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center">
                                <i class="fas fa-check mr-2"></i> Completadas
                            </button>
                            <button onclick="filtrarMisTareas('vencida')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200 flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2"></i> Vencidas
                            </button>
                        </div>
                        
                        <!-- EstadÃ­sticas personales -->
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                            <div class="liquid-glass p-4 rounded-xl text-center">
                                <div class="text-2xl font-bold text-yellow-400"><?php echo $tareas_pendientes; ?></div>
                                <div class="text-sm text-gray-300">Pendientes</div>
                            </div>
                            <div class="liquid-glass p-4 rounded-xl text-center">
                                <div class="text-2xl font-bold text-green-400"><?php echo $tareas_completadas; ?></div>
                                <div class="text-sm text-gray-300">Completadas</div>
                            </div>
                            <div class="liquid-glass p-4 rounded-xl text-center">
                                <div class="text-2xl font-bold text-red-400"><?php echo $tareas_vencidas; ?></div>
                                <div class="text-sm text-gray-300">Vencidas</div>
                            </div>
                        </div>
                        
                        <?php if (empty($tareas)): ?>
                            <div class="text-center py-8">
                                <i class="fas fa-inbox text-4xl text-gray-500 mb-4"></i>
                                <p class="text-gray-400">No tienes tareas asignadas.</p>
                            </div>
                        <?php else: ?>
                            <div class="categorias-tareas">
                                <!-- Tareas Pendientes -->
                                <div class="categoria-tareas">
                                    <div class="categoria-header">
                                        <h3 class="text-xl font-bold text-white flex items-center">
                                            <i class="fas fa-clock text-yellow-400 mr-2"></i>
                                            Tareas Pendientes (<?php echo $tareas_pendientes; ?>)
                                        </h3>
                                    </div>
                                    <?php 
                                    $tareas_pendientes_mis = array_filter($tareas, function($t) { 
                                        return $t['estado'] === 'pendiente'; 
                                    });
                                    ?>
                                    <?php if (!empty($tareas_pendientes_mis)): ?>
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            <?php foreach ($tareas_pendientes_mis as $tarea): ?>
                                                <div class="tarea-item tarea-pendiente">
                                                    <div class="flex justify-between items-start mb-2">
                                                        <h4 class="font-semibold text-white text-sm"><?php echo htmlspecialchars($tarea['titulo']); ?></h4>
                                                        <span class="text-xs px-2 py-1 bg-yellow-500 text-white rounded-full">Pendiente</span>
                                                    </div>
                                                    <p class="text-xs text-gray-300 mb-2"><?php echo htmlspecialchars(substr($tarea['descripcion'], 0, 80)); ?>...</p>
                                                    <div class="text-xs text-gray-400 space-y-1">
                                                        <div><i class="fas fa-user-tie mr-1"></i> <?php echo htmlspecialchars($tarea['admin_nombre']); ?></div>
                                                        <?php if ($tarea['fecha_vencimiento']): ?>
                                                            <div><i class="fas fa-clock mr-1"></i> Vence: <?php echo convertirFechaZonaHoraria($tarea['fecha_vencimiento'], 'd/m/Y H:i'); ?></div>
                                                        <?php endif; ?>
                                                    </div>
                                                    <div class="flex gap-2 mt-3">
                                                        <?php if ($tarea['requiere_foto']): ?>
                                                            <button onclick="completarTareaConFoto(<?php echo $tarea['id']; ?>)" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700 transition duration-200 flex items-center">
                                                                <i class="fas fa-camera mr-1"></i> Completar con Foto
                                                            </button>
                                                        <?php else: ?>
                                                            <form method="POST" class="inline">
                                                                <input type="hidden" name="accion" value="completar_tarea_sin_foto">
                                                                <input type="hidden" name="tarea_id" value="<?php echo $tarea['id']; ?>">
                                                                <input type="hidden" name="tab_actual" value="mis-tareas">
                                                                <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                                                                <button type="submit" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700 transition duration-200 flex items-center" onclick="return confirm('Â¿EstÃ¡s seguro de que quieres marcar esta tarea como completada?')">
                                                                    <i class="fas fa-check mr-1"></i> Completar
                                                                </button>
                                                            </form>
                                                        <?php endif; ?>
                                                        <button onclick="verDetallesTarea(<?php echo $tarea['id']; ?>)" class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700 transition duration-200 flex items-center">
                                                            <i class="fas fa-eye mr-1"></i> Ver
                                                        </button>
                                                    </div>
                                                </div>
                                            <?php endforeach; ?>
                                        </div>
                                    <?php else: ?>
                                        <p class="text-gray-400 text-center py-4">No tienes tareas pendientes.</p>
                                    <?php endif; ?>
                                </div>
                                
                                <!-- Tareas Vencidas -->
                                <div class="categoria-tareas">
                                    <div class="categoria-header">
                                        <h3 class="text-xl font-bold text-white flex items-center">
                                            <i class="fas fa-exclamation-triangle text-red-400 mr-2"></i>
                                            Tareas Vencidas (<?php echo $tareas_vencidas; ?>)
                                        </h3>
                                    </div>
                                    <?php 
                                    $tareas_vencidas_mis = array_filter($tareas, function($t) { 
                                        return $t['estado'] === 'vencida'; 
                                    });
                                    ?>
                                    <?php if (!empty($tareas_vencidas_mis)): ?>
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            <?php foreach ($tareas_vencidas_mis as $tarea): ?>
                                                <div class="tarea-item tarea-vencida">
                                                    <div class="flex justify-between items-start mb-2">
                                                        <h4 class="font-semibold text-white text-sm"><?php echo htmlspecialchars($tarea['titulo']); ?></h4>
                                                        <span class="text-xs px-2 py-1 bg-red-500 text-white rounded-full">Vencida</span>
                                                    </div>
                                                    <p class="text-xs text-gray-300 mb-2"><?php echo htmlspecialchars(substr($tarea['descripcion'], 0, 80)); ?>...</p>
                                                    <div class="text-xs text-gray-400 space-y-1">
                                                        <div><i class="fas fa-user-tie mr-1"></i> <?php echo htmlspecialchars($tarea['admin_nombre']); ?></div>
                                                        <?php if ($tarea['fecha_vencimiento']): ?>
                                                            <div><i class="fas fa-clock mr-1"></i> VenciÃ³: <?php echo convertirFechaZonaHoraria($tarea['fecha_vencimiento'], 'd/m/Y H:i'); ?></div>
                                                        <?php endif; ?>
                                                    </div>
                                                    <div class="flex gap-2 mt-3">
                                                        <?php if ($tarea['requiere_foto']): ?>
                                                            <button onclick="completarTareaConFoto(<?php echo $tarea['id']; ?>)" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700 transition duration-200 flex items-center">
                                                                <i class="fas fa-camera mr-1"></i> Completar con Foto
                                                            </button>
                                                        <?php else: ?>
                                                            <form method="POST" class="inline">
                                                                <input type="hidden" name="accion" value="completar_tarea_sin_foto">
                                                                <input type="hidden" name="tarea_id" value="<?php echo $tarea['id']; ?>">
                                                                <input type="hidden" name="tab_actual" value="mis-tareas">
                                                                <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                                                                <button type="submit" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700 transition duration-200 flex items-center" onclick="return confirm('Â¿EstÃ¡s seguro de que quieres marcar esta tarea como completada?')">
                                                                    <i class="fas fa-check mr-1"></i> Completar
                                                                </button>
                                                            </form>
                                                        <?php endif; ?>
                                                    </div>
                                                </div>
                                            <?php endforeach; ?>
                                        </div>
                                    <?php else: ?>
                                        <p class="text-gray-400 text-center py-4">No tienes tareas vencidas.</p>
                                    <?php endif; ?>
                                </div>
                            </div>
                        <?php endif; ?>
                    </div>
                </div>
            <?php endif; ?>
            
            <!-- Mi Perfil - MEJORADO -->
            <div id="mi-perfil" class="tab-content <?php echo $tab_actual === 'mi-perfil' ? 'active' : ''; ?>">
                <div class="liquid-card rounded-2xl p-6 mb-6">
                    <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                        <i class="fas fa-user-edit mr-3 text-blue-400"></i>
                        Mi Perfil
                    </h2>
                    <form method="POST" class="space-y-6">
                        <input type="hidden" name="accion" value="editar_usuario">
                        <input type="hidden" name="user_id" value="<?php echo $usuario_actual['id']; ?>">
                        <input type="hidden" name="tab_actual" value="mi-perfil">
                        <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-gray-300 text-sm font-medium mb-2">Usuario</label>
                                <input type="text" class="w-full px-4 py-3 input-glass rounded-xl text-gray-400" value="<?php echo htmlspecialchars($usuario_actual['username']); ?>" readonly>
                                <p class="text-gray-500 text-xs mt-1">El usuario no se puede cambiar</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-300 text-sm font-medium mb-2">Nombre Completo</label>
                                <input type="text" name="nombre" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" value="<?php echo htmlspecialchars($usuario_actual['nombre']); ?>" <?php echo $usuario_actual['rol'] === 'empleado' ? 'readonly' : ''; ?>>
                                <?php if ($usuario_actual['rol'] === 'empleado'): ?>
                                    <p class="text-gray-500 text-xs mt-1">Solo el administrador puede cambiar el nombre</p>
                                <?php endif; ?>
                            </div>
                            
                            <div>
                                <label class="block text-gray-300 text-sm font-medium mb-2">ID de Telegram</label>
                                <input type="text" name="telegram_id" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" value="<?php echo htmlspecialchars($usuario_actual['telegram_id']); ?>" placeholder="@username o nÃºmero ID">
                            </div>
                            
                            <?php if ($usuario_actual['rol'] === 'empleado'): ?>
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Turno</label>
                                    <input type="text" class="w-full px-4 py-3 input-glass rounded-xl text-gray-400" value="<?php echo htmlspecialchars($usuario_actual['turno']); ?>" readonly>
                                    <p class="text-gray-500 text-xs mt-1">El turno lo asigna el administrador</p>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Pasillo Asignado</label>
                                    <input type="text" class="w-full px-4 py-3 input-glass rounded-xl text-gray-400" value="<?php echo htmlspecialchars($usuario_actual['pasillo_asignado']); ?>" readonly>
                                    <p class="text-gray-500 text-xs mt-1">El pasillo lo asigna el administrador</p>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">DÃ­a Libre</label>
                                    <input type="text" class="w-full px-4 py-3 input-glass rounded-xl text-gray-400" value="<?php echo htmlspecialchars($usuario_actual['dia_libre']); ?>" readonly>
                                    <p class="text-gray-500 text-xs mt-1">El dÃ­a libre lo asigna el administrador</p>
                                </div>
                            <?php endif; ?>
                        </div>
                        
                        <button type="submit" class="btn-liquid text-white font-bold py-3 px-6 rounded-xl flex items-center">
                            <i class="fas fa-save mr-2"></i> Actualizar Perfil
                        </button>
                    </form>
                </div>
                
                <div class="liquid-card rounded-2xl p-6">
                    <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                        <i class="fas fa-lock mr-3 text-blue-400"></i>
                        Cambiar ContraseÃ±a
                    </h2>
                    <form method="POST" class="space-y-6">
                        <input type="hidden" name="accion" value="cambiar_password">
                        <input type="hidden" name="user_id" value="<?php echo $usuario_actual['id']; ?>">
                        <input type="hidden" name="tab_actual" value="mi-perfil">
                        <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                        
                        <div>
                            <label class="block text-gray-300 text-sm font-medium mb-2">Nueva ContraseÃ±a</label>
                            <input type="password" name="nueva_password" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" required minlength="6">
                            <p class="text-gray-500 text-xs mt-1">La contraseÃ±a debe tener al menos 6 caracteres</p>
                        </div>
                        
                        <button type="submit" class="btn-liquid text-white font-bold py-3 px-6 rounded-xl flex items-center">
                            <i class="fas fa-key mr-2"></i> Cambiar ContraseÃ±a
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- ConfiguraciÃ³n (Solo admin_pro) -->
            <?php if ($usuario_actual['rol'] === 'admin_pro'): ?>
                <div id="configuracion" class="tab-content <?php echo $tab_actual === 'configuracion' ? 'active' : ''; ?>">
                    <div class="liquid-card rounded-2xl p-6 mb-6">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-cog mr-3 text-blue-400"></i>
                            ConfiguraciÃ³n del Sistema
                        </h2>
                        <form method="POST" class="space-y-6">
                            <input type="hidden" name="accion" value="configurar_sistema">
                            <input type="hidden" name="tab_actual" value="configuracion">
                            <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Nombre del Sistema</label>
                                    <input type="text" name="nombre_sistema" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" value="<?php echo htmlspecialchars($configuraciones['nombre_sistema'] ?? 'Sistema de GestiÃ³n de Empleados'); ?>">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Token de Telegram</label>
                                    <input type="text" name="telegram_token" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" value="<?php echo htmlspecialchars($configuraciones['telegram_token'] ?? ''); ?>">
                                    <p class="text-gray-500 text-xs mt-1">Token del bot de Telegram para notificaciones</p>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Chat ID de Administrador</label>
                                    <input type="text" name="telegram_chat_id" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" value="<?php echo htmlspecialchars($configuraciones['telegram_chat_id'] ?? ''); ?>">
                                    <p class="text-gray-500 text-xs mt-1">Chat ID donde recibir notificaciones del sistema</p>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Hora Backup AutomÃ¡tico</label>
                                    <input type="time" name="hora_backup" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" value="<?php echo htmlspecialchars($configuraciones['hora_backup'] ?? '02:00'); ?>">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Calidad de Fotos (%)</label>
                                    <input type="number" name="calidad_fotos" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" value="<?php echo htmlspecialchars($configuraciones['calidad_fotos'] ?? '85'); ?>" min="1" max="100">
                                    <p class="text-gray-500 text-xs mt-1">Calidad de compresiÃ³n de fotos (1-100)</p>
                                </div>

                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">MÃ¡ximo Fotos por Tarea</label>
                                    <input type="number" name="max_fotos_tarea" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" value="<?php echo htmlspecialchars($configuraciones['max_fotos_tarea'] ?? '3'); ?>" min="1" max="10">
                                    <p class="text-gray-500 text-xs mt-1">NÃºmero mÃ¡ximo de fotos que se pueden tomar por tarea</p>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Tiempo para Reabrir Tarea (min)</label>
                                    <input type="number" name="tiempo_reabrir_tarea" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" value="<?php echo htmlspecialchars($configuraciones['tiempo_reabrir_tarea'] ?? '30'); ?>" min="1" max="1440">
                                    <p class="text-gray-500 text-xs mt-1">Minutos mÃ­nimos para poder reabrir una tarea vencida</p>
                                </div>
                            </div>
                            
                            <div class="flex gap-6 flex-wrap">
                                <label class="flex items-center">
                                    <input type="checkbox" name="backup_automatico" <?php echo ($configuraciones['backup_automatico'] ?? '1') == '1' ? 'checked' : ''; ?> class="mr-2 w-4 h-4 text-blue-600 bg-gray-800 border-gray-700 rounded focus:ring-blue-500 focus:ring-2">
                                    <span class="text-gray-300">Backup automÃ¡tico diario</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="tareas_automaticas" <?php echo ($configuraciones['tareas_automaticas'] ?? '1') == '1' ? 'checked' : ''; ?> class="mr-2 w-4 h-4 text-blue-600 bg-gray-800 border-gray-700 rounded focus:ring-blue-500 focus:ring-2">
                                    <span class="text-gray-300">Tareas automÃ¡ticas activadas</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="privacidad_tareas" <?php echo ($configuraciones['privacidad_tareas'] ?? '1') == '1' ? 'checked' : ''; ?> class="mr-2 w-4 h-4 text-blue-600 bg-gray-800 border-gray-700 rounded focus:ring-blue-500 focus:ring-2">
                                    <span class="text-gray-300">Privacidad entre administradores</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="limpiar_tareas_24h" <?php echo ($configuraciones['limpiar_tareas_24h'] ?? '1') == '1' ? 'checked' : ''; ?> class="mr-2 w-4 h-4 text-blue-600 bg-gray-800 border-gray-700 rounded focus:ring-blue-500 focus:ring-2">
                                    <span class="text-gray-300">Limpiar tareas antiguas cada 24h</span>
                                </label>
                            </div>
                            
                            <button type="submit" class="btn-liquid text-white font-bold py-3 px-6 rounded-xl flex items-center">
                                <i class="fas fa-save mr-2"></i> Guardar ConfiguraciÃ³n
                            </button>
                        </form>
                    </div>
                    
                    <div class="liquid-card rounded-2xl p-6">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-database mr-3 text-blue-400"></i>
                            Copia de Seguridad
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-bold text-white mb-4">Generar Backup</h3>
                                <form method="POST" class="space-y-4">
                                    <input type="hidden" name="accion" value="generar_backup">
                                    <input type="hidden" name="tab_actual" value="configuracion">
                                    <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-green-500/30 hover:bg-green-700 active:scale-[0.98] transition duration-300 flex items-center justify-center">
                                        <i class="fas fa-download mr-2"></i> Generar Backup
                                    </button>
                                </form>
                            </div>
                            
                            <div>
                                <h3 class="text-lg font-bold text-white mb-4">Restaurar Backup</h3>
                                <form id="formSubirBackup" class="space-y-4">
                                    <div>
                                        <label class="block text-gray-300 text-sm font-medium mb-2">Seleccionar archivo SQL</label>
                                        <input type="file" name="backup_file" accept=".sql" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" required>
                                        <p class="text-gray-500 text-xs mt-1">Solo se permiten archivos .sql (mÃ¡x. 100MB)</p>
                                    </div>
                                    <button type="button" onclick="subirBackup()" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-blue-500/30 hover:bg-blue-700 active:scale-[0.98] transition duration-300 flex items-center justify-center">
                                        <i class="fas fa-upload mr-2"></i> Subir y Restaurar Backup
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Comandos de Telegram -->
                <div id="comandos-telegram" class="tab-content <?php echo $tab_actual === 'comandos-telegram' ? 'active' : ''; ?>">
                    <div class="liquid-card rounded-2xl p-6 mb-6">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <i class="fab fa-telegram mr-3 text-blue-400"></i>
                            GestiÃ³n de Comandos de Telegram
                        </h2>
                        
                        <div class="mb-6 bg-blue-900/30 border border-blue-700 rounded-xl p-4">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-blue-400 mr-3"></i>
                                <div>
                                    <h4 class="text-white font-semibold">InformaciÃ³n sobre Comandos</h4>
                                    <p class="text-blue-200 text-sm mt-1">
                                        Configura comandos personalizados para el bot de Telegram. Los usuarios pueden usar estos comandos 
                                        en el chat con el bot para obtener informaciÃ³n o realizar acciones.
                                        <br><br>
                                        <strong>Variables disponibles:</strong><br>
                                        â€¢ <code>{nombre}</code> - Nombre del usuario<br>
                                        â€¢ <code>{chat_id}</code> - ID del chat de Telegram<br>
                                        â€¢ <code>{fecha}</code> - Fecha actual<br>
                                        â€¢ <code>{hora}</code> - Hora actual
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <form id="formCrearComando" class="space-y-6 mb-8">
                            <h3 class="text-xl font-bold text-white mb-4">Crear Nuevo Comando</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Comando</label>
                                    <input type="text" name="comando" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" placeholder="/mi_comando" required>
                                    <p class="text-gray-500 text-xs mt-1">Debe empezar con / (ej: /ayuda)</p>
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="block text-gray-300 text-sm font-medium mb-2">Respuesta</label>
                                    <textarea name="respuesta" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" rows="4" placeholder="Respuesta que enviarÃ¡ el bot..." required></textarea>
                                    <p class="text-gray-500 text-xs mt-1">Usa HTML para formato. Variables: {nombre}, {chat_id}, {fecha}, {hora}</p>
                                </div>
                            </div>
                            
                            <button type="button" onclick="crearComando()" class="btn-liquid text-white font-bold py-3 px-6 rounded-xl flex items-center">
                                <i class="fas fa-plus mr-2"></i> Crear Comando
                            </button>
                        </form>
                        
                        <div>
                            <h3 class="text-xl font-bold text-white mb-4">Comandos Existentes</h3>
                            <div id="lista-comandos" class="space-y-4">
                                <!-- Los comandos se cargarÃ¡n aquÃ­ -->
                            </div>
                        </div>
                    </div>
                </div>
            <?php endif; ?>
        </div>
    </main>

    <!-- Modal para completar tarea con cÃ¡mara -->
    <div id="modalCompletarTareaFoto" class="modal">
        <div class="liquid-card rounded-2xl p-6 m-4 max-w-2xl w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Completar Tarea con Fotos</h3>
                <button class="text-gray-400 hover:text-white text-2xl" onclick="cerrarModal('modalCompletarTareaFoto')">&times;</button>
            </div>
            
            <div class="camera-container">
                <div class="camera-preview">
                    <video id="video" autoplay playsinline></video>
                </div>
                
                <div class="flex gap-2 mb-4">
                    <button id="btnCapturar" class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-xl hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                        <i class="fas fa-camera mr-2"></i> Tomar Foto
                    </button>
                    <button id="btnCambiarCamara" class="bg-gray-600 text-white py-3 px-4 rounded-xl hover:bg-gray-700 transition duration-200 flex items-center">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <div id="captured-photos" class="captured-photos">
                    <!-- Las fotos capturadas se mostrarÃ¡n aquÃ­ -->
                </div>
                
                <div class="flex gap-2 mt-6 flex-wrap">
                    <button id="btnCompletar" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center" disabled>
                        <i class="fas fa-check mr-2"></i> Completar Tarea
                    </button>
                    <button type="button" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200 flex items-center" onclick="cerrarModal('modalCompletarTareaFoto')">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver fotos de tarea -->
    <div id="modalFotosTarea" class="modal">
        <div class="liquid-card rounded-2xl p-6 m-4 max-w-4xl w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Fotos de la Tarea</h3>
                <button class="text-gray-400 hover:text-white text-2xl" onclick="cerrarModal('modalFotosTarea')">&times;</button>
            </div>
            <div id="fotos-tarea-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto">
                <!-- Las fotos se cargarÃ¡n aquÃ­ -->
            </div>
        </div>
    </div>

    <!-- Modal para verificar tarea -->
    <div id="modalVerificarTarea" class="modal">
        <div class="liquid-card rounded-2xl p-6 m-4 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Verificar Tarea</h3>
                <button class="text-gray-400 hover:text-white text-2xl" onclick="cerrarModal('modalVerificarTarea')">&times;</button>
            </div>
            <form id="formVerificarTarea" method="POST">
                <input type="hidden" name="accion" value="verificar_tarea">
                <input type="hidden" name="tarea_id" id="tarea_id_verificar">
                <input type="hidden" name="tab_actual" value="<?php echo $tab_actual; ?>">
                <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                
                <div class="mb-6">
                    <label class="block text-gray-300 text-sm font-medium mb-2">CalificaciÃ³n</label>
                    <div class="flex gap-1 mb-2" id="rating-stars">
                        <span class="rating-star active" data-value="1">â˜…</span>
                        <span class="rating-star active" data-value="2">â˜…</span>
                        <span class="rating-star active" data-value="3">â˜…</span>
                        <span class="rating-star active" data-value="4">â˜…</span>
                        <span class="rating-star active" data-value="5">â˜…</span>
                    </div>
                    <input type="hidden" name="calificacion" id="calificacion" value="5" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-300 text-sm font-medium mb-2">Comentario</label>
                    <textarea name="comentario" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" rows="4" placeholder="Comentarios sobre la tarea completada..."></textarea>
                </div>
                
                <div class="flex gap-2 flex-wrap">
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center">
                        <i class="fas fa-check-double mr-2"></i> Verificar Tarea
                    </button>
                    <button type="button" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200 flex items-center" onclick="cerrarModal('modalVerificarTarea')">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para ver detalles de tarea -->
    <div id="modalDetallesTarea" class="modal">
        <div class="liquid-card rounded-2xl p-6 m-4 max-w-2xl w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Detalles de la Tarea</h3>
                <button class="text-gray-400 hover:text-white text-2xl" onclick="cerrarModal('modalDetallesTarea')">&times;</button>
            </div>
            <div id="detalles-tarea-content" class="max-h-96 overflow-y-auto">
                <!-- Los detalles se cargarÃ¡n aquÃ­ -->
            </div>
        </div>
    </div>

    <!-- Modal para editar usuario -->
    <div id="modalEditarUsuario" class="modal">
        <div class="liquid-card rounded-2xl p-6 m-4 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Editar Usuario</h3>
                <button class="text-gray-400 hover:text-white text-2xl" onclick="cerrarModal('modalEditarUsuario')">&times;</button>
            </div>
            <form id="formEditarUsuario" method="POST">
                <input type="hidden" name="accion" value="editar_usuario">
                <input type="hidden" name="user_id" id="user_id_editar">
                <input type="hidden" name="tab_actual" value="gestion-usuarios">
                <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Nombre Completo</label>
                        <input type="text" name="nombre" id="editar_nombre" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" required>
                    </div>
                    
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Rol</label>
                        <select name="rol" id="editar_rol" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" onchange="toggleCamposEdicion()">
                            <option value="empleado">Empleado</option>
                            <option value="admin">Administrador</option>
                            <option value="admin_pro">Administrador Pro</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">ID de Telegram</label>
                        <input type="text" name="telegram_id" id="editar_telegram_id" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200">
                    </div>
                    
                    <div class="campos-edicion">
                        <label class="block text-gray-300 text-sm font-medium mb-2">Turno</label>
                        <select name="turno" id="editar_turno" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200">
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                        </select>
                    </div>
                    
                    <div class="campos-edicion">
                        <label class="block text-gray-300 text-sm font-medium mb-2">Pasillo Asignado</label>
                        <input type="text" name="pasillo" id="editar_pasillo" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200">
                    </div>
                    
                    <div class="campos-edicion">
                        <label class="block text-gray-300 text-sm font-medium mb-2">DÃ­a Libre</label>
                        <select name="dia_libre" id="editar_dia_libre" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200">
                            <option value="">Seleccionar</option>
                            <option value="Lunes">Lunes</option>
                            <option value="Martes">Martes</option>
                            <option value="MiÃ©rcoles">MiÃ©rcoles</option>
                            <option value="Jueves">Jueves</option>
                            <option value="Viernes">Viernes</option>
                            <option value="SÃ¡bado">SÃ¡bado</option>
                            <option value="Domingo">Domingo</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex gap-2 mt-6 flex-wrap">
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center">
                        <i class="fas fa-save mr-2"></i> Guardar Cambios
                    </button>
                    <button type="button" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200 flex items-center" onclick="cerrarModal('modalEditarUsuario')">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para editar tarea -->
    <div id="modalEditarTarea" class="modal">
        <div class="liquid-card rounded-2xl p-6 m-4 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Editar Tarea</h3>
                <button class="text-gray-400 hover:text-white text-2xl" onclick="cerrarModal('modalEditarTarea')">&times;</button>
            </div>
            <form id="formEditarTarea" method="POST">
                <input type="hidden" name="accion" value="editar_tarea">
                <input type="hidden" name="tarea_id" id="editar_tarea_id">
                <input type="hidden" name="tab_actual" value="ver-tareas">
                <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">TÃ­tulo</label>
                        <input type="text" name="titulo" id="editar_titulo" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" required>
                    </div>
                    
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">DescripciÃ³n</label>
                        <textarea name="descripcion" id="editar_descripcion" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" rows="4" required></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Empleado</label>
                        <select name="empleado_id" id="editar_empleado_id" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" required>
                            <option value="">Seleccionar empleado</option>
                            <?php 
                            $empleados_activos = $pdo->query("SELECT * FROM usuarios WHERE activo = TRUE AND rol = 'empleado' ORDER BY nombre")->fetchAll();
                            foreach ($empleados_activos as $emp): 
                            ?>
                                <option value="<?php echo $emp['id']; ?>"><?php echo htmlspecialchars($emp['nombre']); ?> - <?php echo $emp['turno']; ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Fecha de Vencimiento</label>
                        <input type="datetime-local" name="fecha_vencimiento" id="editar_fecha_vencimiento" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200">
                    </div>
                    
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="requiere_foto" id="editar_requiere_foto" class="mr-2 w-4 h-4 text-blue-600 bg-gray-800 border-gray-700 rounded focus:ring-blue-500 focus:ring-2">
                            <span class="text-gray-300">Requerir foto de evidencia</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex gap-2 mt-6 flex-wrap">
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center">
                        <i class="fas fa-save mr-2"></i> Guardar Cambios
                    </button>
                    <button type="button" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200 flex items-center" onclick="cerrarModal('modalEditarTarea')">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para editar comando de Telegram -->
    <div id="modalEditarComando" class="modal">
        <div class="liquid-card rounded-2xl p-6 m-4 max-w-2xl w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Editar Comando de Telegram</h3>
                <button class="text-gray-400 hover:text-white text-2xl" onclick="cerrarModal('modalEditarComando')">&times;</button>
            </div>
            <form id="formEditarComando">
                <input type="hidden" name="accion" value="editar_comando">
                <input type="hidden" name="comando_id" id="editar_comando_id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Comando</label>
                        <input type="text" name="comando" id="editar_comando" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" required>
                    </div>
                    
                    <div class="flex items-center">
                        <label class="flex items-center">
                            <input type="checkbox" name="activo" id="editar_comando_activo" class="mr-2 w-4 h-4 text-blue-600 bg-gray-800 border-gray-700 rounded focus:ring-blue-500 focus:ring-2">
                            <span class="text-gray-300">Comando activo</span>
                        </label>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-gray-300 text-sm font-medium mb-2">Respuesta</label>
                        <textarea name="respuesta" id="editar_comando_respuesta" class="w-full px-4 py-3 input-glass rounded-xl text-white focus:outline-none transition duration-200" rows="6" required></textarea>
                    </div>
                </div>
                
                <div class="flex gap-2 mt-6 flex-wrap">
                    <button type="button" onclick="guardarComandoEditado()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center">
                        <i class="fas fa-save mr-2"></i> Guardar Cambios
                    </button>
                    <button type="button" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200 flex items-center" onclick="cerrarModal('modalEditarComando')">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variables globales
        let currentTareaId = null;
        let fotosCapturadas = [];
        let stream = null;
        let currentFacingMode = 'environment';
        const maxFotos = <?php echo $max_fotos_tarea; ?>;
        
        // NavegaciÃ³n entre pestaÃ±as
        function mostrarTab(tabId) {
            // Ocultar todas las pestaÃ±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar la pestaÃ±a seleccionada
            document.getElementById(tabId).classList.add('active');
            
            // Actualizar tÃ­tulo de la pÃ¡gina
            const titulos = {
                'dashboard': 'Dashboard Principal',
                'gestion-usuarios': 'GestiÃ³n de Usuarios',
                'asignar-tareas': 'Asignar Tareas',
                'ver-tareas': 'Todas las Tareas',
                'montacarga': 'Montacarga',
                'mis-tareas': 'Mis Tareas',
                'mi-perfil': 'Mi Perfil',
                'configuracion': 'ConfiguraciÃ³n',
                'comandos-telegram': 'Comandos Telegram'
            };
            
            document.getElementById('page-title').textContent = titulos[tabId] || 'Dashboard Principal';
            
            // Actualizar estado activo en el menÃº
            document.querySelectorAll('.ios-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`a[onclick="mostrarTab('${tabId}')"]`).classList.add('active');
            
            // Cerrar menÃº en mÃ³vil
            cerrarMenuMovil();
            
            // Actualizar URL sin recargar la pÃ¡gina
            history.pushState(null, '', `?tab=${tabId}`);
            
            // Cargar comandos si es la pestaÃ±a de comandos
            if (tabId === 'comandos-telegram') {
                cargarComandosTelegram();
            }
        }
        
        // Toggle sidebar en mÃ³vil
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                // Abrir
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                overlay.classList.remove('opacity-0', 'pointer-events-none');
                overlay.classList.add('opacity-50', 'pointer-events-auto');
            } else {
                // Cerrar
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('-translate-x-full');
                overlay.classList.remove('opacity-50', 'pointer-events-auto');
                overlay.classList.add('opacity-0', 'pointer-events-none');
            }
        }
        
        // Cerrar menÃº en mÃ³vil
        function cerrarMenuMovil() {
            if (window.innerWidth <= 1024) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('-translate-x-full');
                overlay.classList.remove('opacity-50', 'pointer-events-auto');
                overlay.classList.add('opacity-0', 'pointer-events-none');
            }
        }
        
        // Completar tarea con cÃ¡mara
        function completarTareaConFoto(tareaId) {
            currentTareaId = tareaId;
            document.getElementById('modalCompletarTareaFoto').style.display = 'flex';
            iniciarCamara();
        }
        
        // Iniciar cÃ¡mara
        async function iniciarCamara() {
            try {
                // Detener stream anterior si existe
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // Solicitar acceso a la cÃ¡mara
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                // Reiniciar fotos capturadas
                fotosCapturadas = [];
                actualizarVistaFotos();
                
            } catch (error) {
                console.error('Error al acceder a la cÃ¡mara:', error);
                alert('No se pudo acceder a la cÃ¡mara. AsegÃºrate de permitir el acceso a la cÃ¡mara.');
            }
        }
        
        // Capturar foto
        function capturarFoto() {
            if (fotosCapturadas.length >= maxFotos) {
                alert(`Solo puedes tomar un mÃ¡ximo de ${maxFotos} fotos.`);
                return;
            }
            
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // Configurar canvas con las dimensiones del video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Dibujar el frame actual del video en el canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convertir a base64
            const fotoData = canvas.toDataURL('image/jpeg', 0.8);
            fotosCapturadas.push(fotoData);
            
            actualizarVistaFotos();
        }
        
        // Actualizar vista de fotos capturadas
        function actualizarVistaFotos() {
            const container = document.getElementById('captured-photos');
            const btnCompletar = document.getElementById('btnCompletar');
            
            container.innerHTML = '';
            
            fotosCapturadas.forEach((foto, index) => {
                const fotoDiv = document.createElement('div');
                fotoDiv.className = 'relative';
                fotoDiv.innerHTML = `
                    <img src="${foto}" alt="Foto ${index + 1}" class="captured-photo">
                    <div class="photo-counter">${index + 1}</div>
                    <button onclick="eliminarFoto(${index})" class="absolute top-0 left-0 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                        Ã—
                    </button>
                `;
                container.appendChild(fotoDiv);
            });
            
            // Habilitar/deshabilitar botÃ³n de completar
            btnCompletar.disabled = fotosCapturadas.length === 0;
        }
        
        // Eliminar foto
        function eliminarFoto(index) {
            fotosCapturadas.splice(index, 1);
            actualizarVistaFotos();
        }
        
        // Cambiar cÃ¡mara
        function cambiarCamara() {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            iniciarCamara();
        }
        
        // Completar tarea con fotos
        async function completarTareaConFotos() {
            if (fotosCapturadas.length === 0) {
                alert('Debes tomar al menos una foto para completar la tarea.');
                return;
            }
            
            const btnCompletar = document.getElementById('btnCompletar');
            btnCompletar.disabled = true;
            btnCompletar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Procesando...';
            
            try {
                const response = await fetch('completar_tarea_foto.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `tarea_id=${currentTareaId}&fotos=${JSON.stringify(fotosCapturadas)}`
                });
                
                const resultado = await response.json();
                
                if (resultado.success) {
                    alert(resultado.message);
                    cerrarModal('modalCompletarTareaFoto');
                    location.reload(); // Recargar para actualizar el estado
                } else {
                    alert('Error: ' . resultado.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al completar la tarea');
            } finally {
                btnCompletar.disabled = false;
                btnCompletar.innerHTML = '<i class="fas fa-check mr-2"></i> Completar Tarea';
            }
        }
        
        // Ver fotos de tarea
        async function verFotosTarea(tareaId) {
            try {
                const response = await fetch(`obtener_fotos_tarea.php?tarea_id=${tareaId}`);
                const data = await response.json();
                
                if (data.success) {
                    const fotosContainer = document.getElementById('fotos-tarea-content');
                    fotosContainer.innerHTML = '';
                    
                    data.fotos.forEach(foto => {
                        const fotoDiv = document.createElement('div');
                        fotoDiv.className = 'text-center';
                        fotoDiv.innerHTML = `
                            <img src="${foto.ruta_foto}" alt="Foto de tarea" class="w-full h-48 object-cover rounded-lg mb-2">
                            <p class="text-gray-300 text-sm">${foto.nombre_archivo}</p>
                            <p class="text-gray-400 text-xs">${new Date(foto.fecha_subida).toLocaleString()}</p>
                        `;
                        fotosContainer.appendChild(fotoDiv);
                    });
                    
                    document.getElementById('modalFotosTarea').style.display = 'flex';
                } else {
                    alert('Error al cargar fotos: ' + data.error);
                }
            } catch (error) {
                alert('Error al cargar fotos de la tarea');
                console.error('Error:', error);
            }
        }
        
        // Verificar tarea
        function verificarTarea(tareaId) {
            document.getElementById('tarea_id_verificar').value = tareaId;
            document.getElementById('modalVerificarTarea').style.display = 'flex';
        }
        
        // Ver detalles de tarea
        async function verDetallesTarea(tareaId) {
            try {
                const response = await fetch(`obtener_detalles_tarea.php?id=${tareaId}`);
                const detalles = await response.text();
                document.getElementById('detalles-tarea-content').innerHTML = detalles;
                document.getElementById('modalDetallesTarea').style.display = 'flex';
            } catch (error) {
                alert('Error al cargar detalles de la tarea');
                console.error('Error:', error);
            }
        }
        
        // Editar usuario
        async function editarUsuario(userId) {
            try {
                const response = await fetch(`obtener_datos_usuario.php?id=${userId}`);
                const usuario = await response.json();
                
                if (usuario.error) {
                    alert(usuario.error);
                    return;
                }
                
                document.getElementById('user_id_editar').value = usuario.id;
                document.getElementById('editar_nombre').value = usuario.nombre;
                document.getElementById('editar_rol').value = usuario.rol;
                document.getElementById('editar_telegram_id').value = usuario.telegram_id || '';
                document.getElementById('editar_turno').value = usuario.turno || 'AM';
                document.getElementById('editar_pasillo').value = usuario.pasillo_asignado || '';
                document.getElementById('editar_dia_libre').value = usuario.dia_libre || '';
                
                // Mostrar/ocultar campos segÃºn el rol
                toggleCamposEdicion();
                
                document.getElementById('modalEditarUsuario').style.display = 'flex';
            } catch (error) {
                alert('Error al cargar datos del usuario');
                console.error('Error:', error);
            }
        }
        
        // Editar tarea
        async function editarTarea(tareaId) {
            try {
                const response = await fetch(`obtener_datos_tarea.php?id=${tareaId}`);
                const tarea = await response.json();
                
                if (tarea.error) {
                    alert(tarea.error);
                    return;
                }
                
                document.getElementById('editar_tarea_id').value = tarea.id;
                document.getElementById('editar_titulo').value = tarea.titulo;
                document.getElementById('editar_descripcion').value = tarea.descripcion;
                document.getElementById('editar_empleado_id').value = tarea.empleado_id;
                document.getElementById('editar_fecha_vencimiento').value = tarea.fecha_vencimiento_form;
                document.getElementById('editar_requiere_foto').checked = tarea.requiere_foto == 1;
                
                document.getElementById('modalEditarTarea').style.display = 'flex';
            } catch (error) {
                alert('Error al cargar datos de la tarea');
                console.error('Error:', error);
            }
        }
        
        // Eliminar usuario
        function eliminarUsuario(userId) {
            if (confirm('Â¿EstÃ¡ seguro de que desea eliminar este usuario? Esta acciÃ³n no se puede deshacer.')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.innerHTML = `
                    <input type="hidden" name="accion" value="eliminar_usuario">
                    <input type="hidden" name="user_id" value="${userId}">
                    <input type="hidden" name="tab_actual" value="gestion-usuarios">
                    <input type="hidden" name="form_token" value="<?php echo $_SESSION['form_token']; ?>">
                `;
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        // Descargar backup
        async function descargarBackup(nombreArchivo) {
            try {
                window.open(`descargar_backup.php?file=${encodeURIComponent(nombreArchivo)}`, '_blank');
                cerrarModal('modalBackup');
            } catch (error) {
                alert('Error al procesar la descarga');
                console.error('Error:', error);
            }
        }
        
        // Subir backup
        async function subirBackup() {
            const formData = new FormData(document.getElementById('formSubirBackup'));
            
            try {
                const response = await fetch('subir_backup.php', {
                    method: 'POST',
                    body: formData
                });
                
                const resultado = await response.json();
                
                if (resultado.success) {
                    alert(resultado.message);
                    location.reload();
                } else {
                    alert('Error: ' + resultado.error);
                }
            } catch (error) {
                alert('Error al subir el backup');
                console.error('Error:', error);
            }
        }
        
        // Mostrar instrucciones de montacarga
        function mostrarInstruccionesMontacarga() {
            alert('INSTRUCCIONES MONTACARGA:\n\n' +
                  'POSICIÃ“N SUPERIOR (ARRIBA):\n' +
                  '- Quedarse en la posiciÃ³n superior del montacarga\n' +
                  '- Enviar patanas a los compaÃ±eros del almacÃ©n\n' +
                  '- Coordinar el movimiento del montacarga\n\n' +
                  'POSICIÃ“N INFERIOR (ALMACÃ‰N):\n' +
                  '- Trabajar en el almacÃ©n para recibir patanas\n' +
                  '- Organizar y distribuir las patanas recibidas\n' +
                  '- Comunicarse con los compaÃ±eros del montacarga');
        }
        
        // Cerrar modal
        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // Detener cÃ¡mara si estÃ¡ activa
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Limpiar fotos capturadas
            fotosCapturadas = [];
        }
        
        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target === modal) {
                    cerrarModal(modal.id);
                }
            });
        }
        
        // AnimaciÃ³n de estadÃ­sticas al cargar
        function animateStats() {
            const stats = document.querySelectorAll('.liquid-card .text-4xl');
            stats.forEach(stat => {
                const finalValue = parseInt(stat.textContent);
                let currentValue = 0;
                const duration = 1500;
                const increment = finalValue / (duration / 16);
                
                const timer = setInterval(() => {
                    currentValue += increment;
                    if (currentValue >= finalValue) {
                        stat.textContent = finalValue.toLocaleString();
                        clearInterval(timer);
                    } else {
                        stat.textContent = Math.floor(currentValue).toLocaleString();
                    }
                }, 16);
            });
        }
        
        // Sistema de calificaciÃ³n con estrellas
        function initRatingStars() {
            const stars = document.querySelectorAll('.rating-star');
            const ratingInput = document.getElementById('calificacion');
            
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    ratingInput.value = value;
                    
                    stars.forEach(s => {
                        if (s.getAttribute('data-value') <= value) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });
        }
        
        // Toggle campos de empleado al crear usuario
        function toggleCamposEmpleado() {
            const rol = document.querySelector('select[name="rol"]').value;
            const campos = document.querySelectorAll('.campos-empleado');
            
            campos.forEach(campo => {
                campo.style.display = rol === 'empleado' ? 'block' : 'none';
            });
        }
        
        // Toggle campos de empleado al editar usuario
        function toggleCamposEdicion() {
            const rol = document.getElementById('editar_rol').value;
            const campos = document.querySelectorAll('.campos-edicion');
            
            campos.forEach(campo => {
                campo.style.display = rol === 'empleado' ? 'block' : 'none';
            });
        }
        
        // Filtrar tareas por estado
        function filtrarTareas(estado) {
            const categorias = document.querySelectorAll('.categoria-tareas');
            categorias.forEach(categoria => {
                if (estado === 'todas') {
                    categoria.style.display = 'block';
                } else {
                    const header = categoria.querySelector('.categoria-header h3');
                    if (header.textContent.toLowerCase().includes(estado)) {
                        categoria.style.display = 'block';
                    } else {
                        categoria.style.display = 'none';
                    }
                }
            });
        }
        
        // Filtrar mis tareas por estado
        function filtrarMisTareas(estado) {
            const categorias = document.querySelectorAll('.categoria-tareas');
            categorias.forEach(categoria => {
                if (estado === 'todas') {
                    categoria.style.display = 'block';
                } else {
                    const header = categoria.querySelector('.categoria-header h3');
                    if (header.textContent.toLowerCase().includes(estado)) {
                        categoria.style.display = 'block';
                    } else {
                        categoria.style.display = 'none';
                    }
                }
            });
        }
        
        // Cargar comandos de Telegram
        async function cargarComandosTelegram() {
            try {
                const response = await fetch('obtener_comandos_telegram.php');
                const data = await response.json();
                
                if (data.success) {
                    const lista = document.getElementById('lista-comandos');
                    lista.innerHTML = '';
                    
                    data.comandos.forEach(comando => {
                        const comandoDiv = document.createElement('div');
                        comandoDiv.className = 'liquid-glass p-4 rounded-xl';
                        comandoDiv.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="font-bold text-white text-lg">${comando.comando}</h4>
                                    <span class="text-xs px-2 py-1 rounded-full ${comando.activo ? 'bg-green-500 text-white' : 'bg-gray-500 text-white'}">
                                        ${comando.activo ? 'Activo' : 'Inactivo'}
                                    </span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editarComando(${comando.id})" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition duration-200 flex items-center">
                                        <i class="fas fa-edit mr-1"></i> Editar
                                    </button>
                                    <button onclick="eliminarComando(${comando.id})" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition duration-200 flex items-center">

<i class="fas fa-trash mr-1"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                            <div class="text-gray-300 text-sm">
                                <strong>Respuesta:</strong><br>
                                <div class="mt-1 p-2 bg-gray-800 rounded text-xs overflow-x-auto">${comando.respuesta.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                            </div>
                        `;
                        lista.appendChild(comandoDiv);
                    });
                } else {
                    alert('Error al cargar comandos: ' + data.error);
                }
            } catch (error) {
                alert('Error al cargar comandos de Telegram');
                console.error('Error:', error);
            }
        }

        // Crear comando de Telegram
        async function crearComando() {
            const form = document.getElementById('formCrearComando');
            const formData = new FormData(form);
            
            try {
                const response = await fetch('gestionar_comandos_telegram.php', {
                    method: 'POST',
                    body: formData
                });
                
                const resultado = await response.json();
                
                if (resultado.success) {
                    alert(resultado.message);
                    form.reset();
                    cargarComandosTelegram();
                } else {
                    alert('Error: ' + resultado.error);
                }
            } catch (error) {
                alert('Error al crear el comando');
                console.error('Error:', error);
            }
        }

        // Editar comando de Telegram
        async function editarComando(comandoId) {
            try {
                const response = await fetch('obtener_comandos_telegram.php');
                const data = await response.json();
                
                if (data.success) {
                    const comando = data.comandos.find(c => c.id == comandoId);
                    
                    if (comando) {
                        document.getElementById('editar_comando_id').value = comando.id;
                        document.getElementById('editar_comando').value = comando.comando;
                        document.getElementById('editar_comando_respuesta').value = comando.respuesta;
                        document.getElementById('editar_comando_activo').checked = comando.activo;
                        
                        document.getElementById('modalEditarComando').style.display = 'flex';
                    }
                }
            } catch (error) {
                alert('Error al cargar datos del comando');
                console.error('Error:', error);
            }
        }

        // Guardar comando editado
        async function guardarComandoEditado() {
            const form = document.getElementById('formEditarComando');
            const formData = new FormData(form);
            
            try {
                const response = await fetch('gestionar_comandos_telegram.php', {
                    method: 'POST',
                    body: formData
                });
                
                const resultado = await response.json();
                
                if (resultado.success) {
                    alert(resultado.message);
                    cerrarModal('modalEditarComando');
                    cargarComandosTelegram();
                } else {
                    alert('Error: ' + resultado.error);
                }
            } catch (error) {
                alert('Error al guardar el comando');
                console.error('Error:', error);
            }
        }

        // Eliminar comando de Telegram
        async function eliminarComando(comandoId) {
            if (confirm('Â¿EstÃ¡ seguro de que desea eliminar este comando?')) {
                try {
                    const formData = new FormData();
                    formData.append('accion', 'eliminar_comando');
                    formData.append('comando_id', comandoId);
                    
                    const response = await fetch('gestionar_comandos_telegram.php', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const resultado = await response.json();
                    
                    if (resultado.success) {
                        alert(resultado.message);
                        cargarComandosTelegram();
                    } else {
                        alert('Error: ' + resultado.error);
                    }
                } catch (error) {
                    alert('Error al eliminar el comando');
                    console.error('Error:', error);
                }
            }
        }

        // InicializaciÃ³n cuando se carga la pÃ¡gina
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar componentes
            toggleCamposEmpleado();
            initRatingStars();
            animateStats();
            
            // Configurar eventos de la cÃ¡mara
            document.getElementById('btnCapturar').addEventListener('click', capturarFoto);
            document.getElementById('btnCambiarCamara').addEventListener('click', cambiarCamara);
            document.getElementById('btnCompletar').addEventListener('click', completarTareaConFotos);
            
            // Verificar si hay una pestaÃ±a especÃ­fica en la URL
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');
            if (tabParam && document.getElementById(tabParam)) {
                mostrarTab(tabParam);
            }
            
            // Cargar comandos si estamos en esa pestaÃ±a
            if (tabParam === 'comandos-telegram') {
                cargarComandosTelegram();
            }
        });

        // Manejar navegaciÃ³n hacia atrÃ¡s/adelante
        window.addEventListener('popstate', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');
            if (tabParam && document.getElementById(tabParam)) {
                mostrarTab(tabParam);
            }
        });
    </script>
</body>
</html>
EOF

# Crear archivo de configuraciÃ³n de Apache
cat > /etc/apache2/sites-available/gestion-empleados.conf << EOF
<VirtualHost *:80>
    ServerName $DOMAIN
    DocumentRoot $PANEL_DIR

    <Directory $PANEL_DIR>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog \${APACHE_LOG_DIR}/gestion_empleados_error.log
    CustomLog \${APACHE_LOG_DIR}/gestion_empleados_access.log combined
</VirtualHost>
EOF

# Habilitar sitio y mÃ³dulos de Apache
print_message "Configurando Apache..."
a2ensite gestion-empleados.conf
a2dissite 000-default.conf
a2enmod rewrite

# Configurar permisos
print_message "Configurando permisos..."
chown -R www-data:www-data $PANEL_DIR
chmod -R 755 $PANEL_DIR
chmod -R 755 /var/www/uploads/
chmod -R 755 /var/www/backups/

# Crear directorios necesarios
mkdir -p /var/www/uploads/tareas
mkdir -p /var/www/backups
chown -R www-data:www-data /var/www/uploads
chown -R www-data:www-data /var/www/backups

# Configurar cron para tareas automÃ¡ticas
print_message "Configurando tareas automÃ¡ticas..."
(crontab -l 2>/dev/null; echo "*/5 * * * * /usr/bin/php $PANEL_DIR/tareas_automaticas.php > /dev/null 2>&1") | crontab -
(crontab -l 2>/dev/null; echo "0 2 * * * /usr/bin/php $PANEL_DIR/backup_automatico.php > /dev/null 2>&1") | crontab -

# Configurar Telegram si se proporcionaron datos
if [ ! -z "$TELEGRAM_TOKEN" ] && [ ! -z "$TELEGRAM_CHAT_ID" ]; then
    print_message "Configurando Telegram..."
    mysql -e "UPDATE configuraciones SET valor = '$TELEGRAM_TOKEN' WHERE clave = 'telegram_token';" gestion_empleados
    mysql -e "UPDATE configuraciones SET valor = '$TELEGRAM_CHAT_ID' WHERE clave = 'telegram_chat_id';" gestion_empleados
    mysql -e "UPDATE configuraciones SET valor = '$DOMAIN' WHERE clave = 'dominio';" gestion_empleados
fi

# Configurar usuario administrador
print_message "Configurando usuario administrador..."
ADMIN_PASS_HASH=$(php -r "echo password_hash('$ADMIN_PASS', PASSWORD_DEFAULT);")
mysql -e "UPDATE usuarios SET password = '$ADMIN_PASS_HASH', nombre = '$ADMIN_USER' WHERE username = 'admin';" gestion_empleados

# Reiniciar servicios
print_message "Reiniciando servicios..."
systemctl restart apache2
systemctl restart mysql

# Configurar firewall
print_message "Configurando firewall..."
ufw allow 80
ufw allow 22

# Mostrar resumen de la instalaciÃ³n
print_success "InstalaciÃ³n completada exitosamente!"
print_info "================================================"
print_info "URL del sistema: http://$DOMAIN"
print_info "Usuario administrador: admin"
print_info "ContraseÃ±a: [la que configurÃ³]"
print_info "Directorio del panel: $PANEL_DIR"
print_info "Base de datos: gestion_empleados"
print_info "Usuario BD: gestion_user"
print_info "================================================"

if [ ! -z "$TELEGRAM_TOKEN" ] && [ ! -z "$TELEGRAM_CHAT_ID" ]; then
    print_info "Telegram configurado correctamente"
    print_info "Token: $TELEGRAM_TOKEN"
    print_info "Chat ID: $TELEGRAM_CHAT_ID"
else
    print_warning "Telegram no configurado. Puede configurarlo luego en el panel."
fi

print_info "Tareas automÃ¡ticas configuradas cada 5 minutos"
print_info "Backup automÃ¡tico configurado a las 2:00 AM"
print_info "================================================"
print_success "Â¡Sistema de GestiÃ³n de Empleados v2.0.0 instalado correctamente!"